<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Dashboard</title>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #10b981;
            --primary-dark: #059669;
            --secondary: #3b82f6;
            --bg-dark: #1e293b;
            --bg-darker: #0f172a;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-darker);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .sidebar-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        .sidebar-brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary);
        }
        
        .sidebar-user {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .sidebar-user span {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 15px 0;
            overflow-y: auto;
        }
        
        .nav-section {
            padding: 0 15px;
            margin-bottom: 20px;
        }
        
        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 10px 10px 5px;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
            margin-bottom: 2px;
        }
        
        .nav-item:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 20px;
        }
        
        /* Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Estação Selector */
        .estacao-selector {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .estacao-select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            min-width: 300px;
            font-size: 14px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Map Container */
        .map-container {
            background: var(--bg-card);
            border-radius: 12px;
            overflow: hidden;
            height: 400px;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        /* Weather Widget */
        .weather-widget {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-dark));
            border-radius: 12px;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        
        .weather-widget-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .weather-location {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .weather-wind {
            text-align: right;
        }
        
        .weather-wind-speed {
            font-size: 20px;
            font-weight: 600;
        }
        
        .weather-wind-direction {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .weather-main {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .weather-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        .weather-condition {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .weather-temp {
            font-size: 64px;
            font-weight: 300;
            line-height: 1;
        }
        
        .weather-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 15px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .weather-stat {
            text-align: center;
        }
        
        .weather-stat-icon {
            font-size: 16px;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .weather-stat-value {
            font-size: 14px;
            font-weight: 600;
        }
        
        .weather-stat-label {
            font-size: 11px;
            color: var(--text-secondary);
        }
        
        .weather-extremes {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 15px 0;
        }
        
        .weather-extreme {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .weather-extreme-icon {
            font-size: 14px;
        }
        
        .weather-extreme-icon.down { color: var(--info); }
        .weather-extreme-icon.up { color: var(--danger); }
        
        .weather-updated {
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 10px;
        }
        
        /* Wind Rose */
        .wind-rose-container {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background: var(--bg-darker);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        .wind-rose {
            width: 100px;
            height: 100px;
            position: relative;
        }
        
        .wind-rose-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid var(--border);
        }
        
        .wind-rose-arrow {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 40px;
            background: var(--primary);
            transform-origin: bottom center;
            border-radius: 2px;
            margin-left: -2px;
            margin-top: -40px;
        }
        
        .wind-rose-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        
        .wind-rose-labels {
            position: absolute;
            width: 100%;
            height: 100%;
            font-size: 10px;
            color: var(--text-secondary);
        }
        
        .wind-rose-labels span {
            position: absolute;
        }
        
        .wind-rose-labels .n { top: 2px; left: 50%; transform: translateX(-50%); }
        .wind-rose-labels .s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .wind-rose-labels .e { right: 2px; top: 50%; transform: translateY(-50%); }
        .wind-rose-labels .w { left: 2px; top: 50%; transform: translateY(-50%); }
        
        /* Previsão do Tempo */
        .forecast-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .forecast-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .forecast-grid {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .forecast-day {
            flex: 0 0 100px;
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 15px 10px;
            text-align: center;
        }
        
        .forecast-date {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .forecast-day-name {
            font-size: 13px;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .forecast-icon {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .forecast-temps {
            display: flex;
            justify-content: center;
            gap: 10px;
            font-size: 13px;
        }
        
        .forecast-temp-max { color: var(--danger); }
        .forecast-temp-min { color: var(--info); }
        
        .forecast-rain {
            font-size: 11px;
            color: var(--info);
            margin-top: 8px;
        }
        
        /* Histórico Climático */
        .history-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .history-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .date-input {
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
        }
        
        .chart-container {
            height: 300px;
            margin-bottom: 20px;
        }
        
        /* Summary Cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .summary-card {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 15px;
        }
        
        .summary-card-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }
        
        .summary-card-value {
            font-size: 24px;
            font-weight: 600;
        }
        
        .summary-card-compare {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .summary-card-compare.positive { color: var(--success); }
        .summary-card-compare.negative { color: var(--danger); }
        
        /* Login Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-overlay.hidden {
            display: none;
        }
        
        .modal {
            background: var(--bg-dark);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border: 1px solid var(--border);
        }
        
        .modal-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .modal-logo i {
            font-size: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .modal-logo h1 {
            font-size: 28px;
            font-weight: 700;
            margin-top: 10px;
            color: var(--primary);
        }
        
        .modal-logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            z-index: 2000;
            animation: slideIn 0.3s ease;
        }
        
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }
        
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 101;
            background: var(--primary);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-logo">
                <i class="fas fa-cloud-sun-rain"></i>
                <h1>Aguaten</h1>
                <p>Sistema de Monitoramento Meteorológico</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i>
                    Entrar
                </button>
            </form>
        </div>
    </div>
    
    <!-- App Container -->
    <div class="app-container" id="appContainer" style="display: none;">
        <!-- Mobile Menu Button -->
        <button class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-cloud-sun-rain"></i>
                </div>
                <span class="sidebar-brand">Aguaten</span>
            </div>
            
            <div class="sidebar-user">
                Olá, <span id="userName">Usuário</span>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="index.html" class="nav-item active">
                        <i class="fas fa-chart-line"></i>
                        Dashboard
                    </a>
                    <a href="estacoes.html" class="nav-item">
                        <i class="fas fa-broadcast-tower"></i>
                        Minhas Estações
                    </a>
                    <a href="relatorios.html" class="nav-item">
                        <i class="fas fa-file-alt"></i>
                        Relatórios
                    </a>
                </div>
                
                <div class="nav-section" id="modulosSection" style="display: none;">
                    <div class="nav-section-title">Módulos</div>
                    <a href="agrometeorologia.html" class="nav-item">
                        <i class="fas fa-seedling"></i>
                        Agrometeorologia
                    </a>
                </div>
                
                <div class="nav-section" id="adminSection" style="display: none;">
                    <div class="nav-section-title">Administrativo</div>
                    <a href="admin.html" class="nav-item">
                        <i class="fas fa-users-cog"></i>
                        Usuários
                    </a>
                    <a href="admin.html#estacoes" class="nav-item">
                        <i class="fas fa-satellite-dish"></i>
                        Estações
                    </a>
                    <a href="admin.html#culturas" class="nav-item">
                        <i class="fas fa-leaf"></i>
                        Culturas
                    </a>
                    <a href="admin.html#logs" class="nav-item">
                        <i class="fas fa-list"></i>
                        Logs
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Conta</div>
                    <a href="conta.html" class="nav-item">
                        <i class="fas fa-user"></i>
                        Minha Conta
                    </a>
                </div>
                
                <div class="nav-section">
                    <div class="nav-section-title">Outros</div>
                    <a href="#" class="nav-item" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Sair
                    </a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="estacao-selector">
                    <select class="estacao-select" id="estacaoSelect">
                        <option value="">Selecione uma estação...</option>
                    </select>
                    <button class="btn btn-primary" onclick="consultarEstacao()">
                        <i class="fas fa-search"></i>
                        Consultar
                    </button>
                </div>
            </div>
            
            <!-- Dashboard Grid -->
            <div class="dashboard-grid">
                <!-- Map -->
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <!-- Weather Widget -->
                <div class="weather-widget" id="weatherWidget">
                    <div class="weather-widget-header">
                        <div class="weather-location" id="weatherLocation">
                            Selecione uma estação
                        </div>
                        <div class="weather-wind">
                            <div class="weather-wind-speed" id="windSpeed">-- Km/h</div>
                            <div class="weather-wind-direction" id="windDirection">--</div>
                        </div>
                    </div>
                    
                    <div class="weather-main">
                        <div class="weather-icon" id="weatherIcon">
                            <i class="fas fa-cloud-sun"></i>
                        </div>
                        <div class="weather-condition" id="weatherCondition">--</div>
                        <div class="weather-temp"><span id="currentTemp">--</span>°C</div>
                    </div>
                    
                    <div class="weather-stats">
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-wind"></i></div>
                            <div class="weather-stat-value" id="statWind">-- Km/h</div>
                            <div class="weather-stat-label">Vento</div>
                        </div>
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-tint"></i></div>
                            <div class="weather-stat-value" id="statHumidity">--%</div>
                            <div class="weather-stat-label">Umidade</div>
                        </div>
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-cloud-rain"></i></div>
                            <div class="weather-stat-value" id="statRain">-- mm</div>
                            <div class="weather-stat-label">Precipitação</div>
                        </div>
                    </div>
                    
                    <div class="weather-extremes">
                        <div class="weather-extreme">
                            <i class="fas fa-arrow-down weather-extreme-icon down"></i>
                            <span id="tempMin">--°C</span>
                        </div>
                        <div class="weather-extreme">
                            <i class="fas fa-arrow-up weather-extreme-icon up"></i>
                            <span id="tempMax">--°C</span>
                        </div>
                    </div>
                    
                    <div class="wind-rose-container">
                        <div class="wind-rose">
                            <div class="wind-rose-bg"></div>
                            <div class="wind-rose-arrow" id="windArrow"></div>
                            <div class="wind-rose-center"></div>
                            <div class="wind-rose-labels">
                                <span class="n">N</span>
                                <span class="s">S</span>
                                <span class="e">E</span>
                                <span class="w">O</span>
                            </div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Direção do Vento</div>
                            <div style="font-size: 18px; font-weight: 600;" id="windDirLabel">--</div>
                        </div>
                    </div>
                    
                    <div class="weather-updated" id="weatherUpdated">
                        <i class="fas fa-sync-alt"></i> Atualizado às: --
                    </div>
                </div>
            </div>
            
            <!-- Previsão do Tempo -->
            <div class="forecast-section">
                <h3 class="forecast-title">Previsão do Tempo</h3>
                <div class="forecast-grid" id="forecastGrid">
                    <!-- Forecast cards will be inserted here -->
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            
            <!-- Histórico Climático -->
            <div class="history-section">
                <div class="history-header">
                    <h3 class="forecast-title">Histórico Climático</h3>
                    <div class="history-filters">
                        <input type="date" class="date-input" id="dateStart">
                        <input type="date" class="date-input" id="dateEnd">
                        <button class="btn btn-primary" onclick="loadHistory()">
                            <i class="fas fa-search"></i>
                            Consultar
                        </button>
                    </div>
                </div>
                
                <div class="chart-container">
                    <canvas id="historyChart"></canvas>
                </div>
                
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-title">Precipitação Acumulada</div>
                        <div class="summary-card-value" id="summaryRain">-- mm</div>
                        <div class="summary-card-compare" id="summaryRainCompare">vs ano anterior: --</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Temperatura Média</div>
                        <div class="summary-card-value" id="summaryTemp">--°C</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Amplitude Térmica</div>
                        <div class="summary-card-value" id="summaryAmplitude">--°C</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Velocidade Média do Vento</div>
                        <div class="summary-card-value" id="summaryWind">-- Km/h</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // =============================================
        // CONFIGURAÇÃO SUPABASE
        // =============================================
        const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
        const SUPABASE_ANON_KEY = 'SUA_ANON_KEY';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // =============================================
        // ESTADO GLOBAL
        // =============================================
        let currentUser = null;
        let userProfile = null;
        let estacoes = [];
        let currentEstacao = null;
        let map = null;
        let markers = [];
        let historyChart = null;
        
        // =============================================
        // INICIALIZAÇÃO
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar sessão
            const { data: { session } } = await supabaseClient.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserProfile();
                showApp();
            } else {
                showLogin();
            }
            
            // Listener de mudança de auth
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    await loadUserProfile();
                    showApp();
                } else if (event === 'SIGNED_OUT') {
                    showLogin();
                }
            });
            
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Inicializar datas
            const today = new Date();
            const twoWeeksAgo = new Date(today.getTime() - 14 * 24 * 60 * 60 * 1000);
            document.getElementById('dateEnd').value = today.toISOString().split('T')[0];
            document.getElementById('dateStart').value = twoWeeksAgo.toISOString().split('T')[0];
        });
        
        // =============================================
        // AUTENTICAÇÃO
        // =============================================
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('appContainer').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('appContainer').style.display = 'flex';
            initializeApp();
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                showToast('Login realizado com sucesso!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
            }
        }
        
        async function logout() {
            await supabaseClient.auth.signOut();
            showLogin();
        }
        
        async function loadUserProfile() {
            const { data, error } = await supabaseClient
                .from('perfis')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (data) {
                userProfile = data;
                document.getElementById('userName').textContent = data.primeiro_nome || data.email.split('@')[0];
                
                // Mostrar seções de admin
                if (data.is_admin) {
                    document.getElementById('adminSection').style.display = 'block';
                }
                
                // Verificar módulos
                const { data: modulos } = await supabaseClient
                    .from('usuario_modulo')
                    .select('modulo_id, modulos(identificador)')
                    .eq('usuario_id', currentUser.id);
                
                if (modulos && modulos.some(m => m.modulos?.identificador === 'agrometeorologia')) {
                    document.getElementById('modulosSection').style.display = 'block';
                }
            }
        }
        
        // =============================================
        // INICIALIZAÇÃO DO APP
        // =============================================
        async function initializeApp() {
            // Inicializar mapa
            initMap();
            
            // Carregar estações
            await loadEstacoes();
            
            // Inicializar gráfico
            initHistoryChart();
        }
        
        function initMap() {
            map = L.map('map').setView([-25.4284, -54.5934], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap'
            }).addTo(map);
        }
        
        async function loadEstacoes() {
            const { data, error } = await supabaseClient
                .from('estacoes')
                .select('*')
                .eq('ativo', true);
            
            if (error) {
                showToast('Erro ao carregar estações', 'error');
                return;
            }
            
            estacoes = data || [];
            
            // Popular select
            const select = document.getElementById('estacaoSelect');
            select.innerHTML = '<option value="">Selecione uma estação...</option>';
            
            estacoes.forEach(est => {
                const option = document.createElement('option');
                option.value = est.id;
                option.textContent = `${est.identificador} - ${est.nome || est.cidade}`;
                select.appendChild(option);
            });
            
            // Adicionar marcadores no mapa
            addMarkersToMap();
            
            // Selecionar primeira estação se existir
            if (estacoes.length > 0) {
                select.value = estacoes[0].id;
                consultarEstacao();
            }
        }
        
        function addMarkersToMap() {
            // Limpar marcadores anteriores
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            estacoes.forEach(est => {
                if (est.latitude && est.longitude) {
                    const marker = L.marker([est.latitude, est.longitude])
                        .addTo(map)
                        .bindPopup(`
                            <strong>${est.nome || est.identificador}</strong><br>
                            ${est.cidade || ''}, ${est.estado_regiao || ''}<br>
                            <small>${est.provedor}</small>
                        `);
                    
                    marker.on('click', () => {
                        document.getElementById('estacaoSelect').value = est.id;
                        consultarEstacao();
                    });
                    
                    markers.push(marker);
                }
            });
            
            // Ajustar zoom para mostrar todos os marcadores
            if (markers.length > 0) {
                const group = L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // =============================================
        // CONSULTA DE ESTAÇÃO
        // =============================================
        async function consultarEstacao() {
            const estacaoId = document.getElementById('estacaoSelect').value;
            if (!estacaoId) return;
            
            currentEstacao = estacoes.find(e => e.id === estacaoId);
            if (!currentEstacao) return;
            
            // Atualizar widget
            updateWeatherWidget();
            
            // Carregar dados da API (Ecowitt, Wunderground, etc)
            await fetchEstacaoData();
            
            // Carregar previsão
            await loadForecast();
            
            // Carregar histórico
            await loadHistory();
        }
        
        function updateWeatherWidget() {
            document.getElementById('weatherLocation').textContent = 
                `${currentEstacao.nome || currentEstacao.identificador} - ${currentEstacao.cidade || ''}`;
        }
        
        async function fetchEstacaoData() {
            // Aqui você implementa a chamada para a API do provedor (Ecowitt, etc)
            // Por enquanto, vamos buscar os últimos dados do banco
            
            const { data, error } = await supabaseClient
                .from('estacao_dados')
                .select('*')
                .eq('estacao_id', currentEstacao.id)
                .order('coletado_em', { ascending: false })
                .limit(1);
            
            if (data && data.length > 0) {
                displayWeatherData(data[0]);
            } else {
                // Se não tem dados no banco, tenta o cache da estação
                if (currentEstacao.data_cache) {
                    displayWeatherData(currentEstacao.data_cache);
                }
            }
        }
        
        function displayWeatherData(data) {
            // Temperatura
            document.getElementById('currentTemp').textContent = 
                data.temperatura?.toFixed(1) || '--';
            
            // Extremos
            document.getElementById('tempMin').textContent = 
                `${data.temperatura_minima?.toFixed(1) || '--'}°C`;
            document.getElementById('tempMax').textContent = 
                `${data.temperatura_maxima?.toFixed(1) || '--'}°C`;
            
            // Vento
            document.getElementById('windSpeed').textContent = 
                `${data.velocidade_vento?.toFixed(1) || '--'} Km/h`;
            document.getElementById('statWind').textContent = 
                `${data.velocidade_vento?.toFixed(1) || '--'} Km/h`;
            
            const windDir = getWindDirection(data.direcao_vento);
            document.getElementById('windDirection').textContent = `Rajada: ${data.rajada_vento?.toFixed(1) || '--'} Km/h`;
            document.getElementById('windDirLabel').textContent = windDir;
            
            // Atualizar rosa dos ventos
            if (data.direcao_vento !== null) {
                document.getElementById('windArrow').style.transform = 
                    `rotate(${data.direcao_vento}deg)`;
            }
            
            // Umidade
            document.getElementById('statHumidity').textContent = 
                `${data.umidade?.toFixed(0) || '--'}%`;
            
            // Precipitação
            document.getElementById('statRain').textContent = 
                `${data.total_precipitacao?.toFixed(1) || '0'} mm/dia`;
            
            // Condição do tempo
            const condition = getWeatherCondition(data);
            document.getElementById('weatherCondition').textContent = condition.text;
            document.getElementById('weatherIcon').innerHTML = `<i class="fas ${condition.icon}"></i>`;
            
            // Horário de atualização
            const updateTime = data.coletado_em ? 
                new Date(data.coletado_em).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : 
                '--';
            document.getElementById('weatherUpdated').innerHTML = 
                `<i class="fas fa-sync-alt"></i> Atualizado às: ${updateTime}`;
        }
        
        function getWindDirection(degrees) {
            if (degrees === null || degrees === undefined) return '--';
            
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 
                               'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }
        
        function getWeatherCondition(data) {
            // Lógica simples para determinar condição
            if (data.taxa_precipitacao > 0) {
                return { text: 'Chuva', icon: 'fa-cloud-rain' };
            }
            if (data.umidade > 90) {
                return { text: 'Nublado', icon: 'fa-cloud' };
            }
            if (data.umidade > 70) {
                return { text: 'Parcialmente nublado', icon: 'fa-cloud-sun' };
            }
            return { text: 'Céu limpo', icon: 'fa-sun' };
        }
        
        // =============================================
        // PREVISÃO DO TEMPO
        // =============================================
        async function loadForecast() {
            const forecastGrid = document.getElementById('forecastGrid');
            
            // Buscar previsão do cache
            const { data, error } = await supabaseClient
                .from('cache_previsao_tempo')
                .select('*')
                .eq('estacao_id', currentEstacao.id)
                .gte('momento', new Date().toISOString().split('T')[0])
                .order('momento', { ascending: true })
                .limit(14);
            
            if (data && data.length > 0) {
                displayForecast(data);
            } else {
                // Se não tem cache, mostra placeholder
                forecastGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-cloud-sun" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>Previsão não disponível para esta estação</p>
                    </div>
                `;
            }
        }
        
        function displayForecast(forecasts) {
            const forecastGrid = document.getElementById('forecastGrid');
            
            forecastGrid.innerHTML = forecasts.map(f => {
                const date = new Date(f.momento);
                const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                
                return `
                    <div class="forecast-day">
                        <div class="forecast-date">${date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}</div>
                        <div class="forecast-day-name">${dayNames[date.getDay()]}</div>
                        <div class="forecast-icon">${getWeatherIcon(f.icone)}</div>
                        <div class="forecast-temps">
                            <span class="forecast-temp-min">↓ ${f.minima?.toFixed(0) || '--'}°</span>
                            <span class="forecast-temp-max">↑ ${f.maxima?.toFixed(0) || '--'}°</span>
                        </div>
                        ${f.chance_chuva > 0 ? `
                            <div class="forecast-rain">
                                <i class="fas fa-tint"></i> ${f.chance_chuva}% - ${f.volume_chuva?.toFixed(1) || 0}mm
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function getWeatherIcon(icon) {
            const icons = {
                'clear': '<i class="fas fa-sun" style="color: #fbbf24;"></i>',
                'sunny': '<i class="fas fa-sun" style="color: #fbbf24;"></i>',
                'cloudy': '<i class="fas fa-cloud" style="color: #94a3b8;"></i>',
                'partly-cloudy': '<i class="fas fa-cloud-sun" style="color: #60a5fa;"></i>',
                'rain': '<i class="fas fa-cloud-rain" style="color: #3b82f6;"></i>',
                'storm': '<i class="fas fa-bolt" style="color: #f59e0b;"></i>',
                'snow': '<i class="fas fa-snowflake" style="color: #a5f3fc;"></i>'
            };
            return icons[icon] || '<i class="fas fa-cloud-sun" style="color: #60a5fa;"></i>';
        }
        
        // =============================================
        // HISTÓRICO CLIMÁTICO
        // =============================================
        function initHistoryChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperatura',
                            data: [],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'Precipitação',
                            data: [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.5)',
                            type: 'bar',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#94a3b8'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperatura (°C)',
                                color: '#94a3b8'
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Precipitação (mm)',
                                color: '#94a3b8'
                            },
                            ticks: { color: '#94a3b8' },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });
        }
        
        async function loadHistory() {
            if (!currentEstacao) return;
            
            const dateStart = document.getElementById('dateStart').value;
            const dateEnd = document.getElementById('dateEnd').value;
            
            if (!dateStart || !dateEnd) return;
            
            // Buscar médias diárias
            const { data, error } = await supabaseClient
                .rpc('get_medias_diarias', {
                    p_estacao_id: currentEstacao.id,
                    p_data_inicio: dateStart,
                    p_data_fim: dateEnd
                });
            
            if (data && data.length > 0) {
                updateHistoryChart(data);
                updateSummary(data);
            } else {
                // Se não tem função RPC, busca direto
                const { data: rawData } = await supabaseClient
                    .from('estacao_dados')
                    .select('*')
                    .eq('estacao_id', currentEstacao.id)
                    .gte('coletado_em', `${dateStart}T00:00:00`)
                    .lte('coletado_em', `${dateEnd}T23:59:59`)
                    .order('coletado_em', { ascending: true });
                
                if (rawData && rawData.length > 0) {
                    const processedData = processRawData(rawData);
                    updateHistoryChart(processedData);
                    updateSummary(processedData);
                }
            }
        }
        
        function processRawData(rawData) {
            // Agrupar por dia
            const dailyData = {};
            
            rawData.forEach(d => {
                const day = new Date(d.coletado_em).toISOString().split('T')[0];
                if (!dailyData[day]) {
                    dailyData[day] = {
                        dia: day,
                        temps: [],
                        precip: 0,
                        humidity: [],
                        wind: []
                    };
                }
                
                if (d.temperatura) dailyData[day].temps.push(d.temperatura);
                if (d.total_precipitacao) dailyData[day].precip = Math.max(dailyData[day].precip, d.total_precipitacao);
                if (d.umidade) dailyData[day].humidity.push(d.umidade);
                if (d.velocidade_vento) dailyData[day].wind.push(d.velocidade_vento);
            });
            
            return Object.values(dailyData).map(d => ({
                dia: d.dia,
                temp_min: d.temps.length ? Math.min(...d.temps) : null,
                temp_max: d.temps.length ? Math.max(...d.temps) : null,
                temp_media: d.temps.length ? d.temps.reduce((a, b) => a + b, 0) / d.temps.length : null,
                precipitacao_total: d.precip,
                umidade_media: d.humidity.length ? d.humidity.reduce((a, b) => a + b, 0) / d.humidity.length : null,
                vento_medio: d.wind.length ? d.wind.reduce((a, b) => a + b, 0) / d.wind.length : null
            }));
        }
        
        function updateHistoryChart(data) {
            const labels = data.map(d => {
                const date = new Date(d.dia);
                return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            });
            
            const temps = data.map(d => d.temp_media);
            const precip = data.map(d => d.precipitacao_total || 0);
            
            historyChart.data.labels = labels;
            historyChart.data.datasets[0].data = temps;
            historyChart.data.datasets[1].data = precip;
            historyChart.update();
        }
        
        function updateSummary(data) {
            // Precipitação total
            const totalRain = data.reduce((sum, d) => sum + (d.precipitacao_total || 0), 0);
            document.getElementById('summaryRain').textContent = `${totalRain.toFixed(1)} mm`;
            
            // Temperatura média
            const temps = data.filter(d => d.temp_media).map(d => d.temp_media);
            const avgTemp = temps.length ? temps.reduce((a, b) => a + b, 0) / temps.length : 0;
            document.getElementById('summaryTemp').textContent = `${avgTemp.toFixed(1)}°C`;
            
            // Amplitude térmica média
            const amplitudes = data.filter(d => d.temp_min && d.temp_max)
                .map(d => d.temp_max - d.temp_min);
            const avgAmplitude = amplitudes.length ? amplitudes.reduce((a, b) => a + b, 0) / amplitudes.length : 0;
            document.getElementById('summaryAmplitude').textContent = `${avgAmplitude.toFixed(1)}°C`;
            
            // Vento médio
            const winds = data.filter(d => d.vento_medio).map(d => d.vento_medio);
            const avgWind = winds.length ? winds.reduce((a, b) => a + b, 0) / winds.length : 0;
            document.getElementById('summaryWind').textContent = `${avgWind.toFixed(1)} Km/h`;
        }
        
        // =============================================
        // UTILITÁRIOS
        // =============================================
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
    </script>
</body>
</html>

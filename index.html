<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #10b981; --primary-dark: #059669; --secondary: #3b82f6; --bg-dark: #1e293b; --bg-darker: #0f172a; --bg-card: #334155; --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border: #475569; --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-darker); color: var(--text-primary); min-height: 100vh; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--bg-dark); border-right: 1px solid var(--border); position: fixed; height: 100vh; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .sidebar-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .sidebar-brand { font-size: 20px; font-weight: 700; color: var(--primary); }
        .sidebar-user { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text-secondary); }
        .sidebar-user span { color: var(--text-primary); font-weight: 500; }
        .sidebar-nav { flex: 1; padding: 15px 0; overflow-y: auto; }
        .nav-section { padding: 0 15px; margin-bottom: 20px; }
        .nav-section-title { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 10px 10px 5px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; transition: all 0.2s; margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 20px; text-align: center; }
        .main-content { flex: 1; margin-left: 260px; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .page-title { font-size: 24px; font-weight: 600; }
        .estacao-selector { display: flex; gap: 15px; align-items: center; }
        .estacao-select { padding: 10px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); min-width: 280px; font-size: 14px; }
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .dashboard-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; margin-bottom: 20px; }
        .map-container { background: var(--bg-card); border-radius: 12px; overflow: hidden; height: 400px; }
        #map { width: 100%; height: 100%; }
        .weather-widget { background: linear-gradient(135deg, var(--bg-card), var(--bg-dark)); border-radius: 12px; padding: 20px; }
        .weather-widget-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .weather-location { font-size: 14px; color: var(--text-secondary); }
        .weather-wind { text-align: right; }
        .weather-wind-speed { font-size: 20px; font-weight: 600; }
        .weather-wind-direction { font-size: 12px; color: var(--text-secondary); }
        .weather-main { text-align: center; padding: 20px 0; border-bottom: 1px solid var(--border); }
        .weather-icon { font-size: 48px; margin-bottom: 10px; }
        .weather-condition { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; }
        .weather-temp { font-size: 64px; font-weight: 300; line-height: 1; }
        .weather-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 15px 0; border-bottom: 1px solid var(--border); }
        .weather-stat { text-align: center; }
        .weather-stat-icon { font-size: 16px; color: var(--primary); margin-bottom: 5px; }
        .weather-stat-value { font-size: 14px; font-weight: 600; }
        .weather-stat-label { font-size: 11px; color: var(--text-secondary); }
        .weather-extremes { display: flex; justify-content: center; gap: 30px; padding: 15px 0; }
        .weather-extreme { display: flex; align-items: center; gap: 8px; }
        .weather-extreme-icon { font-size: 14px; }
        .weather-extreme-icon.down { color: var(--info); }
        .weather-extreme-icon.up { color: var(--danger); }
        .weather-updated { text-align: center; font-size: 11px; color: var(--text-secondary); margin-top: 10px; }
        .wind-rose-container { display: flex; align-items: center; gap: 20px; padding: 15px; background: var(--bg-darker); border-radius: 8px; margin-top: 15px; }
        .wind-rose { width: 80px; height: 80px; position: relative; }
        .wind-rose-bg { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 2px solid var(--border); }
        .wind-rose-arrow { position: absolute; top: 50%; left: 50%; width: 4px; height: 30px; background: var(--primary); transform-origin: bottom center; border-radius: 2px; margin-left: -2px; margin-top: -30px; }
        .wind-rose-center { position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; transform: translate(-50%, -50%); }
        .wind-rose-labels { position: absolute; width: 100%; height: 100%; font-size: 9px; color: var(--text-secondary); }
        .wind-rose-labels span { position: absolute; }
        .wind-rose-labels .n { top: 2px; left: 50%; transform: translateX(-50%); }
        .wind-rose-labels .s { bottom: 2px; left: 50%; transform: translateX(-50%); }
        .wind-rose-labels .e { right: 2px; top: 50%; transform: translateY(-50%); }
        .wind-rose-labels .w { left: 2px; top: 50%; transform: translateY(-50%); }
        .history-section { background: var(--bg-card); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .history-filters { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .date-input { padding: 8px 12px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary); }
        .chart-container { height: 300px; margin-bottom: 20px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .summary-card { background: var(--bg-dark); border-radius: 8px; padding: 15px; }
        .summary-card-title { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .summary-card-value { font-size: 24px; font-weight: 600; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.hidden { display: none; }
        .modal { background: var(--bg-dark); border-radius: 16px; padding: 40px; width: 100%; max-width: 400px; border: 1px solid var(--border); }
        .modal-logo { text-align: center; margin-bottom: 30px; }
        .modal-logo i { font-size: 48px; background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .modal-logo h1 { font-size: 28px; font-weight: 700; margin-top: 10px; color: var(--primary); }
        .modal-logo p { color: var(--text-secondary); font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-secondary); }
        .form-group input { width: 100%; padding: 12px 15px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; }
        .form-group input:focus { outline: none; border-color: var(--primary); }
        .btn-block { width: 100%; justify-content: center; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid var(--primary); z-index: 2000; animation: slideIn 0.3s ease; }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .sync-status { display: flex; align-items: center; gap: 8px; font-size: 12px; color: var(--text-secondary); }
        .sync-status.syncing { color: var(--warning); }
        .sync-status.success { color: var(--success); }
        @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); position: fixed; } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0; } .mobile-menu-btn { display: flex !important; } }
        .mobile-menu-btn { display: none; position: fixed; top: 15px; left: 15px; z-index: 101; background: var(--primary); border: none; padding: 10px 15px; border-radius: 8px; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <!-- Login Modal -->
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-logo">
                <i class="fas fa-cloud-sun-rain"></i>
                <h1>Aguaten</h1>
                <p>Sistema de Monitoramento Meteorológico</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required placeholder="seu@email.com">
                </div>
                <div class="form-group">
                    <label>Senha</label>
                    <input type="password" id="loginPassword" required placeholder="••••••••">
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <i class="fas fa-sign-in-alt"></i> Entrar
                </button>
            </form>
        </div>
    </div>
    
    <div class="app-container" id="appContainer" style="display: none;">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-cloud-sun-rain"></i></div>
                <span class="sidebar-brand">Aguaten</span>
            </div>
            <div class="sidebar-user">Olá, <span id="userName">Usuário</span></div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Dashboard</a>
                    <a href="estacoes.html" class="nav-item"><i class="fas fa-broadcast-tower"></i> Minhas Estações</a>
                    <a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> Relatórios</a>
                </div>
                <div class="nav-section" id="adminSection" style="display: none;">
                    <div class="nav-section-title">Administrativo</div>
                    <a href="admin.html" class="nav-item"><i class="fas fa-users-cog"></i> Administração</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Outros</div>
                    <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </div>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Dashboard</h1>
                <div class="estacao-selector">
                    <select class="estacao-select" id="estacaoSelect" onchange="loadEstacaoData()">
                        <option value="">Selecione uma estação...</option>
                    </select>
                    <button class="btn btn-primary" onclick="syncEcowitt()">
                        <i class="fas fa-sync-alt"></i> Sincronizar
                    </button>
                </div>
            </div>
            
            <div id="syncStatus" class="sync-status" style="margin-bottom: 15px;"></div>
            
            <div class="dashboard-grid">
                <div class="map-container"><div id="map"></div></div>
                
                <div class="weather-widget" id="weatherWidget">
                    <div class="weather-widget-header">
                        <div class="weather-location" id="weatherLocation">Selecione uma estação</div>
                        <div class="weather-wind">
                            <div class="weather-wind-speed" id="windSpeed">-- Km/h</div>
                            <div class="weather-wind-direction" id="windGust">Rajada: --</div>
                        </div>
                    </div>
                    <div class="weather-main">
                        <div class="weather-icon" id="weatherIcon"><i class="fas fa-cloud-sun"></i></div>
                        <div class="weather-condition" id="weatherCondition">--</div>
                        <div class="weather-temp"><span id="currentTemp">--</span>°C</div>
                    </div>
                    <div class="weather-stats">
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-wind"></i></div>
                            <div class="weather-stat-value" id="statWind">--</div>
                            <div class="weather-stat-label">Vento</div>
                        </div>
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-tint"></i></div>
                            <div class="weather-stat-value" id="statHumidity">--%</div>
                            <div class="weather-stat-label">Umidade</div>
                        </div>
                        <div class="weather-stat">
                            <div class="weather-stat-icon"><i class="fas fa-cloud-rain"></i></div>
                            <div class="weather-stat-value" id="statRain">--</div>
                            <div class="weather-stat-label">Chuva Hoje</div>
                        </div>
                    </div>
                    <div class="weather-extremes">
                        <div class="weather-extreme">
                            <i class="fas fa-arrow-down weather-extreme-icon down"></i>
                            <span id="pressureRel">-- hPa</span>
                        </div>
                        <div class="weather-extreme">
                            <i class="fas fa-sun weather-extreme-icon up" style="color: var(--warning)"></i>
                            <span id="solarRad">-- W/m²</span>
                        </div>
                    </div>
                    <div class="wind-rose-container">
                        <div class="wind-rose">
                            <div class="wind-rose-bg"></div>
                            <div class="wind-rose-arrow" id="windArrow"></div>
                            <div class="wind-rose-center"></div>
                            <div class="wind-rose-labels"><span class="n">N</span><span class="s">S</span><span class="e">E</span><span class="w">O</span></div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Direção do Vento</div>
                            <div style="font-size: 18px; font-weight: 600;" id="windDirLabel">--</div>
                        </div>
                    </div>
                    <div class="weather-updated" id="weatherUpdated"><i class="fas fa-sync-alt"></i> Atualizado às: --</div>
                </div>
            </div>
            
            <div class="history-section">
                <div class="history-header">
                    <h3 style="font-size: 18px; font-weight: 600;">Histórico</h3>
                    <div class="history-filters">
                        <input type="date" class="date-input" id="dateStart">
                        <input type="date" class="date-input" id="dateEnd">
                        <button class="btn btn-primary" onclick="loadHistory()"><i class="fas fa-search"></i> Consultar</button>
                    </div>
                </div>
                <div class="chart-container"><canvas id="historyChart"></canvas></div>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-card-title">Precipitação Período</div>
                        <div class="summary-card-value" id="summaryRain">-- mm</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Temp. Média</div>
                        <div class="summary-card-value" id="summaryTemp">--°C</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Umidade Média</div>
                        <div class="summary-card-value" id="summaryHumidity">--%</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-card-title">Vento Médio</div>
                        <div class="summary-card-value" id="summaryWind">-- Km/h</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // =============================================
        // CONFIGURAÇÃO
        // =============================================
        const SUPABASE_URL = 'https://ltwtqjrojbobfngcryjw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxNDYyMzcsImV4cCI6MjA1MDcyMjIzN30.JBSNbhP9joHFoxQhZmzzsxhOvGjBvJNT7CRGHYWtWXE';
        
        // Ecowitt API
        const ECOWITT_APP_KEY = '5AF8313E09015663F7DD4BBC211A9F51';
        const ECOWITT_API_KEY = '9031e673-f663-4cfb-a268-2dff2e70afbc';
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null, userProfile = null, estacoes = [], currentEstacao = null, map = null, markers = [], historyChart = null;

        // =============================================
        // INICIALIZAÇÃO
        // =============================================
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (session) { currentUser = session.user; await loadUserProfile(); showApp(); }
            else { showLogin(); }
            
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN') { currentUser = session.user; await loadUserProfile(); showApp(); }
                else if (event === 'SIGNED_OUT') { showLogin(); }
            });
            
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Datas padrão
            const today = new Date();
            const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            document.getElementById('dateEnd').value = today.toISOString().split('T')[0];
            document.getElementById('dateStart').value = weekAgo.toISOString().split('T')[0];
        });

        function showLogin() { document.getElementById('loginModal').classList.remove('hidden'); document.getElementById('appContainer').style.display = 'none'; }
        function showApp() { document.getElementById('loginModal').classList.add('hidden'); document.getElementById('appContainer').style.display = 'flex'; initializeApp(); }
        
        async function handleLogin(e) {
            e.preventDefault();
            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: document.getElementById('loginEmail').value,
                    password: document.getElementById('loginPassword').value
                });
                if (error) throw error;
                showToast('Login realizado!', 'success');
            } catch (error) { showToast(error.message, 'error'); }
        }
        
        async function logout() { await supabaseClient.auth.signOut(); showLogin(); }
        
        async function loadUserProfile() {
            const { data } = await supabaseClient.from('perfis').select('*').eq('id', currentUser.id).single();
            if (data) {
                userProfile = data;
                document.getElementById('userName').textContent = data.primeiro_nome || data.email.split('@')[0];
                if (data.is_admin) document.getElementById('adminSection').style.display = 'block';
            }
        }

        // =============================================
        // APP INIT
        // =============================================
        async function initializeApp() {
            initMap();
            await loadEstacoes();
            initHistoryChart();
        }
        
        function initMap() {
            map = L.map('map').setView([-25.4284, -54.5934], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);
        }
        
        async function loadEstacoes() {
            const { data } = await supabaseClient.from('estacoes').select('*').eq('ativo', true);
            estacoes = data || [];
            
            const select = document.getElementById('estacaoSelect');
            select.innerHTML = '<option value="">Selecione uma estação...</option>' +
                estacoes.map(e => `<option value="${e.id}">${e.identificador} - ${e.nome || e.cidade || 'Sem nome'}</option>`).join('');
            
            // Marcadores no mapa
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            estacoes.forEach(est => {
                if (est.latitude && est.longitude) {
                    const marker = L.marker([est.latitude, est.longitude]).addTo(map)
                        .bindPopup(`<strong>${est.nome || est.identificador}</strong><br>${est.cidade || ''}`);
                    marker.on('click', () => { document.getElementById('estacaoSelect').value = est.id; loadEstacaoData(); });
                    markers.push(marker);
                }
            });
            
            if (markers.length > 0) map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
            if (estacoes.length > 0) { select.value = estacoes[0].id; loadEstacaoData(); }
        }

        // =============================================
        // CARREGAR DADOS DA ESTAÇÃO
        // =============================================
        async function loadEstacaoData() {
            const estacaoId = document.getElementById('estacaoSelect').value;
            if (!estacaoId) return;
            
            currentEstacao = estacoes.find(e => e.id === estacaoId);
            if (!currentEstacao) return;
            
            document.getElementById('weatherLocation').textContent = `${currentEstacao.nome || currentEstacao.identificador} - ${currentEstacao.cidade || currentEstacao.pais || ''}`;
            
            // Buscar último dado
            const { data } = await supabaseClient.from('estacao_dados')
                .select('*').eq('estacao_id', estacaoId)
                .order('coletado_em', { ascending: false }).limit(1);
            
            if (data && data.length > 0) {
                displayWeatherData(data[0]);
            } else if (currentEstacao.data_cache) {
                displayWeatherData(currentEstacao.data_cache);
            }
            
            loadHistory();
        }
        
        function displayWeatherData(d) {
            document.getElementById('currentTemp').textContent = d.temperatura?.toFixed(1) || '--';
            document.getElementById('windSpeed').textContent = `${d.velocidade_vento?.toFixed(1) || '--'} Km/h`;
            document.getElementById('windGust').textContent = `Rajada: ${d.rajada_vento?.toFixed(1) || '--'} Km/h`;
            document.getElementById('statWind').textContent = `${d.velocidade_vento?.toFixed(1) || '--'} Km/h`;
            document.getElementById('statHumidity').textContent = `${d.umidade?.toFixed(0) || '--'}%`;
            document.getElementById('statRain').textContent = `${d.precipitacao_diaria?.toFixed(1) || '0'} mm`;
            document.getElementById('pressureRel').textContent = `${d.pressao_relativa?.toFixed(1) || '--'} hPa`;
            document.getElementById('solarRad').textContent = `${d.radiacao_solar?.toFixed(0) || '--'} W/m²`;
            
            // Rosa dos ventos
            if (d.direcao_vento !== null) {
                document.getElementById('windArrow').style.transform = `rotate(${d.direcao_vento}deg)`;
                document.getElementById('windDirLabel').textContent = getWindDirection(d.direcao_vento);
            }
            
            // Condição
            const cond = getWeatherCondition(d);
            document.getElementById('weatherCondition').textContent = cond.text;
            document.getElementById('weatherIcon').innerHTML = `<i class="fas ${cond.icon}"></i>`;
            
            // Horário
            const time = d.coletado_em ? new Date(d.coletado_em).toLocaleString('pt-BR') : '--';
            document.getElementById('weatherUpdated').innerHTML = `<i class="fas fa-sync-alt"></i> ${time}`;
        }
        
        function getWindDirection(deg) {
            if (deg === null) return '--';
            const dirs = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSO', 'SO', 'OSO', 'O', 'ONO', 'NO', 'NNO'];
            return dirs[Math.round(deg / 22.5) % 16];
        }
        
        function getWeatherCondition(d) {
            if (d.taxa_precipitacao > 0) return { text: 'Chuva', icon: 'fa-cloud-rain' };
            if (d.umidade > 90) return { text: 'Nublado', icon: 'fa-cloud' };
            if (d.umidade > 70) return { text: 'Parcialmente nublado', icon: 'fa-cloud-sun' };
            return { text: 'Céu limpo', icon: 'fa-sun' };
        }

        // =============================================
        // SINCRONIZAR ECOWITT
        // =============================================
        async function syncEcowitt() {
            if (!currentEstacao) { showToast('Selecione uma estação', 'error'); return; }
            
            const statusEl = document.getElementById('syncStatus');
            statusEl.className = 'sync-status syncing';
            statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sincronizando com Ecowitt...';
            
            try {
                // Chamar API Ecowitt
                const url = `https://api.ecowitt.net/api/v3/device/real_time?application_key=${ECOWITT_APP_KEY}&api_key=${ECOWITT_API_KEY}&imei=${currentEstacao.identificador}&call_back=all`;
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.code !== 0) throw new Error(result.msg || 'Erro na API Ecowitt');
                
                const data = result.data;
                
                // Mapear dados
                const outdoor = data.outdoor || {};
                const wind = data.wind || {};
                const rainfall = data.rainfall || {};
                const pressure = data.pressure || {};
                const solar = data.solar_and_uvi || {};
                const indoor = data.indoor || {};
                
                const mapped = {
                    estacao_id: currentEstacao.id,
                    coletado_em: new Date().toISOString(),
                    temperatura: outdoor.temperature?.value,
                    umidade: outdoor.humidity?.value,
                    velocidade_vento: wind.wind_speed?.value,
                    direcao_vento: wind.wind_direction?.value,
                    rajada_vento: wind.wind_gust?.value,
                    taxa_precipitacao: rainfall.rain_rate?.value,
                    precipitacao_diaria: rainfall.daily?.value,
                    precipitacao_semanal: rainfall.weekly?.value,
                    precipitacao_mensal: rainfall.monthly?.value,
                    precipitacao_anual: rainfall.yearly?.value,
                    radiacao_solar: solar.solar?.value,
                    indice_uv: solar.uvi?.value,
                    pressao_relativa: pressure.relative?.value,
                    pressao_absoluta: pressure.absolute?.value,
                    temperatura_indoor: indoor.temperature?.value,
                    umidade_indoor: indoor.humidity?.value
                };
                
                // Salvar no Supabase
                const { error } = await supabaseClient.from('estacao_dados').insert(mapped);
                if (error) throw error;
                
                // Atualizar cache da estação
                await supabaseClient.from('estacoes').update({ 
                    data_cache: mapped, 
                    ultima_sincronizacao: new Date().toISOString() 
                }).eq('id', currentEstacao.id);
                
                // Log
                await supabaseClient.from('station_server_logs').insert({
                    tipo: 'sucesso',
                    identificador: currentEstacao.identificador,
                    log: 'Sincronização manual Ecowitt',
                    dados_raw: result.data
                });
                
                statusEl.className = 'sync-status success';
                statusEl.innerHTML = '<i class="fas fa-check"></i> Sincronizado com sucesso!';
                
                displayWeatherData(mapped);
                showToast('Dados sincronizados!', 'success');
                
            } catch (err) {
                console.error(err);
                statusEl.className = 'sync-status';
                statusEl.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: var(--danger)"></i> Erro: ${err.message}`;
                
                await supabaseClient.from('station_server_logs').insert({
                    tipo: 'erro',
                    identificador: currentEstacao?.identificador,
                    log: err.message
                });
                
                showToast('Erro na sincronização: ' + err.message, 'error');
            }
        }

        // =============================================
        // HISTÓRICO
        // =============================================
        function initHistoryChart() {
            const ctx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [
                    { label: 'Temperatura (°C)', data: [], borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', yAxisID: 'y', tension: 0.4 },
                    { label: 'Chuva (mm)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.5)', type: 'bar', yAxisID: 'y1' }
                ]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { position: 'left', title: { display: true, text: 'Temp (°C)', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y1: { position: 'right', title: { display: true, text: 'Chuva (mm)', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
        
        async function loadHistory() {
            if (!currentEstacao) return;
            
            const start = document.getElementById('dateStart').value;
            const end = document.getElementById('dateEnd').value;
            if (!start || !end) return;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('*').eq('estacao_id', currentEstacao.id)
                .gte('coletado_em', `${start}T00:00:00`)
                .lte('coletado_em', `${end}T23:59:59`)
                .order('coletado_em', { ascending: true });
            
            if (!data || data.length === 0) return;
            
            // Agrupar por dia
            const daily = {};
            data.forEach(d => {
                const day = d.coletado_em.split('T')[0];
                if (!daily[day]) daily[day] = { temps: [], rain: 0, humidity: [], wind: [] };
                if (d.temperatura) daily[day].temps.push(d.temperatura);
                if (d.precipitacao_diaria) daily[day].rain = Math.max(daily[day].rain, d.precipitacao_diaria);
                if (d.umidade) daily[day].humidity.push(d.umidade);
                if (d.velocidade_vento) daily[day].wind.push(d.velocidade_vento);
            });
            
            const labels = Object.keys(daily).map(d => new Date(d).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }));
            const temps = Object.values(daily).map(d => d.temps.length ? d.temps.reduce((a,b)=>a+b,0)/d.temps.length : null);
            const rain = Object.values(daily).map(d => d.rain);
            
            historyChart.data.labels = labels;
            historyChart.data.datasets[0].data = temps;
            historyChart.data.datasets[1].data = rain;
            historyChart.update();
            
            // Resumo
            const allTemps = data.filter(d => d.temperatura).map(d => d.temperatura);
            const allHumidity = data.filter(d => d.umidade).map(d => d.umidade);
            const allWind = data.filter(d => d.velocidade_vento).map(d => d.velocidade_vento);
            const totalRain = rain.reduce((a,b)=>a+b, 0);
            
            document.getElementById('summaryRain').textContent = `${totalRain.toFixed(1)} mm`;
            document.getElementById('summaryTemp').textContent = allTemps.length ? `${(allTemps.reduce((a,b)=>a+b,0)/allTemps.length).toFixed(1)}°C` : '--';
            document.getElementById('summaryHumidity').textContent = allHumidity.length ? `${(allHumidity.reduce((a,b)=>a+b,0)/allHumidity.length).toFixed(0)}%` : '--';
            document.getElementById('summaryWind').textContent = allWind.length ? `${(allWind.reduce((a,b)=>a+b,0)/allWind.length).toFixed(1)} Km/h` : '--';
        }

        // =============================================
        // UTILS
        // =============================================
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}
        .app-container{display:flex;min-height:100vh}.sidebar{width:240px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;z-index:100;display:flex;flex-direction:column}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:8px;display:flex;align-items:center;justify-content:center}.sidebar-brand{font-size:18px;font-weight:700;color:var(--primary)}
        .sidebar-nav{flex:1;padding:15px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;margin-bottom:4px}.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--primary);color:white}.nav-item i{width:20px}
        .main-content{flex:1;margin-left:240px;padding:20px}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}.page-title{font-size:22px;font-weight:600}
        .header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.unit-toggle{display:flex;background:var(--bg-card);border-radius:6px;overflow:hidden}.unit-btn{padding:8px 14px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px}.unit-btn.active{background:var(--primary);color:white}
        .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}.btn-sm{padding:6px 12px;font-size:11px}
        .dashboard-grid{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-bottom:20px}.map-container{background:var(--bg-card);border-radius:12px;overflow:hidden;height:480px;position:relative}#map{width:100%;height:100%}
        .map-controls{position:absolute;top:10px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:4px}.map-control-btn{background:var(--bg-dark);border:1px solid var(--border);color:var(--text-primary);padding:6px 10px;border-radius:4px;cursor:pointer;font-size:11px}.map-control-btn.active{background:var(--primary);border-color:var(--primary)}
        .map-display-controls{position:absolute;bottom:10px;left:10px;z-index:1000;display:flex;gap:4px;background:var(--bg-dark);padding:6px;border-radius:8px;border:1px solid var(--border)}.map-display-btn{width:36px;height:36px;border:none;border-radius:6px;background:var(--bg-card);color:var(--text-secondary);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .2s}.map-display-btn:hover{color:var(--text-primary);background:var(--border)}.map-display-btn.active{background:var(--primary);color:white}
        .station-marker{background:transparent!important;border:none!important}
        .weather-widget{background:linear-gradient(135deg,var(--bg-card),var(--bg-dark));border-radius:12px;padding:18px}.widget-header{margin-bottom:15px;display:flex;justify-content:space-between;align-items:center;gap:10px}.widget-header select{flex:1;padding:10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px}
        .auto-sync-indicator{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--success)}.auto-sync-indicator.off{color:var(--text-secondary)}
        .weather-main{text-align:center;padding:20px 0;border-bottom:1px solid var(--border)}.weather-icon{font-size:48px;margin-bottom:8px}.weather-temp{font-size:56px;font-weight:300}.weather-feels{font-size:12px;color:var(--text-secondary);margin-top:5px}
        .weather-details{display:grid;grid-template-columns:1fr 1fr;gap:12px;padding:15px 0;border-bottom:1px solid var(--border)}.weather-detail{display:flex;align-items:center;gap:8px}.weather-detail-icon{width:32px;height:32px;background:var(--bg-dark);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:14px}.weather-detail-value{font-size:14px;font-weight:600}.weather-detail-label{font-size:10px;color:var(--text-secondary)}
        .rain-section{padding:15px 0;border-bottom:1px solid var(--border)}.rain-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.rain-tabs{display:flex;gap:4px}.rain-tab{padding:4px 8px;background:var(--bg-dark);border:none;border-radius:4px;color:var(--text-secondary);cursor:pointer;font-size:10px}.rain-tab.active{background:var(--secondary);color:white}.rain-display{display:flex;align-items:center;gap:12px}.rain-value{font-size:24px;font-weight:700}
        .wind-section{padding:15px 0}.wind-rose-container{display:flex;align-items:center;gap:15px}.wind-rose{width:70px;height:70px;position:relative}.wind-rose-bg{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--border)}.wind-rose-arrow{position:absolute;top:50%;left:50%;width:3px;height:25px;background:var(--primary);transform-origin:bottom center;margin-left:-1.5px;margin-top:-25px;border-radius:2px}.wind-rose-center{position:absolute;top:50%;left:50%;width:6px;height:6px;background:var(--primary);border-radius:50%;transform:translate(-50%,-50%)}.wind-rose-labels{position:absolute;width:100%;height:100%;font-size:8px;color:var(--text-secondary)}.wind-rose-labels span{position:absolute}.wind-rose-labels .n{top:2px;left:50%;transform:translateX(-50%)}.wind-rose-labels .s{bottom:2px;left:50%;transform:translateX(-50%)}.wind-rose-labels .e{right:2px;top:50%;transform:translateY(-50%)}.wind-rose-labels .w{left:2px;top:50%;transform:translateY(-50%)}.wind-speed{font-size:20px;font-weight:700}.wind-gust,.wind-direction{font-size:11px;color:var(--text-secondary)}
        .weather-updated{text-align:center;font-size:10px;color:var(--text-secondary);margin-top:12px}
        .history-section{background:var(--bg-card);border-radius:12px;padding:18px}.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:10px}.history-filters{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.date-input{padding:8px 10px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:12px}.chart-container{height:280px;margin-bottom:15px}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}.summary-card{background:var(--bg-dark);border-radius:8px;padding:12px}.summary-card-title{font-size:11px;color:var(--text-secondary);margin-bottom:6px}.summary-card-value{font-size:20px;font-weight:600}
        .sync-status{display:flex;align-items:center;gap:8px;font-size:11px;padding:10px 14px;background:var(--bg-card);border-radius:8px;margin-bottom:12px}.sync-status.syncing{color:var(--warning)}.sync-status.success{color:var(--success);background:rgba(34,197,94,.1)}.sync-status.error{color:var(--danger);background:rgba(239,68,68,.1)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}.modal-overlay.hidden{display:none}.modal{background:var(--bg-dark);border-radius:16px;padding:35px;width:100%;max-width:380px;border:1px solid var(--border)}.modal-logo{text-align:center;margin-bottom:25px}.modal-logo i{font-size:42px;color:var(--primary)}.modal-logo h1{font-size:24px;margin-top:8px;color:var(--primary)}.form-group{margin-bottom:18px}.form-group label{display:block;margin-bottom:6px;font-size:13px;color:var(--text-secondary)}.form-group input{width:100%;padding:11px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px}.btn-block{width:100%;justify-content:center}
        .toast{position:fixed;top:20px;right:20px;padding:12px 20px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000;font-size:13px}.toast.error{border-color:var(--danger)}.toast.success{border-color:var(--success)}
        @media(max-width:1024px){.dashboard-grid{grid-template-columns:1fr}}@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
    </style>
</head>
<body>
<div class="modal-overlay" id="loginModal"><div class="modal"><div class="modal-logo"><i class="fas fa-cloud-sun-rain"></i><h1>Aguaten</h1><p style="color:var(--text-secondary);font-size:13px">Monitoramento Meteorologico</p></div><form id="loginForm"><div class="form-group"><label>Email</label><input type="email" id="loginEmail" required></div><div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required></div><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-sign-in-alt"></i> Entrar</button></form><p style="text-align:center;margin-top:18px;font-size:12px;color:var(--text-secondary)">Nao tem conta? <a href="#" onclick="toggleRegister()" style="color:var(--primary)">Cadastre-se</a></p><form id="registerForm" style="display:none"><div class="form-group"><label>Nome</label><input type="text" id="registerName" required></div><div class="form-group"><label>Email</label><input type="email" id="registerEmail" required></div><div class="form-group"><label>Senha</label><input type="password" id="registerPassword" required minlength="6"></div><button type="submit" class="btn btn-primary btn-block"><i class="fas fa-user-plus"></i> Cadastrar</button><p style="text-align:center;margin-top:12px;font-size:12px"><a href="#" onclick="toggleRegister()" style="color:var(--primary)">Voltar</a></p></form></div></div>
<div class="app-container" id="appContainer" style="display:none">
<aside class="sidebar"><div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-cloud-sun-rain" style="color:white;font-size:16px"></i></div><span class="sidebar-brand">Aguaten</span></div><nav class="sidebar-nav"><a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Dashboard</a><a href="previsao.html" class="nav-item"><i class="fas fa-cloud-sun"></i> Previsao</a><a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> Relatorios</a><a href="admin.html" class="nav-item" id="adminLink" style="display:none"><i class="fas fa-cog"></i> Admin</a><a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></nav></aside>
<main class="main-content">
<div class="page-header"><h1 class="page-title">Dashboard</h1><div class="header-controls"><div class="unit-toggle"><button class="unit-btn active" onclick="setUnit('metric')" id="btn-metric">C</button><button class="unit-btn" onclick="setUnit('imperial')" id="btn-imperial">F</button></div><button class="btn btn-primary" onclick="syncEcowitt()" id="syncBtn"><i class="fas fa-sync-alt"></i> Atualizar</button><button class="btn" style="background:var(--secondary)" onclick="importHistory()" id="historyBtn"><i class="fas fa-history"></i> Importar Histórico</button></div></div>
<div id="syncStatus" class="sync-status" style="display:none"></div>
<div class="dashboard-grid">
<div class="map-container"><div id="map"></div><div class="map-controls"><button class="map-control-btn" onclick="setMapLayer('street')" id="btn-street">Mapa</button><button class="map-control-btn active" onclick="setMapLayer('satellite')" id="btn-satellite">Satelite</button><button class="map-control-btn" onclick="setMapLayer('terrain')" id="btn-terrain">Terreno</button></div><div class="map-display-controls"><button class="map-display-btn active" onclick="setMapDisplay('temp')" id="map-btn-temp" title="Temperatura"><i class="fas fa-thermometer-half"></i></button><button class="map-display-btn" onclick="setMapDisplay('rain_day')" id="map-btn-rain_day" title="Chuva Hoje"><i class="fas fa-cloud-sun-rain"></i></button><button class="map-display-btn" onclick="setMapDisplay('rain_week')" id="map-btn-rain_week" title="Chuva Semana"><i class="fas fa-cloud-rain"></i></button><button class="map-display-btn" onclick="setMapDisplay('rain_month')" id="map-btn-rain_month" title="Chuva Mes"><i class="fas fa-cloud-showers-heavy"></i></button></div></div>
<div class="weather-widget">
<div class="widget-header">
    <select id="estacaoSelect" onchange="loadEstacaoData()"><option value="">Selecione...</option></select>
    <div class="auto-sync-indicator" id="autoSyncIndicator"><i class="fas fa-server"></i> Sync Server 5min</div>
</div>
<div class="weather-main"><div class="weather-icon" id="weatherIcon"><i class="fas fa-cloud-sun" style="color:var(--warning)"></i></div><div class="weather-temp"><span id="currentTemp">--</span><span style="font-size:20px" id="tempUnit">C</span></div><div class="weather-feels" id="weatherFeels">Sensacao: --</div></div>
<div class="weather-details"><div class="weather-detail"><div class="weather-detail-icon" style="color:var(--info)"><i class="fas fa-tint"></i></div><div><div class="weather-detail-value" id="detailHumidity">--%</div><div class="weather-detail-label">Umidade</div></div></div><div class="weather-detail"><div class="weather-detail-icon" style="color:#8b5cf6"><i class="fas fa-tachometer-alt"></i></div><div><div class="weather-detail-value" id="detailPressure">--</div><div class="weather-detail-label">Pressao</div></div></div><div class="weather-detail"><div class="weather-detail-icon" style="color:var(--danger)"><i class="fas fa-sun"></i></div><div><div class="weather-detail-value" id="detailUV">--</div><div class="weather-detail-label">UV</div></div></div><div class="weather-detail"><div class="weather-detail-icon" style="color:var(--warning)"><i class="fas fa-home"></i></div><div><div class="weather-detail-value" id="detailIndoor">--</div><div class="weather-detail-label">Indoor</div></div></div></div>
<div class="rain-section">
<div class="rain-header"><span style="font-size:13px;font-weight:600"><i class="fas fa-cloud-rain" style="color:var(--secondary)"></i> Precipitacao</span><div class="rain-tabs"><button class="rain-tab active" onclick="setRainPeriod('day')" id="rain-day">Hoje</button><button class="rain-tab" onclick="setRainPeriod('week')" id="rain-week">Semana</button><button class="rain-tab" onclick="setRainPeriod('month')" id="rain-month">Mes</button><button class="rain-tab" onclick="setRainPeriod('year')" id="rain-year">Ano</button></div></div>
<div class="rain-display"><i class="fas fa-cloud-showers-heavy" style="font-size:28px;color:var(--secondary)"></i><div><span class="rain-value" id="rainValue">--</span> <span style="font-size:12px;color:var(--text-secondary)" id="rainUnit">mm</span></div></div>
</div>
<div class="wind-section"><div class="wind-rose-container"><div class="wind-rose"><div class="wind-rose-bg"></div><div class="wind-rose-arrow" id="windArrow"></div><div class="wind-rose-center"></div><div class="wind-rose-labels"><span class="n">N</span><span class="s">S</span><span class="e">E</span><span class="w">O</span></div></div><div><div class="wind-speed" id="windSpeed">-- <span id="windUnit" style="font-size:12px">km/h</span></div><div class="wind-gust" id="windGust">Rajada: --</div><div class="wind-direction" id="windDirection">Dir: --</div></div></div></div>
<div class="weather-updated" id="weatherUpdated"><i class="fas fa-clock"></i> --</div>
</div>
</div>
<div class="history-section"><div class="history-header"><h3 style="font-size:16px"><i class="fas fa-chart-area" style="color:var(--primary)"></i> Historico</h3><div class="history-filters"><input type="date" class="date-input" id="dateStart"><input type="date" class="date-input" id="dateEnd"><button class="btn btn-primary" onclick="loadHistory()"><i class="fas fa-search"></i></button></div></div><div class="chart-container"><canvas id="historyChart"></canvas></div><div class="summary-grid"><div class="summary-card"><div class="summary-card-title"><i class="fas fa-cloud-rain" style="color:var(--info)"></i> Chuva Periodo</div><div class="summary-card-value" id="summaryRain">--</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-thermometer-half" style="color:var(--warning)"></i> Temp Media</div><div class="summary-card-value" id="summaryTemp">--</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-tint" style="color:var(--secondary)"></i> Umidade Media</div><div class="summary-card-value" id="summaryHumidity">--</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-wind" style="color:var(--success)"></i> Vento Medio</div><div class="summary-card-value" id="summaryWind">--</div></div></div></div>
</div>
</main>
</div>
<script>
const SUPABASE_URL='https://ltwtqjrojbobfngcryjw.supabase.co',SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NjAyODcsImV4cCI6MjA4MjIzNjI4N30.le4b9sZ7jMfpPjPn9FiWK9tpDxnTn0VaCl2vlQv14SA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let user=null,profile=null,estacoes=[],estacoesData={},currentEst=null,weatherData=null,map=null,markers=[],chart=null,layers={},currentLayer=null;
let unit='metric',rainPeriod='day',mapDisplayMode='temp';

document.addEventListener('DOMContentLoaded',async()=>{
    const{data:{session}}=await sb.auth.getSession();
    if(session){user=session.user;await loadProfile();showApp()}else showLogin();
    sb.auth.onAuthStateChange(async(e,s)=>{if(e==='SIGNED_IN'){user=s.user;await loadProfile();showApp()}else if(e==='SIGNED_OUT')showLogin()});
    document.getElementById('loginForm').onsubmit=login;
    document.getElementById('registerForm').onsubmit=register;
    const d=new Date();
    document.getElementById('dateEnd').value=d.toISOString().split('T')[0];
    document.getElementById('dateStart').value=new Date(d-7*864e5).toISOString().split('T')[0];
});

function showLogin(){document.getElementById('loginModal').classList.remove('hidden');document.getElementById('appContainer').style.display='none'}
function showApp(){document.getElementById('loginModal').classList.add('hidden');document.getElementById('appContainer').style.display='flex';initApp()}
function toggleRegister(){const l=document.getElementById('loginForm'),r=document.getElementById('registerForm');l.style.display=l.style.display==='none'?'block':'none';r.style.display=r.style.display==='none'?'block':'none'}
async function login(e){e.preventDefault();try{const{error}=await sb.auth.signInWithPassword({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPassword').value});if(error)throw error;toast('Login OK!','success')}catch(err){toast(err.message,'error')}}
async function register(e){e.preventDefault();try{const{error}=await sb.auth.signUp({email:document.getElementById('registerEmail').value,password:document.getElementById('registerPassword').value,options:{data:{primeiro_nome:document.getElementById('registerName').value}}});if(error)throw error;toast('Conta criada!','success');toggleRegister()}catch(err){toast(err.message,'error')}}
async function logout(){await sb.auth.signOut();showLogin()}
async function loadProfile(){const{data}=await sb.from('perfis').select('*').eq('id',user.id).single();if(data){profile=data;if(data.is_admin)document.getElementById('adminLink').style.display='block'}}
async function initApp(){initMap();await loadEstacoes();initChart();startAutoRefresh()}

function initMap(){
    map=L.map('map').setView([-25.4,-54.6],10);
    layers.street=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    layers.satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    layers.terrain=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png');
    layers.satellite.addTo(map);currentLayer='satellite';
}
function setMapLayer(l){if(currentLayer)map.removeLayer(layers[currentLayer]);layers[l].addTo(map);currentLayer=l;document.querySelectorAll('.map-control-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn-'+l).classList.add('active')}

// ============ AUTO REFRESH (apenas recarrega dados do banco) ============
function startAutoRefresh(){
    // Recarregar dados do banco a cada 5 minutos (servidor faz o sync)
    setInterval(async()=>{
        console.log('Recarregando dados...');
        await reloadAllData();
    },5*60*1000);
    document.getElementById('autoSyncIndicator').classList.remove('off');
}

async function reloadAllData(){
    for(const est of estacoes){
        const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',est.id).order('coletado_em',{ascending:false}).limit(1);
        if(data&&data.length)estacoesData[est.id]=data[0];
    }
    await updateMapMarkers();
    if(currentEst)loadEstacaoData();
}

// ============ ESTACOES ============
async function loadEstacoes(){
    const{data}=await sb.from('estacoes').select('*').eq('ativo',true);
    estacoes=data||[];
    const sel=document.getElementById('estacaoSelect');
    sel.innerHTML='<option value="">Selecione...</option>'+estacoes.map(e=>'<option value="'+e.id+'">'+e.identificador+' - '+(e.nome||'Estacao')+'</option>').join('');
    
    // Carregar dados mais recentes de cada estacao do banco
    for(const est of estacoes){
        const{data:dados}=await sb.from('estacao_dados').select('*').eq('estacao_id',est.id).order('coletado_em',{ascending:false}).limit(1);
        if(dados&&dados.length)estacoesData[est.id]=dados[0];
        else if(est.data_cache)estacoesData[est.id]=est.data_cache;
    }
    
    await updateMapMarkers();
    if(estacoes.length){sel.value=estacoes[0].id;loadEstacaoData()}
}

async function updateMapMarkers(){
    markers.forEach(m=>map.removeLayer(m));markers=[];
    for(const e of estacoes){
        if(e.latitude&&e.longitude){
            const dados=estacoesData[e.id];
            const marker=createStationMarker(e,dados);
            marker.on('click',()=>{document.getElementById('estacaoSelect').value=e.id;loadEstacaoData()});
            markers.push(marker);
        }
    }
    if(markers.length)map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));
}

function createStationMarker(estacao,dados){
    let value='--',color='#6b7280';
    
    if(dados){
        if(mapDisplayMode==='temp'){
            const temp=safeNum(dados.temperatura);
            if(temp!==null){
                const displayTemp=unit==='imperial'?c2f(temp):temp;
                value=Math.round(displayTemp)+(unit==='metric'?'C':'F');
                color=getTempColor(temp);
            }
        }else{
            let rain=null;
            if(mapDisplayMode==='rain_day')rain=safeNum(dados.precipitacao_diaria);
            else if(mapDisplayMode==='rain_week')rain=safeNum(dados.precipitacao_semanal);
            else if(mapDisplayMode==='rain_month')rain=safeNum(dados.precipitacao_mensal);
            
            if(rain!==null){
                const displayRain=unit==='imperial'?mm2in(rain):rain;
                value=displayRain.toFixed(unit==='imperial'?2:1);
                color=getRainColor(rain);
            }
        }
    }
    
    const html=`<div style="position:relative;display:flex;flex-direction:column;align-items:center;">
        <div style="background:${color};color:white;padding:4px 8px;border-radius:12px;font-size:13px;font-weight:700;box-shadow:0 2px 8px rgba(0,0,0,.4);border:2px solid white;min-width:50px;text-align:center;text-shadow:0 1px 2px rgba(0,0,0,.3);">${value}</div>
        <div style="width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:8px solid ${color};margin-top:-1px;"></div>
    </div>`;
    
    const icon=L.divIcon({className:'station-marker',html:html,iconSize:[60,45],iconAnchor:[30,45]});
    
    const d=dados;
    const popupContent=`<div style="text-align:center;min-width:160px;">
        <b style="font-size:14px;">${estacao.nome||estacao.identificador}</b>
        ${d?`<div style="margin-top:8px;font-size:12px;text-align:left;">
            <div><i class="fas fa-thermometer-half" style="color:#f59e0b;width:18px;"></i> ${d.temperatura?.toFixed(1)||'--'}C</div>
            <div><i class="fas fa-tint" style="color:#3b82f6;width:18px;"></i> ${d.umidade||'--'}%</div>
            <div><i class="fas fa-cloud-sun-rain" style="color:#0ea5e9;width:18px;"></i> Dia: ${d.precipitacao_diaria?.toFixed(1)||'--'} mm</div>
            <div><i class="fas fa-cloud-rain" style="color:#6366f1;width:18px;"></i> Sem: ${d.precipitacao_semanal?.toFixed(1)||'--'} mm</div>
            <div><i class="fas fa-cloud-showers-heavy" style="color:#8b5cf6;width:18px;"></i> Mes: ${d.precipitacao_mensal?.toFixed(1)||'--'} mm</div>
            <div><i class="fas fa-wind" style="color:#10b981;width:18px;"></i> ${d.velocidade_vento?.toFixed(1)||'--'} km/h</div>
        </div>`:'<div style="color:#94a3b8;margin-top:5px;">Sem dados</div>'}
    </div>`;
    
    return L.marker([estacao.latitude,estacao.longitude],{icon}).addTo(map).bindPopup(popupContent);
}

function getTempColor(temp){
    if(temp<=-10)return '#1e40af';if(temp<=0)return '#3b82f6';if(temp<=10)return '#06b6d4';
    if(temp<=18)return '#10b981';if(temp<=24)return '#84cc16';if(temp<=28)return '#eab308';
    if(temp<=32)return '#f97316';if(temp<=36)return '#ef4444';if(temp<=40)return '#dc2626';
    return '#991b1b';
}
function getRainColor(rain){
    if(rain<=0)return '#6b7280';if(rain<=2)return '#93c5fd';if(rain<=5)return '#60a5fa';
    if(rain<=10)return '#3b82f6';if(rain<=20)return '#2563eb';if(rain<=50)return '#7c3aed';
    if(rain<=100)return '#a855f7';if(rain<=200)return '#d946ef';return '#ec4899';
}

function setMapDisplay(mode){
    mapDisplayMode=mode;
    document.querySelectorAll('.map-display-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('map-btn-'+mode).classList.add('active');
    updateMapMarkers();
}

async function loadEstacaoData(){
    const id=document.getElementById('estacaoSelect').value;
    if(!id)return;
    currentEst=estacoes.find(e=>e.id===id);
    if(!currentEst)return;
    if(currentEst.latitude&&currentEst.longitude)map.setView([currentEst.latitude,currentEst.longitude],12);
    
    // Usar dados do cache local primeiro
    let dados=estacoesData[id];
    if(!dados){
        const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',id).order('coletado_em',{ascending:false}).limit(1);
        if(data&&data.length){dados=data[0];estacoesData[id]=dados}
    }
    if(dados)displayWeather(dados);
    loadHistory();
}

// ============ CONVERSOES ============
function safeNum(v){if(v==null)return null;const n=parseFloat(v);return isNaN(n)?null:n}
function fmt(v,d=1){const n=safeNum(v);return n!==null?n.toFixed(d):'--'}
// Conversoes Metrico -> Imperial (para exibir se usuario preferir)
function c2f(c){return c!==null?(c*9/5)+32:null}
function mm2in(m){return m!==null?m/25.4:null}
function kmh2mph(k){return k!==null?k/1.60934:null}

function setUnit(u){
    unit=u;
    document.querySelectorAll('.unit-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('btn-'+u).classList.add('active');
    document.getElementById('tempUnit').textContent=u==='metric'?'C':'F';
    document.getElementById('windUnit').textContent=u==='metric'?'km/h':'mph';
    document.getElementById('rainUnit').textContent=u==='metric'?'mm':'in';
    if(weatherData)displayWeather(weatherData);
    updateMapMarkers();
    loadHistory();
}

function setRainPeriod(p){
    rainPeriod=p;
    document.querySelectorAll('.rain-tab').forEach(b=>b.classList.remove('active'));
    document.getElementById('rain-'+p).classList.add('active');
    updateRainDisplay();
}

function updateRainDisplay(){
    if(!weatherData)return;
    let v=null;
    if(rainPeriod==='day')v=safeNum(weatherData.precipitacao_diaria);
    else if(rainPeriod==='week')v=safeNum(weatherData.precipitacao_semanal);
    else if(rainPeriod==='month')v=safeNum(weatherData.precipitacao_mensal);
    else if(rainPeriod==='year')v=safeNum(weatherData.precipitacao_anual);
    let displayV=v;
    if(unit==='imperial'&&v!==null)displayV=mm2in(v);
    document.getElementById('rainValue').textContent=displayV!==null?displayV.toFixed(unit==='imperial'?2:1):'--';
}

function displayWeather(d){
    weatherData=d;
    // Dados do banco ja estao em METRICO (C, mm, km/h, hPa)
    const temp=safeNum(d.temperatura);
    const displayTemp=unit==='imperial'&&temp!==null?c2f(temp):temp;
    document.getElementById('currentTemp').textContent=displayTemp!==null?Math.round(displayTemp):'--';
    
    const feels=safeNum(d.sensacao_termica)||temp;
    const displayFeels=unit==='imperial'&&feels!==null?c2f(feels):feels;
    document.getElementById('weatherFeels').textContent='Sensacao: '+(displayFeels!==null?Math.round(displayFeels):'--')+(unit==='metric'?'C':'F');
    
    document.getElementById('detailHumidity').textContent=fmt(d.umidade,0)+'%';
    document.getElementById('detailPressure').textContent=fmt(d.pressao_relativa,0)+' hPa';
    document.getElementById('detailUV').textContent=fmt(d.indice_uv);
    
    const indoor=safeNum(d.temperatura_indoor);
    const displayIndoor=unit==='imperial'&&indoor!==null?c2f(indoor):indoor;
    document.getElementById('detailIndoor').textContent=(displayIndoor!==null?Math.round(displayIndoor):'--')+(unit==='metric'?'C':'F');
    
    const wind=safeNum(d.velocidade_vento);
    const displayWind=unit==='imperial'&&wind!==null?kmh2mph(wind):wind;
    document.getElementById('windSpeed').innerHTML=(displayWind!==null?displayWind.toFixed(1):'--')+' <span style="font-size:12px">'+(unit==='metric'?'km/h':'mph')+'</span>';
    
    const gust=safeNum(d.rajada_vento);
    const displayGust=unit==='imperial'&&gust!==null?kmh2mph(gust):gust;
    document.getElementById('windGust').textContent='Rajada: '+(displayGust!==null?displayGust.toFixed(1):'--');
    
    const dir=safeNum(d.direcao_vento);
    if(dir!==null){
        document.getElementById('windArrow').style.transform='rotate('+dir+'deg)';
        document.getElementById('windDirection').textContent='Dir: '+getWindDir(dir)+' ('+Math.round(dir)+')';
    }
    
    updateRainDisplay();
    
    const cond=getCondition(d);
    document.getElementById('weatherIcon').innerHTML='<i class="fas '+cond.icon+'" style="color:'+cond.color+'"></i>';
    document.getElementById('weatherUpdated').innerHTML='<i class="fas fa-clock"></i> '+(d.coletado_em?new Date(d.coletado_em).toLocaleString('pt-BR'):'--');
}

function getWindDir(deg){const dirs=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return dirs[Math.round(deg/22.5)%16]}
function getCondition(d){
    const rain=safeNum(d.taxa_precipitacao)||0,hum=safeNum(d.umidade)||0,uv=safeNum(d.indice_uv)||0;
    if(rain>5)return{icon:'fa-cloud-showers-heavy',color:'#3b82f6'};
    if(rain>0)return{icon:'fa-cloud-rain',color:'#60a5fa'};
    if(hum>90)return{icon:'fa-cloud',color:'#94a3b8'};
    if(hum>70)return{icon:'fa-cloud-sun',color:'#fbbf24'};
    if(uv>8)return{icon:'fa-sun',color:'#f59e0b'};
    return{icon:'fa-sun',color:'#fcd34d'};
}

// ============ SYNC MANUAL (apenas recarrega do banco) ============
async function syncEcowitt(){
    if(!currentEst){toast('Selecione estacao','error');return}
    const st=document.getElementById('syncStatus'),btn=document.getElementById('syncBtn');
    st.style.display='flex';st.className='sync-status syncing';st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Recarregando...';btn.disabled=true;
    
    try{
        // Recarregar dados do banco
        const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',currentEst.id).order('coletado_em',{ascending:false}).limit(1);
        if(data&&data.length){
            estacoesData[currentEst.id]=data[0];
            displayWeather(data[0]);
        }
        await updateMapMarkers();
        
        st.className='sync-status success';
        st.innerHTML='<i class="fas fa-check-circle"></i> Dados atualizados do servidor!';
        toast('Dados recarregados','success');
        setTimeout(()=>st.style.display='none',3000);
    }catch(err){
        console.error(err);
        st.className='sync-status error';st.innerHTML='<i class="fas fa-exclamation-triangle"></i> '+err.message;
        toast('Erro: '+err.message,'error');
    }
    btn.disabled=false;
}

// ============ IMPORTAR HISTÓRICO ============
async function importHistory(){
    if(!currentEst){toast('Selecione uma estação','error');return}
    
    const months = prompt('Quantos meses de histórico deseja importar?', '12');
    if(!months) return;
    
    const monthsNum = parseInt(months);
    if(isNaN(monthsNum) || monthsNum < 1 || monthsNum > 24){
        toast('Digite um número entre 1 e 24','error');
        return;
    }
    
    const st=document.getElementById('syncStatus'),btn=document.getElementById('historyBtn');
    st.style.display='flex';st.className='sync-status syncing';
    st.innerHTML='<i class="fas fa-spinner fa-spin"></i> Disparando requisições de histórico...';
    btn.disabled=true;
    
    try{
        // Chamar função do Supabase para importar histórico
        const{data,error}=await sb.rpc('import_full_history',{
            p_estacao_id: currentEst.id,
            p_identificador: currentEst.identificador,
            p_months_back: monthsNum
        });
        
        if(error) throw error;
        
        st.innerHTML='<i class="fas fa-clock"></i> Aguardando respostas... (10s)';
        
        // Aguardar respostas chegarem
        await new Promise(r=>setTimeout(r,10000));
        
        // Processar respostas
        st.innerHTML='<i class="fas fa-cogs"></i> Processando histórico...';
        
        const{data:processData,error:processError}=await sb.rpc('process_history_response');
        
        if(processError) throw processError;
        
        st.className='sync-status success';
        st.innerHTML='<i class="fas fa-check-circle"></i> Histórico importado! ' + (processData?.imported || 0) + ' registros.';
        toast('Histórico importado com sucesso!','success');
        
        // Recarregar dados
        loadHistory();
        
        setTimeout(()=>st.style.display='none',5000);
    }catch(err){
        console.error(err);
        st.className='sync-status error';
        st.innerHTML='<i class="fas fa-exclamation-triangle"></i> '+err.message;
        toast('Erro: '+err.message,'error');
    }
    btn.disabled=false;
}

// ============ HISTORICO ============
function initChart(){
    const ctx=document.getElementById('historyChart').getContext('2d');
    chart=new Chart(ctx,{
        type:'line',
        data:{labels:[],datasets:[
            {label:'Temp',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,.1)',fill:true,yAxisID:'y',tension:.4},
            {label:'Chuva',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.5)',type:'bar',yAxisID:'y1'}
        ]},
        options:{
            responsive:true,maintainAspectRatio:false,
            interaction:{intersect:false,mode:'index'},
            plugins:{legend:{labels:{color:'#94a3b8'}}},
            scales:{
                x:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}},
                y:{position:'left',ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}},
                y1:{position:'right',ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}
            }
        }
    });
}

async function loadHistory(){
    if(!currentEst)return;
    const s=document.getElementById('dateStart').value,e=document.getElementById('dateEnd').value;
    if(!s||!e)return;
    const{data}=await sb.from('estacao_dados').select('*').eq('estacao_id',currentEst.id).gte('coletado_em',s+'T00:00:00').lte('coletado_em',e+'T23:59:59').order('coletado_em',{ascending:true});
    if(!data||!data.length){chart.data.labels=[];chart.data.datasets[0].data=[];chart.data.datasets[1].data=[];chart.update();return}
    
    const daily={};
    data.forEach(d=>{
        const day=d.coletado_em.split('T')[0];
        if(!daily[day])daily[day]={temps:[],rain:0,hum:[],wind:[]};
        const t=safeNum(d.temperatura),r=safeNum(d.precipitacao_diaria),h=safeNum(d.umidade),w=safeNum(d.velocidade_vento);
        if(t!==null)daily[day].temps.push(t);
        if(r!==null)daily[day].rain=Math.max(daily[day].rain,r);
        if(h!==null)daily[day].hum.push(h);
        if(w!==null)daily[day].wind.push(w);
    });
    
    const labels=Object.keys(daily).map(d=>new Date(d+'T12:00:00').toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}));
    let temps=Object.values(daily).map(d=>d.temps.length?d.temps.reduce((a,b)=>a+b,0)/d.temps.length:null);
    let rain=Object.values(daily).map(d=>d.rain);
    
    if(unit==='imperial'){temps=temps.map(t=>t!==null?c2f(t):null);rain=rain.map(r=>r!==null?mm2in(r):null)}
    
    chart.data.labels=labels;
    chart.data.datasets[0].data=temps;
    chart.data.datasets[0].label=unit==='metric'?'Temp (C)':'Temp (F)';
    chart.data.datasets[1].data=rain;
    chart.data.datasets[1].label=unit==='metric'?'Chuva (mm)':'Chuva (in)';
    chart.update();
    
    const allT=data.map(d=>safeNum(d.temperatura)).filter(t=>t!==null);
    const allH=data.map(d=>safeNum(d.umidade)).filter(h=>h!==null);
    const allW=data.map(d=>safeNum(d.velocidade_vento)).filter(w=>w!==null);
    const totR=rain.reduce((a,b)=>a+(b||0),0);
    
    document.getElementById('summaryRain').textContent=totR.toFixed(unit==='imperial'?2:1)+(unit==='metric'?' mm':' in');
    let avgT=allT.length?allT.reduce((a,b)=>a+b,0)/allT.length:null;
    if(unit==='imperial'&&avgT!==null)avgT=c2f(avgT);
    document.getElementById('summaryTemp').textContent=(avgT!==null?avgT.toFixed(1):'--')+(unit==='metric'?' C':' F');
    document.getElementById('summaryHumidity').textContent=allH.length?(allH.reduce((a,b)=>a+b,0)/allH.length).toFixed(0)+'%':'--%';
    let avgW=allW.length?allW.reduce((a,b)=>a+b,0)/allW.length:null;
    if(unit==='imperial'&&avgW!==null)avgW=kmh2mph(avgW);
    document.getElementById('summaryWind').textContent=(avgW!==null?avgW.toFixed(1):'--')+(unit==='metric'?' km/h':' mph');
}

function toast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),4000)}
</script>
</body>
</html>

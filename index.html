<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}.app-container{display:flex;min-height:100vh}.sidebar{width:260px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;z-index:100;display:flex;flex-direction:column}.sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.sidebar-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}.sidebar-brand{font-size:20px;font-weight:700;color:var(--primary)}.sidebar-user{padding:15px 20px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text-secondary)}.sidebar-user span{color:var(--text-primary);font-weight:500}.sidebar-nav{flex:1;padding:15px 0}.nav-section{padding:0 15px;margin-bottom:20px}.nav-section-title{font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;padding:10px 10px 5px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;transition:all .2s;margin-bottom:2px}.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--primary);color:white}.nav-item i{width:20px;text-align:center}.main-content{flex:1;margin-left:260px;padding:20px}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}.page-title{font-size:24px;font-weight:600}.estacao-selector{display:flex;gap:15px;align-items:center;flex-wrap:wrap}.estacao-select{padding:10px 15px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);min-width:280px;font-size:14px}.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;display:inline-flex;align-items:center;gap:8px;transition:all .2s}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}.dashboard-grid{display:grid;grid-template-columns:1fr 380px;gap:20px;margin-bottom:20px}.map-container{background:var(--bg-card);border-radius:12px;overflow:hidden;height:450px;position:relative}#map{width:100%;height:100%}.map-controls{position:absolute;top:10px;right:10px;z-index:1000;display:flex;flex-direction:column;gap:5px}.map-control-btn{background:var(--bg-dark);border:1px solid var(--border);color:var(--text-primary);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px}.map-control-btn.active{background:var(--primary);border-color:var(--primary)}.weather-widget{background:linear-gradient(135deg,var(--bg-card),var(--bg-dark));border-radius:12px;padding:20px}.weather-widget-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px}.weather-location{font-size:14px;color:var(--text-secondary)}.weather-station-name{font-size:16px;font-weight:600}.weather-wind{text-align:right}.weather-wind-speed{font-size:20px;font-weight:600}.weather-wind-direction{font-size:12px;color:var(--text-secondary)}.weather-main{text-align:center;padding:20px 0;border-bottom:1px solid var(--border)}.weather-icon{font-size:48px;margin-bottom:10px}.weather-condition{font-size:14px;color:var(--text-secondary);margin-bottom:10px}.weather-temp{font-size:64px;font-weight:300;line-height:1}.weather-feels{font-size:13px;color:var(--text-secondary);margin-top:5px}.weather-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:15px 0;border-bottom:1px solid var(--border)}.weather-stat{text-align:center}.weather-stat-icon{font-size:16px;color:var(--primary);margin-bottom:5px}.weather-stat-value{font-size:14px;font-weight:600}.weather-stat-label{font-size:11px;color:var(--text-secondary)}.weather-extra{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:15px 0;border-bottom:1px solid var(--border)}.weather-extra-item{display:flex;align-items:center;gap:8px;font-size:13px}.weather-extra-item i{color:var(--primary);width:16px}.wind-rose-container{display:flex;align-items:center;gap:20px;padding:15px;background:var(--bg-darker);border-radius:8px;margin-top:15px}.wind-rose{width:80px;height:80px;position:relative}.wind-rose-bg{position:absolute;width:100%;height:100%;border-radius:50%;border:2px solid var(--border)}.wind-rose-arrow{position:absolute;top:50%;left:50%;width:4px;height:30px;background:var(--primary);transform-origin:bottom center;border-radius:2px;margin-left:-2px;margin-top:-30px}.wind-rose-center{position:absolute;top:50%;left:50%;width:8px;height:8px;background:var(--primary);border-radius:50%;transform:translate(-50%,-50%)}.wind-rose-labels{position:absolute;width:100%;height:100%;font-size:9px;color:var(--text-secondary)}.wind-rose-labels span{position:absolute}.wind-rose-labels .n{top:2px;left:50%;transform:translateX(-50%)}.wind-rose-labels .s{bottom:2px;left:50%;transform:translateX(-50%)}.wind-rose-labels .e{right:2px;top:50%;transform:translateY(-50%)}.wind-rose-labels .w{left:2px;top:50%;transform:translateY(-50%)}.weather-updated{text-align:center;font-size:11px;color:var(--text-secondary);margin-top:10px}.history-section{background:var(--bg-card);border-radius:12px;padding:20px}.history-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}.history-filters{display:flex;gap:15px;align-items:center;flex-wrap:wrap}.date-input{padding:8px 12px;background:var(--bg-dark);border:1px solid var(--border);border-radius:6px;color:var(--text-primary)}.chart-container{height:300px;margin-bottom:20px}.summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}.summary-card{background:var(--bg-dark);border-radius:8px;padding:15px}.summary-card-title{font-size:12px;color:var(--text-secondary);margin-bottom:8px}.summary-card-value{font-size:24px;font-weight:600}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:1000}.modal-overlay.hidden{display:none}.modal{background:var(--bg-dark);border-radius:16px;padding:40px;width:100%;max-width:400px;border:1px solid var(--border)}.modal-logo{text-align:center;margin-bottom:30px}.modal-logo i{font-size:48px;background:linear-gradient(135deg,var(--primary),var(--secondary));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.modal-logo h1{font-size:28px;font-weight:700;margin-top:10px;color:var(--primary)}.modal-logo p{color:var(--text-secondary);font-size:14px}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-size:14px;color:var(--text-secondary)}.form-group input{width:100%;padding:12px 15px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px}.form-group input:focus{outline:none;border-color:var(--primary)}.btn-block{width:100%;justify-content:center}.toast{position:fixed;top:20px;right:20px;padding:15px 25px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000}.toast.error{border-color:var(--danger)}.toast.success{border-color:var(--success)}.sync-status{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text-secondary);padding:10px 15px;background:var(--bg-card);border-radius:8px}.sync-status.syncing{color:var(--warning)}.sync-status.success{color:var(--success);background:rgba(34,197,94,.1)}.sync-status.error{color:var(--danger);background:rgba(239,68,68,.1)}.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px;margin-bottom:20px}.kpi-card{background:var(--bg-card);border-radius:12px;padding:20px;text-align:center}.kpi-icon{font-size:24px;margin-bottom:10px}.kpi-value{font-size:28px;font-weight:700}.kpi-label{font-size:12px;color:var(--text-secondary);margin-top:5px}.kpi-card.temp .kpi-icon{color:var(--warning)}.kpi-card.humidity .kpi-icon{color:var(--info)}.kpi-card.rain .kpi-icon{color:var(--secondary)}.kpi-card.wind .kpi-icon{color:var(--success)}.kpi-card.pressure .kpi-icon{color:#8b5cf6}.kpi-card.uv .kpi-icon{color:var(--danger)}@media(max-width:1024px){.dashboard-grid{grid-template-columns:1fr}}@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
    </style>
</head>
<body>
    <div class="modal-overlay" id="loginModal">
        <div class="modal">
            <div class="modal-logo"><i class="fas fa-cloud-sun-rain"></i><h1>Aguaten</h1><p>Sistema de Monitoramento Meteorológico</p></div>
            <form id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="loginEmail" required placeholder="seu@email.com"></div>
                <div class="form-group"><label>Senha</label><input type="password" id="loginPassword" required placeholder="••••••••"></div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-sign-in-alt"></i> Entrar</button>
            </form>
            <p style="text-align:center;margin-top:20px;font-size:13px;color:var(--text-secondary)">Não tem conta? <a href="#" onclick="toggleRegister()" style="color:var(--primary)">Cadastre-se</a></p>
            <form id="registerForm" style="display:none">
                <div class="form-group"><label>Nome</label><input type="text" id="registerName" required placeholder="Seu nome"></div>
                <div class="form-group"><label>Email</label><input type="email" id="registerEmail" required placeholder="seu@email.com"></div>
                <div class="form-group"><label>Senha</label><input type="password" id="registerPassword" required minlength="6" placeholder="Mínimo 6 caracteres"></div>
                <button type="submit" class="btn btn-primary btn-block"><i class="fas fa-user-plus"></i> Cadastrar</button>
                <p style="text-align:center;margin-top:15px;font-size:13px;color:var(--text-secondary)">Já tem conta? <a href="#" onclick="toggleRegister()" style="color:var(--primary)">Entrar</a></p>
            </form>
        </div>
    </div>
    
    <div class="app-container" id="appContainer" style="display:none">
        <aside class="sidebar"><div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-cloud-sun-rain"></i></div><span class="sidebar-brand">Aguaten</span></div><div class="sidebar-user">Olá, <span id="userName">Usuário</span></div><nav class="sidebar-nav"><div class="nav-section"><div class="nav-section-title">Principal</div><a href="index.html" class="nav-item active"><i class="fas fa-chart-line"></i> Dashboard</a><a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> Relatórios</a></div><div class="nav-section" id="adminSection" style="display:none"><div class="nav-section-title">Administrativo</div><a href="admin.html" class="nav-item"><i class="fas fa-users-cog"></i> Administração</a></div><div class="nav-section"><div class="nav-section-title">Outros</div><a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></div></nav></aside>
        
        <main class="main-content">
            <div class="page-header"><h1 class="page-title">Dashboard</h1><div class="estacao-selector"><select class="estacao-select" id="estacaoSelect" onchange="loadEstacaoData()"><option value="">Selecione...</option></select><button class="btn btn-primary" onclick="syncEcowitt()" id="syncBtn"><i class="fas fa-sync-alt"></i> Sincronizar</button></div></div>
            <div id="syncStatus" class="sync-status" style="margin-bottom:15px;display:none"></div>
            <div class="kpi-grid">
                <div class="kpi-card temp"><div class="kpi-icon"><i class="fas fa-thermometer-half"></i></div><div class="kpi-value" id="kpiTemp">--°C</div><div class="kpi-label">Temperatura</div></div>
                <div class="kpi-card humidity"><div class="kpi-icon"><i class="fas fa-tint"></i></div><div class="kpi-value" id="kpiHumidity">--%</div><div class="kpi-label">Umidade</div></div>
                <div class="kpi-card rain"><div class="kpi-icon"><i class="fas fa-cloud-rain"></i></div><div class="kpi-value" id="kpiRain">-- mm</div><div class="kpi-label">Chuva Hoje</div></div>
                <div class="kpi-card wind"><div class="kpi-icon"><i class="fas fa-wind"></i></div><div class="kpi-value" id="kpiWind">-- km/h</div><div class="kpi-label">Vento</div></div>
                <div class="kpi-card pressure"><div class="kpi-icon"><i class="fas fa-tachometer-alt"></i></div><div class="kpi-value" id="kpiPressure">-- hPa</div><div class="kpi-label">Pressão</div></div>
                <div class="kpi-card uv"><div class="kpi-icon"><i class="fas fa-sun"></i></div><div class="kpi-value" id="kpiUV">--</div><div class="kpi-label">Índice UV</div></div>
            </div>
            <div class="dashboard-grid">
                <div class="map-container"><div id="map"></div><div class="map-controls"><button class="map-control-btn" onclick="setMapLayer('street')" id="btn-street">Mapa</button><button class="map-control-btn active" onclick="setMapLayer('satellite')" id="btn-satellite">Satélite</button><button class="map-control-btn" onclick="setMapLayer('terrain')" id="btn-terrain">Terreno</button></div></div>
                <div class="weather-widget">
                    <div class="weather-widget-header"><div><div class="weather-station-name" id="weatherStationName">--</div><div class="weather-location" id="weatherLocation">Selecione uma estação</div></div><div class="weather-wind"><div class="weather-wind-speed" id="windSpeed">-- Km/h</div><div class="weather-wind-direction" id="windGust">Rajada: --</div></div></div>
                    <div class="weather-main"><div class="weather-icon" id="weatherIcon"><i class="fas fa-cloud-sun"></i></div><div class="weather-condition" id="weatherCondition">--</div><div class="weather-temp"><span id="currentTemp">--</span>°C</div><div class="weather-feels" id="weatherFeels">Sensação: --°C</div></div>
                    <div class="weather-stats"><div class="weather-stat"><div class="weather-stat-icon"><i class="fas fa-tint"></i></div><div class="weather-stat-value" id="statHumidity">--%</div><div class="weather-stat-label">Umidade</div></div><div class="weather-stat"><div class="weather-stat-icon"><i class="fas fa-cloud-rain"></i></div><div class="weather-stat-value" id="statRain">--</div><div class="weather-stat-label">Chuva</div></div><div class="weather-stat"><div class="weather-stat-icon"><i class="fas fa-tachometer-alt"></i></div><div class="weather-stat-value" id="statPressure">--</div><div class="weather-stat-label">Pressão</div></div></div>
                    <div class="weather-extra"><div class="weather-extra-item"><i class="fas fa-sun"></i> UV: <strong id="extraUV">--</strong></div><div class="weather-extra-item"><i class="fas fa-solar-panel"></i> Solar: <strong id="extraSolar">--</strong></div><div class="weather-extra-item"><i class="fas fa-water"></i> Orvalho: <strong id="extraDew">--</strong>°C</div><div class="weather-extra-item"><i class="fas fa-home"></i> Indoor: <strong id="extraIndoor">--</strong>°C</div></div>
                    <div class="wind-rose-container"><div class="wind-rose"><div class="wind-rose-bg"></div><div class="wind-rose-arrow" id="windArrow"></div><div class="wind-rose-center"></div><div class="wind-rose-labels"><span class="n">N</span><span class="s">S</span><span class="e">E</span><span class="w">O</span></div></div><div><div style="font-size:12px;color:var(--text-secondary)">Direção do Vento</div><div style="font-size:18px;font-weight:600" id="windDirLabel">--</div><div style="font-size:12px;color:var(--text-secondary)" id="windDegrees">--°</div></div></div>
                    <div class="weather-updated" id="weatherUpdated"><i class="fas fa-clock"></i> --</div>
                </div>
            </div>
            <div class="history-section">
                <div class="history-header"><h3 style="font-size:18px;font-weight:600"><i class="fas fa-chart-area" style="color:var(--primary);margin-right:10px"></i>Histórico</h3><div class="history-filters"><input type="date" class="date-input" id="dateStart"><input type="date" class="date-input" id="dateEnd"><button class="btn btn-primary" onclick="loadHistory()"><i class="fas fa-search"></i> Consultar</button></div></div>
                <div class="chart-container"><canvas id="historyChart"></canvas></div>
                <div class="summary-grid"><div class="summary-card"><div class="summary-card-title"><i class="fas fa-cloud-rain" style="color:var(--info)"></i> Precipitação</div><div class="summary-card-value" id="summaryRain">-- mm</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-thermometer-half" style="color:var(--warning)"></i> Temp. Média</div><div class="summary-card-value" id="summaryTemp">--°C</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-tint" style="color:var(--secondary)"></i> Umidade Média</div><div class="summary-card-value" id="summaryHumidity">--%</div></div><div class="summary-card"><div class="summary-card-title"><i class="fas fa-wind" style="color:var(--success)"></i> Vento Médio</div><div class="summary-card-value" id="summaryWind">-- Km/h</div></div></div>
            </div>
        </main>
    </div>
    <script>
        const SUPABASE_URL='https://ltwtqjrojbobfngcryjw.supabase.co';
        const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NjAyODcsImV4cCI6MjA4MjIzNjI4N30.le4b9sZ7jMfpPjPn9FiWK9tpDxnTn0VaCl2vlQv14SA';
        const ECOWITT_APP_KEY='5AF8313E09015663F7DD4BBC211A9F51';
        const ECOWITT_API_KEY='9031e673-f663-4cfb-a268-2dff2e70afbc';
        const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
        let currentUser=null,userProfile=null,estacoes=[],currentEstacao=null,map=null,markers=[],historyChart=null,mapLayers={},currentLayer=null;

        document.addEventListener('DOMContentLoaded',async()=>{const{data:{session}}=await supabaseClient.auth.getSession();if(session){currentUser=session.user;await loadUserProfile();showApp()}else{showLogin()}supabaseClient.auth.onAuthStateChange(async(event,session)=>{if(event==='SIGNED_IN'){currentUser=session.user;await loadUserProfile();showApp()}else if(event==='SIGNED_OUT'){showLogin()}});document.getElementById('loginForm').addEventListener('submit',handleLogin);document.getElementById('registerForm').addEventListener('submit',handleRegister);const today=new Date();document.getElementById('dateEnd').value=today.toISOString().split('T')[0];document.getElementById('dateStart').value=new Date(today.getTime()-7*24*60*60*1000).toISOString().split('T')[0]});

        function showLogin(){document.getElementById('loginModal').classList.remove('hidden');document.getElementById('appContainer').style.display='none'}
        function showApp(){document.getElementById('loginModal').classList.add('hidden');document.getElementById('appContainer').style.display='flex';initializeApp()}
        function toggleRegister(){const l=document.getElementById('loginForm'),r=document.getElementById('registerForm');l.style.display=l.style.display==='none'?'block':'none';r.style.display=r.style.display==='none'?'block':'none'}
        async function handleLogin(e){e.preventDefault();try{const{error}=await supabaseClient.auth.signInWithPassword({email:document.getElementById('loginEmail').value,password:document.getElementById('loginPassword').value});if(error)throw error;showToast('Login realizado!','success')}catch(error){showToast(error.message,'error')}}
        async function handleRegister(e){e.preventDefault();try{const{error}=await supabaseClient.auth.signUp({email:document.getElementById('registerEmail').value,password:document.getElementById('registerPassword').value,options:{data:{primeiro_nome:document.getElementById('registerName').value}}});if(error)throw error;showToast('Conta criada! Faça login.','success');toggleRegister()}catch(error){showToast(error.message,'error')}}
        async function logout(){await supabaseClient.auth.signOut();showLogin()}
        async function loadUserProfile(){const{data}=await supabaseClient.from('perfis').select('*').eq('id',currentUser.id).single();if(data){userProfile=data;document.getElementById('userName').textContent=data.primeiro_nome||data.email.split('@')[0];if(data.is_admin)document.getElementById('adminSection').style.display='block'}}
        async function initializeApp(){initMap();await loadEstacoes();initHistoryChart()}
        function initMap(){map=L.map('map').setView([-25.4284,-54.5934],10);mapLayers.street=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'OSM'});mapLayers.satellite=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{attribution:'Esri'});mapLayers.terrain=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{attribution:'OpenTopoMap'});mapLayers.satellite.addTo(map);currentLayer='satellite'}
        function setMapLayer(layer){if(currentLayer)map.removeLayer(mapLayers[currentLayer]);mapLayers[layer].addTo(map);currentLayer=layer;document.querySelectorAll('.map-control-btn').forEach(btn=>btn.classList.remove('active'));document.getElementById('btn-'+layer).classList.add('active')}
        async function loadEstacoes(){const{data}=await supabaseClient.from('estacoes').select('*').eq('ativo',true);estacoes=data||[];document.getElementById('estacaoSelect').innerHTML='<option value="">Selecione...</option>'+estacoes.map(e=>'<option value="'+e.id+'">'+e.identificador+' - '+(e.nome||e.cidade||'Estação')+'</option>').join('');markers.forEach(m=>map.removeLayer(m));markers=[];estacoes.forEach(est=>{if(est.latitude&&est.longitude){const icon=L.divIcon({className:'',html:'<div style="background:#10b981;color:white;width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;border:3px solid white;box-shadow:0 2px 10px rgba(0,0,0,0.3)"><i class="fas fa-broadcast-tower" style="font-size:12px"></i></div>',iconSize:[30,30],iconAnchor:[15,15]});const marker=L.marker([est.latitude,est.longitude],{icon}).addTo(map).bindPopup('<strong>'+(est.nome||est.identificador)+'</strong><br>'+(est.cidade||''));marker.on('click',()=>{document.getElementById('estacaoSelect').value=est.id;loadEstacaoData()});markers.push(marker)}});if(markers.length>0)map.fitBounds(L.featureGroup(markers).getBounds().pad(0.1));if(estacoes.length>0){document.getElementById('estacaoSelect').value=estacoes[0].id;loadEstacaoData()}}
        async function loadEstacaoData(){const estacaoId=document.getElementById('estacaoSelect').value;if(!estacaoId)return;currentEstacao=estacoes.find(e=>e.id===estacaoId);if(!currentEstacao)return;document.getElementById('weatherStationName').textContent=currentEstacao.nome||currentEstacao.identificador;document.getElementById('weatherLocation').textContent=(currentEstacao.cidade||'')+' - '+(currentEstacao.pais||'');if(currentEstacao.latitude&&currentEstacao.longitude)map.setView([currentEstacao.latitude,currentEstacao.longitude],12);const{data}=await supabaseClient.from('estacao_dados').select('*').eq('estacao_id',estacaoId).order('coletado_em',{ascending:false}).limit(1);if(data&&data.length>0)displayWeatherData(data[0]);else if(currentEstacao.data_cache)displayWeatherData(currentEstacao.data_cache);loadHistory()}
        function safeNumber(val){if(val===null||val===undefined)return null;const num=parseFloat(val);return isNaN(num)?null:num}
        function formatNumber(val,decimals=1){const num=safeNumber(val);return num!==null?num.toFixed(decimals):'--'}
        function displayWeatherData(d){document.getElementById('kpiTemp').textContent=formatNumber(d.temperatura)+'°C';document.getElementById('kpiHumidity').textContent=formatNumber(d.umidade,0)+'%';document.getElementById('kpiRain').textContent=formatNumber(d.precipitacao_diaria)+' mm';document.getElementById('kpiWind').textContent=formatNumber(d.velocidade_vento)+' km/h';document.getElementById('kpiPressure').textContent=formatNumber(d.pressao_relativa)+' hPa';document.getElementById('kpiUV').textContent=formatNumber(d.indice_uv);document.getElementById('currentTemp').textContent=formatNumber(d.temperatura);document.getElementById('weatherFeels').textContent='Sensação: '+formatNumber(d.sensacao_termica||d.temperatura)+'°C';document.getElementById('windSpeed').textContent=formatNumber(d.velocidade_vento)+' Km/h';document.getElementById('windGust').textContent='Rajada: '+formatNumber(d.rajada_vento)+' Km/h';document.getElementById('statHumidity').textContent=formatNumber(d.umidade,0)+'%';document.getElementById('statRain').textContent=formatNumber(d.precipitacao_diaria)+' mm';document.getElementById('statPressure').textContent=formatNumber(d.pressao_relativa)+' hPa';document.getElementById('extraUV').textContent=formatNumber(d.indice_uv);document.getElementById('extraSolar').textContent=formatNumber(d.radiacao_solar,0);document.getElementById('extraDew').textContent=formatNumber(d.ponto_orvalho);document.getElementById('extraIndoor').textContent=formatNumber(d.temperatura_indoor);const windDir=safeNumber(d.direcao_vento);if(windDir!==null){document.getElementById('windArrow').style.transform='rotate('+windDir+'deg)';document.getElementById('windDirLabel').textContent=getWindDirection(windDir);document.getElementById('windDegrees').textContent=windDir+'°'}const cond=getWeatherCondition(d);document.getElementById('weatherCondition').textContent=cond.text;document.getElementById('weatherIcon').innerHTML='<i class="fas '+cond.icon+'" style="color:'+cond.color+'"></i>';const time=d.coletado_em?new Date(d.coletado_em).toLocaleString('pt-BR'):'--';document.getElementById('weatherUpdated').innerHTML='<i class="fas fa-clock"></i> '+time}
        function getWindDirection(deg){if(deg===null)return'--';const dirs=['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];return dirs[Math.round(deg/22.5)%16]}
        function getWeatherCondition(d){const rain=safeNumber(d.taxa_precipitacao)||0;const humidity=safeNumber(d.umidade)||0;const uv=safeNumber(d.indice_uv)||0;if(rain>5)return{text:'Chuva forte',icon:'fa-cloud-showers-heavy',color:'#3b82f6'};if(rain>0)return{text:'Chuva',icon:'fa-cloud-rain',color:'#60a5fa'};if(humidity>90)return{text:'Nublado',icon:'fa-cloud',color:'#94a3b8'};if(humidity>70)return{text:'Parcialmente nublado',icon:'fa-cloud-sun',color:'#fbbf24'};if(uv>8)return{text:'Muito ensolarado',icon:'fa-sun',color:'#f59e0b'};return{text:'Céu limpo',icon:'fa-sun',color:'#fcd34d'}}
        async function syncEcowitt(){if(!currentEstacao){showToast('Selecione uma estação','error');return}const statusEl=document.getElementById('syncStatus');const syncBtn=document.getElementById('syncBtn');statusEl.style.display='flex';statusEl.className='sync-status syncing';statusEl.innerHTML='<i class="fas fa-spinner fa-spin"></i> Sincronizando...';syncBtn.disabled=true;try{const url='https://api.ecowitt.net/api/v3/device/real_time?application_key='+ECOWITT_APP_KEY+'&api_key='+ECOWITT_API_KEY+'&imei='+currentEstacao.identificador+'&call_back=all';const response=await fetch(url);const result=await response.json();if(result.code!==0)throw new Error(result.msg||'Erro API');const data=result.data;const outdoor=data.outdoor||{};const wind=data.wind||{};const rainfall=data.rainfall||{};const pressure=data.pressure||{};const solar=data.solar_and_uvi||{};const indoor=data.indoor||{};const mapped={estacao_id:currentEstacao.id,coletado_em:new Date().toISOString(),temperatura:safeNumber(outdoor.temperature?.value),umidade:safeNumber(outdoor.humidity?.value),sensacao_termica:safeNumber(outdoor.feels_like?.value),ponto_orvalho:safeNumber(outdoor.dew_point?.value),velocidade_vento:safeNumber(wind.wind_speed?.value),direcao_vento:safeNumber(wind.wind_direction?.value),rajada_vento:safeNumber(wind.wind_gust?.value),taxa_precipitacao:safeNumber(rainfall.rain_rate?.value),precipitacao_diaria:safeNumber(rainfall.daily?.value),precipitacao_semanal:safeNumber(rainfall.weekly?.value),precipitacao_mensal:safeNumber(rainfall.monthly?.value),precipitacao_anual:safeNumber(rainfall.yearly?.value),radiacao_solar:safeNumber(solar.solar?.value),indice_uv:safeNumber(solar.uvi?.value),pressao_relativa:safeNumber(pressure.relative?.value),pressao_absoluta:safeNumber(pressure.absolute?.value),temperatura_indoor:safeNumber(indoor.temperature?.value),umidade_indoor:safeNumber(indoor.humidity?.value)};const{error}=await supabaseClient.from('estacao_dados').insert(mapped);if(error)throw error;await supabaseClient.from('estacoes').update({data_cache:mapped,ultima_sincronizacao:new Date().toISOString()}).eq('id',currentEstacao.id);await supabaseClient.from('station_server_logs').insert({tipo:'sucesso',identificador:currentEstacao.identificador,log:'Sincronização manual',dados_raw:result.data});statusEl.className='sync-status success';statusEl.innerHTML='<i class="fas fa-check-circle"></i> Sincronizado!';displayWeatherData(mapped);showToast('Dados sincronizados!','success');setTimeout(()=>{statusEl.style.display='none'},5000)}catch(err){console.error(err);statusEl.className='sync-status error';statusEl.innerHTML='<i class="fas fa-exclamation-triangle"></i> Erro: '+err.message;await supabaseClient.from('station_server_logs').insert({tipo:'erro',identificador:currentEstacao?.identificador,log:err.message});showToast('Erro: '+err.message,'error')}syncBtn.disabled=false}
        function initHistoryChart(){const ctx=document.getElementById('historyChart').getContext('2d');historyChart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Temperatura (°C)',data:[],borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',fill:true,yAxisID:'y',tension:0.4},{label:'Precipitação (mm)',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.5)',type:'bar',yAxisID:'y1'}]},options:{responsive:true,maintainAspectRatio:false,interaction:{intersect:false,mode:'index'},plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,0.05)'}},y:{position:'left',title:{display:true,text:'Temp (°C)',color:'#94a3b8'},ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,0.05)'}},y1:{position:'right',title:{display:true,text:'Chuva (mm)',color:'#94a3b8'},ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}}}})}
        async function loadHistory(){if(!currentEstacao)return;const start=document.getElementById('dateStart').value;const end=document.getElementById('dateEnd').value;if(!start||!end)return;const{data}=await supabaseClient.from('estacao_dados').select('*').eq('estacao_id',currentEstacao.id).gte('coletado_em',start+'T00:00:00').lte('coletado_em',end+'T23:59:59').order('coletado_em',{ascending:true});if(!data||data.length===0)return;const daily={};data.forEach(d=>{const day=d.coletado_em.split('T')[0];if(!daily[day])daily[day]={temps:[],rain:0,humidity:[],wind:[]};const temp=safeNumber(d.temperatura);const rain=safeNumber(d.precipitacao_diaria);const hum=safeNumber(d.umidade);const wnd=safeNumber(d.velocidade_vento);if(temp!==null)daily[day].temps.push(temp);if(rain!==null)daily[day].rain=Math.max(daily[day].rain,rain);if(hum!==null)daily[day].humidity.push(hum);if(wnd!==null)daily[day].wind.push(wnd)});const labels=Object.keys(daily).map(d=>new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}));const temps=Object.values(daily).map(d=>d.temps.length?d.temps.reduce((a,b)=>a+b,0)/d.temps.length:null);const rain=Object.values(daily).map(d=>d.rain);historyChart.data.labels=labels;historyChart.data.datasets[0].data=temps;historyChart.data.datasets[1].data=rain;historyChart.update();const allTemps=data.filter(d=>safeNumber(d.temperatura)!==null).map(d=>safeNumber(d.temperatura));const allHumidity=data.filter(d=>safeNumber(d.umidade)!==null).map(d=>safeNumber(d.umidade));const allWind=data.filter(d=>safeNumber(d.velocidade_vento)!==null).map(d=>safeNumber(d.velocidade_vento));const totalRain=rain.reduce((a,b)=>a+b,0);document.getElementById('summaryRain').textContent=totalRain.toFixed(1)+' mm';document.getElementById('summaryTemp').textContent=allTemps.length?(allTemps.reduce((a,b)=>a+b,0)/allTemps.length).toFixed(1)+'°C':'--';document.getElementById('summaryHumidity').textContent=allHumidity.length?(allHumidity.reduce((a,b)=>a+b,0)/allHumidity.length).toFixed(0)+'%':'--';document.getElementById('summaryWind').textContent=allWind.length?(allWind.reduce((a,b)=>a+b,0)/allWind.length).toFixed(1)+' Km/h':'--'}
        function showToast(msg,type='info'){const toast=document.createElement('div');toast.className='toast '+type;toast.textContent=msg;document.body.appendChild(toast);setTimeout(()=>toast.remove(),4000)}
    </script>
</body>
</html>

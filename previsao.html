<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Previsão do Tempo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}
        .app-container{display:flex;min-height:100vh}.sidebar{width:240px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;z-index:100;display:flex;flex-direction:column}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.sidebar-logo{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:8px;display:flex;align-items:center;justify-content:center}.sidebar-brand{font-size:18px;font-weight:700;color:var(--primary)}
        .sidebar-nav{flex:1;padding:15px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;margin-bottom:4px}.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--primary);color:white}.nav-item i{width:20px}
        .main-content{flex:1;margin-left:240px;padding:20px}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}.page-title{font-size:22px;font-weight:600}
        .header-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .search-box{display:flex;gap:8px;align-items:center}.search-input{padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:13px;width:280px}.search-input:focus{outline:none;border-color:var(--primary)}
        .btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}.btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}
        .unit-toggle{display:flex;background:var(--bg-card);border-radius:6px;overflow:hidden}.unit-btn{padding:8px 14px;border:none;background:transparent;color:var(--text-secondary);cursor:pointer;font-size:12px}.unit-btn.active{background:var(--primary);color:white}
        .location-info{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px;display:flex;align-items:center;gap:20px}
        .location-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;color:white}
        .location-details h2{font-size:24px;font-weight:600}.location-details p{color:var(--text-secondary);font-size:13px;margin-top:4px}
        .current-weather{background:linear-gradient(135deg,var(--bg-card),var(--bg-dark));border-radius:12px;padding:25px;margin-bottom:20px}
        .current-main{display:flex;align-items:center;gap:30px;margin-bottom:20px}
        .current-icon{font-size:72px}.current-temp{font-size:64px;font-weight:300}.current-details{flex:1}
        .current-condition{font-size:18px;font-weight:500;margin-bottom:8px}.current-feels{font-size:13px;color:var(--text-secondary)}
        .current-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:15px}
        .stat-item{background:var(--bg-dark);border-radius:8px;padding:15px;text-align:center}.stat-icon{font-size:20px;margin-bottom:8px}.stat-value{font-size:20px;font-weight:600}.stat-label{font-size:11px;color:var(--text-secondary);margin-top:4px}
        .stat-item.temp .stat-icon{color:var(--warning)}.stat-item.humidity .stat-icon{color:var(--info)}.stat-item.wind .stat-icon{color:var(--success)}.stat-item.pressure .stat-icon{color:#8b5cf6}.stat-item.rain .stat-icon{color:var(--secondary)}.stat-item.uv .stat-icon{color:var(--danger)}
        .forecast-section{margin-bottom:20px}
        .section-title{font-size:18px;font-weight:600;margin-bottom:15px;display:flex;align-items:center;gap:10px}.section-title i{color:var(--primary)}
        .daily-forecast{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:12px}
        .day-card{background:var(--bg-card);border-radius:12px;padding:18px;text-align:center;transition:transform .2s}.day-card:hover{transform:translateY(-3px)}
        .day-name{font-size:13px;font-weight:600;margin-bottom:8px}.day-date{font-size:11px;color:var(--text-secondary);margin-bottom:12px}
        .day-icon{font-size:32px;margin-bottom:10px}
        .day-temps{display:flex;justify-content:center;gap:12px;font-size:14px}.day-high{color:var(--danger);font-weight:600}.day-low{color:var(--info)}
        .day-rain{font-size:11px;color:var(--secondary);margin-top:8px}
        .hourly-section{background:var(--bg-card);border-radius:12px;padding:20px;margin-bottom:20px}
        .hourly-scroll{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px}
        .hour-card{min-width:80px;background:var(--bg-dark);border-radius:10px;padding:12px;text-align:center;flex-shrink:0}
        .hour-time{font-size:12px;font-weight:500;margin-bottom:8px}.hour-icon{font-size:24px;margin-bottom:6px}.hour-temp{font-size:16px;font-weight:600}.hour-rain{font-size:10px;color:var(--secondary);margin-top:4px}
        .chart-section{background:var(--bg-card);border-radius:12px;padding:20px}.chart-container{height:280px}
        .toast{position:fixed;top:20px;right:20px;padding:12px 20px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000;font-size:13px}.toast.error{border-color:var(--danger)}.toast.success{border-color:var(--success)}
        .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--text-secondary)}
        .suggestions{position:absolute;top:100%;left:0;right:0;background:var(--bg-dark);border:1px solid var(--border);border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:10;display:none}
        .suggestions.show{display:block}
        .suggestion-item{padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border)}.suggestion-item:hover{background:var(--bg-card)}.suggestion-item:last-child{border-bottom:none}
        .search-wrapper{position:relative}
        @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}.current-main{flex-direction:column;text-align:center}}
    </style>
</head>
<body>
<div class="app-container">
<aside class="sidebar"><div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-cloud-sun-rain" style="color:white;font-size:16px"></i></div><span class="sidebar-brand">Aguaten</span></div><nav class="sidebar-nav"><a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i> Dashboard</a><a href="previsao.html" class="nav-item active"><i class="fas fa-cloud-sun"></i> Previsão</a><a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> Relatórios</a><a href="admin.html" class="nav-item" id="adminLink" style="display:none"><i class="fas fa-cog"></i> Admin</a><a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></nav></aside>
<main class="main-content">
<div class="page-header">
<h1 class="page-title"><i class="fas fa-cloud-sun" style="color:var(--primary)"></i> Previsão do Tempo</h1>
<div class="header-controls">
<div class="search-wrapper">
<div class="search-box"><input type="text" class="search-input" id="searchCity" placeholder="Buscar cidade..." onkeyup="searchCities(event)"><button class="btn btn-primary" onclick="searchWeather()"><i class="fas fa-search"></i></button></div>
<div class="suggestions" id="suggestions"></div>
</div>
<div class="unit-toggle"><button class="unit-btn active" onclick="setUnit('metric')" id="btn-metric">°C</button><button class="unit-btn" onclick="setUnit('imperial')" id="btn-imperial">°F</button></div>
<button class="btn btn-secondary" onclick="useStationLocation()"><i class="fas fa-broadcast-tower"></i> Usar Estação</button>
</div>
</div>

<div class="location-info" id="locationInfo" style="display:none">
<div class="location-icon"><i class="fas fa-map-marker-alt"></i></div>
<div class="location-details"><h2 id="locationName">--</h2><p id="locationCoords">--</p></div>
</div>

<div class="current-weather" id="currentWeather" style="display:none">
<div class="current-main">
<div class="current-icon" id="currentIcon"><i class="fas fa-sun" style="color:var(--warning)"></i></div>
<div><div class="current-temp"><span id="currentTemp">--</span><span style="font-size:24px" id="tempUnit">°C</span></div><div class="current-feels" id="currentFeels">Sensação: --</div></div>
<div class="current-details"><div class="current-condition" id="currentCondition">--</div><div class="current-feels">Atualizado: <span id="currentTime">--</span></div></div>
</div>
<div class="current-stats">
<div class="stat-item humidity"><div class="stat-icon"><i class="fas fa-tint"></i></div><div class="stat-value" id="statHumidity">--%</div><div class="stat-label">Umidade</div></div>
<div class="stat-item wind"><div class="stat-icon"><i class="fas fa-wind"></i></div><div class="stat-value" id="statWind">--</div><div class="stat-label">Vento</div></div>
<div class="stat-item pressure"><div class="stat-icon"><i class="fas fa-tachometer-alt"></i></div><div class="stat-value" id="statPressure">--</div><div class="stat-label">Pressão</div></div>
<div class="stat-item rain"><div class="stat-icon"><i class="fas fa-cloud-rain"></i></div><div class="stat-value" id="statRain">--</div><div class="stat-label">Precipitação</div></div>
<div class="stat-item uv"><div class="stat-icon"><i class="fas fa-sun"></i></div><div class="stat-value" id="statUV">--</div><div class="stat-label">Índice UV</div></div>
<div class="stat-item temp"><div class="stat-icon"><i class="fas fa-cloud"></i></div><div class="stat-value" id="statCloud">--%</div><div class="stat-label">Nebulosidade</div></div>
</div>
</div>

<div class="hourly-section" id="hourlySection" style="display:none">
<div class="section-title"><i class="fas fa-clock"></i> Próximas 24 Horas</div>
<div class="hourly-scroll" id="hourlyScroll"></div>
</div>

<div class="forecast-section" id="forecastSection" style="display:none">
<div class="section-title"><i class="fas fa-calendar-alt"></i> Previsão 7 Dias</div>
<div class="daily-forecast" id="dailyForecast"></div>
</div>

<div class="chart-section" id="chartSection" style="display:none">
<div class="section-title"><i class="fas fa-chart-line"></i> Gráfico de Temperatura</div>
<div class="chart-container"><canvas id="forecastChart"></canvas></div>
</div>

<div class="loading" id="loading" style="display:none"><i class="fas fa-spinner fa-spin" style="font-size:24px;margin-right:10px"></i> Carregando previsão...</div>
</main>
</div>
<script>
const SUPABASE_URL='https://ltwtqjrojbobfngcryjw.supabase.co',SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NjAyODcsImV4cCI6MjA4MjIzNjI4N30.le4b9sZ7jMfpPjPn9FiWK9tpDxnTn0VaCl2vlQv14SA';
const sb=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
let unit='metric',chart=null,estacoes=[];

document.addEventListener('DOMContentLoaded',async()=>{const{data:{session}}=await sb.auth.getSession();if(!session){window.location.href='index.html';return}await loadEstacoes();initChart()});

async function loadEstacoes(){const{data}=await sb.from('estacoes').select('*').eq('ativo',true);estacoes=data||[];if(estacoes.length&&estacoes[0].latitude&&estacoes[0].longitude){loadForecast(estacoes[0].latitude,estacoes[0].longitude,estacoes[0].nome||estacoes[0].cidade||'Estação')}}

async function searchCities(e){const q=document.getElementById('searchCity').value;if(q.length<3){document.getElementById('suggestions').classList.remove('show');return}if(e.key==='Enter'){searchWeather();return}try{const res=await fetch('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=5&language=pt');const data=await res.json();const el=document.getElementById('suggestions');if(data.results&&data.results.length){el.innerHTML=data.results.map(r=>'<div class="suggestion-item" onclick="selectCity('+r.latitude+','+r.longitude+',\''+r.name+(r.admin1?', '+r.admin1:'')+(r.country?', '+r.country:'')+'\')"><i class="fas fa-map-marker-alt" style="margin-right:8px;color:var(--primary)"></i>'+r.name+(r.admin1?', '+r.admin1:'')+(r.country?' ('+r.country_code+')':'')+'</div>').join('');el.classList.add('show')}else{el.classList.remove('show')}}catch(err){console.error(err)}}

function selectCity(lat,lon,name){document.getElementById('suggestions').classList.remove('show');document.getElementById('searchCity').value=name;loadForecast(lat,lon,name)}

async function searchWeather(){const q=document.getElementById('searchCity').value;if(!q)return;try{const res=await fetch('https://geocoding-api.open-meteo.com/v1/search?name='+encodeURIComponent(q)+'&count=1&language=pt');const data=await res.json();if(data.results&&data.results.length){const r=data.results[0];loadForecast(r.latitude,r.longitude,r.name+(r.admin1?', '+r.admin1:''))}else{toast('Cidade não encontrada','error')}}catch(err){toast('Erro na busca','error')}}

function useStationLocation(){if(estacoes.length&&estacoes[0].latitude){const e=estacoes[0];loadForecast(e.latitude,e.longitude,e.nome||e.cidade||'Estação');document.getElementById('searchCity').value=e.nome||e.cidade||'Estação'}else{toast('Nenhuma estação com coordenadas','error')}}

async function loadForecast(lat,lon,name){document.getElementById('loading').style.display='flex';['locationInfo','currentWeather','hourlySection','forecastSection','chartSection'].forEach(id=>document.getElementById(id).style.display='none');
try{const params=new URLSearchParams({latitude:lat,longitude:lon,current:'temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,rain,weather_code,cloud_cover,pressure_msl,wind_speed_10m,wind_direction_10m,uv_index',hourly:'temperature_2m,precipitation_probability,weather_code,wind_speed_10m',daily:'weather_code,temperature_2m_max,temperature_2m_min,precipitation_sum,precipitation_probability_max,sunrise,sunset',timezone:'America/Sao_Paulo',forecast_days:7});
const res=await fetch('https://api.open-meteo.com/v1/forecast?'+params);const data=await res.json();
document.getElementById('locationName').textContent=name;document.getElementById('locationCoords').textContent='Lat: '+lat.toFixed(4)+' | Lon: '+lon.toFixed(4);document.getElementById('locationInfo').style.display='flex';
displayCurrent(data.current);displayHourly(data.hourly);displayDaily(data.daily);updateChart(data.daily);
['currentWeather','hourlySection','forecastSection','chartSection'].forEach(id=>document.getElementById(id).style.display='block')}catch(err){console.error(err);toast('Erro ao carregar previsão','error')}
document.getElementById('loading').style.display='none'}

function displayCurrent(c){const temp=unit==='imperial'?c2f(c.temperature_2m):c.temperature_2m;const feels=unit==='imperial'?c2f(c.apparent_temperature):c.apparent_temperature;const wind=unit==='imperial'?kmh2mph(c.wind_speed_10m):c.wind_speed_10m;const cond=getWeatherCondition(c.weather_code);
document.getElementById('currentTemp').textContent=Math.round(temp);document.getElementById('currentFeels').textContent='Sensação: '+Math.round(feels)+(unit==='metric'?'°C':'°F');document.getElementById('currentCondition').textContent=cond.text;document.getElementById('currentIcon').innerHTML='<i class="fas '+cond.icon+'" style="color:'+cond.color+'"></i>';document.getElementById('currentTime').textContent=new Date().toLocaleString('pt-BR');
document.getElementById('statHumidity').textContent=c.relative_humidity_2m+'%';document.getElementById('statWind').textContent=Math.round(wind)+(unit==='metric'?' km/h':' mph');document.getElementById('statPressure').textContent=Math.round(c.pressure_msl)+' hPa';document.getElementById('statRain').textContent=(c.precipitation||0).toFixed(1)+' mm';document.getElementById('statUV').textContent=Math.round(c.uv_index||0);document.getElementById('statCloud').textContent=c.cloud_cover+'%'}

function displayHourly(h){const now=new Date();let html='';for(let i=0;i<24;i++){const time=new Date(h.time[i]);const temp=unit==='imperial'?c2f(h.temperature_2m[i]):h.temperature_2m[i];const cond=getWeatherCondition(h.weather_code[i]);const prob=h.precipitation_probability[i]||0;
html+='<div class="hour-card"><div class="hour-time">'+(i===0?'Agora':time.getHours().toString().padStart(2,'0')+':00')+'</div><div class="hour-icon"><i class="fas '+cond.icon+'" style="color:'+cond.color+'"></i></div><div class="hour-temp">'+Math.round(temp)+'°</div>'+(prob>0?'<div class="hour-rain"><i class="fas fa-tint"></i> '+prob+'%</div>':'')+'</div>'}
document.getElementById('hourlyScroll').innerHTML=html}

function displayDaily(d){const days=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];let html='';for(let i=0;i<d.time.length;i++){const date=new Date(d.time[i]);const tmax=unit==='imperial'?c2f(d.temperature_2m_max[i]):d.temperature_2m_max[i];const tmin=unit==='imperial'?c2f(d.temperature_2m_min[i]):d.temperature_2m_min[i];const cond=getWeatherCondition(d.weather_code[i]);const prob=d.precipitation_probability_max[i]||0;
html+='<div class="day-card"><div class="day-name">'+(i===0?'Hoje':days[date.getDay()])+'</div><div class="day-date">'+date.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})+'</div><div class="day-icon"><i class="fas '+cond.icon+'" style="color:'+cond.color+'"></i></div><div class="day-temps"><span class="day-high">'+Math.round(tmax)+'°</span><span class="day-low">'+Math.round(tmin)+'°</span></div>'+(prob>0?'<div class="day-rain"><i class="fas fa-tint"></i> '+prob+'%</div>':'')+'</div>'}
document.getElementById('dailyForecast').innerHTML=html}

function initChart(){const ctx=document.getElementById('forecastChart').getContext('2d');chart=new Chart(ctx,{type:'line',data:{labels:[],datasets:[{label:'Máxima',data:[],borderColor:'#ef4444',backgroundColor:'rgba(239,68,68,.1)',tension:.4},{label:'Mínima',data:[],borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,.1)',tension:.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}},y:{ticks:{color:'#94a3b8'},grid:{color:'rgba(255,255,255,.05)'}}}}})}

function updateChart(d){const labels=d.time.map(t=>new Date(t).toLocaleDateString('pt-BR',{weekday:'short'}));let maxT=d.temperature_2m_max,minT=d.temperature_2m_min;if(unit==='imperial'){maxT=maxT.map(c2f);minT=minT.map(c2f)}chart.data.labels=labels;chart.data.datasets[0].data=maxT;chart.data.datasets[1].data=minT;chart.update()}

function getWeatherCondition(code){const conditions={0:{text:'Céu limpo',icon:'fa-sun',color:'#fcd34d'},1:{text:'Parcialmente limpo',icon:'fa-sun',color:'#fcd34d'},2:{text:'Parcialmente nublado',icon:'fa-cloud-sun',color:'#fbbf24'},3:{text:'Nublado',icon:'fa-cloud',color:'#94a3b8'},45:{text:'Neblina',icon:'fa-smog',color:'#9ca3af'},48:{text:'Neblina',icon:'fa-smog',color:'#9ca3af'},51:{text:'Garoa leve',icon:'fa-cloud-rain',color:'#60a5fa'},53:{text:'Garoa',icon:'fa-cloud-rain',color:'#60a5fa'},55:{text:'Garoa forte',icon:'fa-cloud-rain',color:'#3b82f6'},61:{text:'Chuva leve',icon:'fa-cloud-rain',color:'#60a5fa'},63:{text:'Chuva',icon:'fa-cloud-showers-heavy',color:'#3b82f6'},65:{text:'Chuva forte',icon:'fa-cloud-showers-heavy',color:'#1d4ed8'},71:{text:'Neve leve',icon:'fa-snowflake',color:'#e0f2fe'},73:{text:'Neve',icon:'fa-snowflake',color:'#bae6fd'},75:{text:'Neve forte',icon:'fa-snowflake',color:'#7dd3fc'},77:{text:'Granizo',icon:'fa-cloud-meatball',color:'#94a3b8'},80:{text:'Pancada leve',icon:'fa-cloud-rain',color:'#60a5fa'},81:{text:'Pancada',icon:'fa-cloud-showers-heavy',color:'#3b82f6'},82:{text:'Pancada forte',icon:'fa-cloud-showers-heavy',color:'#1d4ed8'},85:{text:'Neve',icon:'fa-snowflake',color:'#bae6fd'},86:{text:'Neve forte',icon:'fa-snowflake',color:'#7dd3fc'},95:{text:'Tempestade',icon:'fa-bolt',color:'#f59e0b'},96:{text:'Tempestade granizo',icon:'fa-cloud-bolt',color:'#f59e0b'},99:{text:'Tempestade granizo',icon:'fa-cloud-bolt',color:'#dc2626'}};return conditions[code]||{text:'--',icon:'fa-question',color:'#94a3b8'}}

function setUnit(u){unit=u;document.querySelectorAll('.unit-btn').forEach(b=>b.classList.remove('active'));document.getElementById('btn-'+u).classList.add('active');document.getElementById('tempUnit').textContent=u==='metric'?'°C':'°F';const q=document.getElementById('searchCity').value;if(q){searchWeather()}}

function c2f(c){return(c*9/5)+32}
function kmh2mph(k){return k*0.621371}
function logout(){sb.auth.signOut().then(()=>window.location.href='index.html')}
function toast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),4000)}

document.addEventListener('click',e=>{if(!e.target.closest('.search-wrapper'))document.getElementById('suggestions').classList.remove('show')});
</script>
</body>
</html>

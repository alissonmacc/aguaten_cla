<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Administra√ß√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#10b981;--primary-dark:#059669;--secondary:#3b82f6;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}.app-container{display:flex;min-height:100vh}.sidebar{width:260px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column}.sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}.sidebar-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--secondary));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}.sidebar-brand{font-size:20px;font-weight:700;color:var(--primary)}.sidebar-user{padding:15px 20px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text-secondary)}.sidebar-user span{color:var(--text-primary);font-weight:500}.sidebar-nav{flex:1;padding:15px 0}.nav-section{padding:0 15px;margin-bottom:20px}.nav-section-title{font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;padding:10px 10px 5px}.nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;transition:all .2s;margin-bottom:2px}.nav-item:hover{background:var(--bg-card);color:var(--text-primary)}.nav-item.active{background:var(--primary);color:white}.nav-item i{width:20px;text-align:center}.main-content{flex:1;margin-left:260px;padding:20px}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.page-title{font-size:24px;font-weight:600}.tabs{display:flex;gap:10px;margin-bottom:25px;border-bottom:1px solid var(--border);padding-bottom:15px}.tab{padding:10px 20px;background:var(--bg-card);border:none;border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:14px;font-weight:500}.tab:hover{color:var(--text-primary)}.tab.active{background:var(--primary);color:white}.tab-content{display:none}.tab-content.active{display:block}.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;display:inline-flex;align-items:center;gap:8px;transition:all .2s}.btn-primary{background:var(--primary);color:white}.btn-primary:hover{background:var(--primary-dark)}.btn-secondary{background:var(--bg-card);color:var(--text-primary);border:1px solid var(--border)}.btn-danger{background:var(--danger);color:white}.btn-sm{padding:6px 12px;font-size:12px}.data-table{width:100%;border-collapse:collapse;background:var(--bg-card);border-radius:12px;overflow:hidden}.data-table th,.data-table td{padding:15px;text-align:left;border-bottom:1px solid var(--border)}.data-table th{background:var(--bg-dark);font-weight:600;font-size:12px;color:var(--text-secondary);text-transform:uppercase}.data-table tr:hover{background:rgba(255,255,255,.02)}.badge{padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600}.badge-success{background:rgba(34,197,94,.2);color:var(--success)}.badge-warning{background:rgba(245,158,11,.2);color:var(--warning)}.badge-info{background:rgba(59,130,246,.2);color:var(--secondary)}.actions{display:flex;gap:8px}.modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000}.modal-overlay.hidden{display:none}.modal{background:var(--bg-dark);border-radius:16px;padding:30px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;border:1px solid var(--border)}.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px}.modal-title{font-size:20px;font-weight:600}.modal-close{background:none;border:none;color:var(--text-secondary);font-size:24px;cursor:pointer}.form-group{margin-bottom:20px}.form-group label{display:block;margin-bottom:8px;font-size:14px;color:var(--text-secondary)}.form-group input,.form-group select{width:100%;padding:12px 15px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px}.form-group input:focus,.form-group select:focus{outline:none;border-color:var(--primary)}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}.checkbox-group{display:flex;flex-wrap:wrap;gap:10px;max-height:200px;overflow-y:auto;padding:10px;background:var(--bg-card);border-radius:8px}.checkbox-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg-dark);border-radius:6px}.checkbox-item input{width:auto}.checkbox-item label{cursor:pointer;font-size:13px}.toast{position:fixed;top:20px;right:20px;padding:15px 25px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000}.toast.error{border-color:var(--danger)}.toast.success{border-color:var(--success)}.log-entry{padding:15px;background:var(--bg-card);border-radius:8px;margin-bottom:10px}.log-entry.sucesso{border-left:3px solid var(--success)}.log-entry.erro{border-left:3px solid var(--danger)}.log-header{display:flex;justify-content:space-between;margin-bottom:8px}.log-time{color:var(--text-secondary);font-size:12px}.empty-state{text-align:center;padding:60px;color:var(--text-secondary)}.empty-state i{font-size:48px;margin-bottom:15px}@media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-cloud-sun-rain"></i></div>
                <span class="sidebar-brand">Aguaten</span>
            </div>
            <div class="sidebar-user"><span data-i18n="hello">Ol√°</span>, <span id="userName">Admin</span></div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="main">Principal</div>
                    <a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i> <span data-i18n="dashboard">Dashboard</span></a>
                    <a href="previsao.html" class="nav-item"><i class="fas fa-cloud-sun"></i> <span data-i18n="forecast">Previs√£o</span></a>
                    <a href="relatorios.html" class="nav-item"><i class="fas fa-file-alt"></i> <span data-i18n="reports">Relat√≥rios</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="administrative">Administrativo</div>
                    <a href="admin.html" class="nav-item active"><i class="fas fa-users-cog"></i> <span data-i18n="administration">Administra√ß√£o</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title" data-i18n="others">Outros</div>
                    <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> <span data-i18n="logout">Sair</span></a>
                    <button onclick="toggleLang()" style="width:100%;margin-top:10px;display:flex;align-items:center;gap:6px;padding:10px 15px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);cursor:pointer;font-size:12px">
                        <span id="langFlag">üáßüá∑</span>
                        <span id="langCode">PT</span>
                    </button>
                </div>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header"><h1 class="page-title" data-i18n="adminArea">√Årea Administrativa</h1></div>
            <div class="tabs">
                <button class="tab active" onclick="showTab('usuarios')"><i class="fas fa-users"></i> <span data-i18n="users">Usu√°rios</span></button>
                <button class="tab" onclick="showTab('estacoes')"><i class="fas fa-satellite-dish"></i> <span data-i18n="stations">Esta√ß√µes</span></button>
                <button class="tab" onclick="showTab('logs')"><i class="fas fa-list"></i> <span data-i18n="logs">Logs</span></button>
            </div>
            
            <div class="tab-content active" id="tab-usuarios">
                <div class="section-header"><h3 data-i18n="manageUsers">Gerenciar Usu√°rios</h3><button class="btn btn-primary" onclick="openModal('usuario')"><i class="fas fa-plus"></i> <span data-i18n="newUser">Novo Usu√°rio</span></button></div>
                <table class="data-table"><thead><tr><th data-i18n="name">Nome</th><th>Email</th><th>Admin</th><th data-i18n="stations">Esta√ß√µes</th><th data-i18n="actions">A√ß√µes</th></tr></thead><tbody id="usuarios-tbody"></tbody></table>
            </div>
            
            <div class="tab-content" id="tab-estacoes">
                <div class="section-header"><h3 data-i18n="manageStations">Gerenciar Esta√ß√µes</h3><button class="btn btn-primary" onclick="openModal('estacao')"><i class="fas fa-plus"></i> <span data-i18n="newStation">Nova Esta√ß√£o</span></button></div>
                <table class="data-table"><thead><tr><th>#</th><th data-i18n="identifier">Identificador</th><th data-i18n="provider">Provedor</th><th data-i18n="location">Localiza√ß√£o</th><th data-i18n="lastSync">√öltima Sync</th><th data-i18n="actions">A√ß√µes</th></tr></thead><tbody id="estacoes-tbody"></tbody></table>
            </div>
            
            <div class="tab-content" id="tab-logs">
                <div class="section-header"><h3 data-i18n="syncLogs">Logs de Sincroniza√ß√£o</h3><button class="btn btn-secondary" onclick="loadLogs()"><i class="fas fa-sync"></i> <span data-i18n="update">Atualizar</span></button></div>
                <div id="logs-container"></div>
            </div>
        </main>
    </div>
    
    <div class="modal-overlay hidden" id="modal-usuario">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="usuario-modal-title">Novo Usu√°rio</h3><button class="modal-close" onclick="closeModal('usuario')">&times;</button></div>
            <form id="usuario-form" onsubmit="saveUsuario(event)">
                <input type="hidden" id="usuario-id">
                <div class="form-row"><div class="form-group"><label>Nome *</label><input type="text" id="usuario-nome" required></div><div class="form-group"><label>Sobrenome</label><input type="text" id="usuario-sobrenome"></div></div>
                <div class="form-row"><div class="form-group"><label>Email *</label><input type="email" id="usuario-email" required></div><div class="form-group"><label>Telefone</label><input type="text" id="usuario-telefone"></div></div>
                <div class="form-group" id="senha-group"><label>Senha *</label><input type="password" id="usuario-senha" minlength="6"></div>
                <div class="form-group"><label><input type="checkbox" id="usuario-admin"> √â Administrador?</label></div>
                <div class="form-group"><label>Esta√ß√µes com Acesso</label><div class="checkbox-group" id="usuario-estacoes"></div></div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-save"></i> Salvar</button>
            </form>
        </div>
    </div>
    
    <div class="modal-overlay hidden" id="modal-estacao">
        <div class="modal">
            <div class="modal-header"><h3 class="modal-title" id="estacao-modal-title">Nova Esta√ß√£o</h3><button class="modal-close" onclick="closeModal('estacao')">&times;</button></div>
            <form id="estacao-form" onsubmit="saveEstacao(event)">
                <input type="hidden" id="estacao-id">
                <div class="form-row"><div class="form-group"><label>Provedor *</label><select id="estacao-provedor" required><option value="ecowitt">Ecowitt</option><option value="wunderground">Weather Underground</option></select></div><div class="form-group"><label>ID/IMEI *</label><input type="text" id="estacao-identificador" required placeholder="864086067763478"></div></div>
                <div class="form-group"><label>Nome</label><input type="text" id="estacao-nome" placeholder="Ex: Esta√ß√£o Fazenda"></div>
                <div class="form-row"><div class="form-group"><label>Latitude</label><input type="number" step="any" id="estacao-lat" placeholder="-25.4284"></div><div class="form-group"><label>Longitude</label><input type="number" step="any" id="estacao-lng" placeholder="-54.5934"></div></div>
                <div class="form-row"><div class="form-group"><label>Cidade</label><input type="text" id="estacao-cidade"></div><div class="form-group"><label>Pa√≠s</label><input type="text" id="estacao-pais" value="Paraguay"></div></div>
                <div class="form-group"><label>Usu√°rios com Acesso</label><div class="checkbox-group" id="estacao-usuarios"></div></div>
                <button type="submit" class="btn btn-primary" style="width:100%"><i class="fas fa-save"></i> Salvar</button>
            </form>
        </div>
    </div>
    
    <script>
        const SUPABASE_URL='https://ltwtqjrojbobfngcryjw.supabase.co';
        const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NjAyODcsImV4cCI6MjA4MjIzNjI4N30.le4b9sZ7jMfpPjPn9FiWK9tpDxnTn0VaCl2vlQv14SA';
        const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
        let currentUser=null,userProfile=null,usuarios=[],estacoes=[];
        let lang=localStorage.getItem('aguaten_lang')||'pt';
        
        // ============ TRANSLATIONS ============
        const i18n={
            pt:{
                hello:'Ol√°',main:'Principal',dashboard:'Dashboard',forecast:'Previs√£o',reports:'Relat√≥rios',
                administrative:'Administrativo',administration:'Administra√ß√£o',others:'Outros',logout:'Sair',
                adminArea:'√Årea Administrativa',users:'Usu√°rios',stations:'Esta√ß√µes',logs:'Logs',
                manageUsers:'Gerenciar Usu√°rios',newUser:'Novo Usu√°rio',manageStations:'Gerenciar Esta√ß√µes',newStation:'Nova Esta√ß√£o',
                syncLogs:'Logs de Sincroniza√ß√£o',update:'Atualizar',
                name:'Nome',email:'Email',phone:'Telefone',password:'Senha',identifier:'Identificador',provider:'Provedor',
                location:'Localiza√ß√£o',lastSync:'√öltima Sync',actions:'A√ß√µes',
                firstName:'Nome',lastName:'Sobrenome',isAdmin:'√â Administrador?',stationsAccess:'Esta√ß√µes com Acesso',usersAccess:'Usu√°rios com Acesso',
                city:'Cidade',country:'Pa√≠s',latitude:'Latitude',longitude:'Longitude',
                save:'Salvar',cancel:'Cancelar',yes:'Sim',no:'N√£o',
                userCreated:'Usu√°rio criado!',userUpdated:'Usu√°rio atualizado!',stationSaved:'Esta√ß√£o salva!',deleted:'Exclu√≠do!',
                accessDenied:'Acesso negado',noLogs:'Nenhum log.',deleteUser:'Excluir este usu√°rio?',deleteStation:'Excluir esta esta√ß√£o?',
                editUser:'Editar Usu√°rio',editStation:'Editar Esta√ß√£o',newUserTitle:'Novo Usu√°rio',newStationTitle:'Nova Esta√ß√£o'
            },
            es:{
                hello:'Hola',main:'Principal',dashboard:'Panel',forecast:'Pron√≥stico',reports:'Informes',
                administrative:'Administrativo',administration:'Administraci√≥n',others:'Otros',logout:'Salir',
                adminArea:'√Årea Administrativa',users:'Usuarios',stations:'Estaciones',logs:'Logs',
                manageUsers:'Gestionar Usuarios',newUser:'Nuevo Usuario',manageStations:'Gestionar Estaciones',newStation:'Nueva Estaci√≥n',
                syncLogs:'Logs de Sincronizaci√≥n',update:'Actualizar',
                name:'Nombre',email:'Email',phone:'Tel√©fono',password:'Contrase√±a',identifier:'Identificador',provider:'Proveedor',
                location:'Ubicaci√≥n',lastSync:'√öltima Sync',actions:'Acciones',
                firstName:'Nombre',lastName:'Apellido',isAdmin:'¬øEs Administrador?',stationsAccess:'Estaciones con Acceso',usersAccess:'Usuarios con Acceso',
                city:'Ciudad',country:'Pa√≠s',latitude:'Latitud',longitude:'Longitud',
                save:'Guardar',cancel:'Cancelar',yes:'S√≠',no:'No',
                userCreated:'¬°Usuario creado!',userUpdated:'¬°Usuario actualizado!',stationSaved:'¬°Estaci√≥n guardada!',deleted:'¬°Eliminado!',
                accessDenied:'Acceso denegado',noLogs:'Sin logs.',deleteUser:'¬øEliminar este usuario?',deleteStation:'¬øEliminar esta estaci√≥n?',
                editUser:'Editar Usuario',editStation:'Editar Estaci√≥n',newUserTitle:'Nuevo Usuario',newStationTitle:'Nueva Estaci√≥n'
            }
        };
        
        function t(key){return i18n[lang][key]||key}
        
        function applyLang(){
            document.querySelectorAll('[data-i18n]').forEach(el=>{
                const key=el.getAttribute('data-i18n');
                if(i18n[lang][key])el.textContent=i18n[lang][key];
            });
            document.getElementById('langFlag').textContent=lang==='pt'?'üáßüá∑':'üá™üá∏';
            document.getElementById('langCode').textContent=lang.toUpperCase();
        }
        
        function toggleLang(){
            lang=lang==='pt'?'es':'pt';
            localStorage.setItem('aguaten_lang',lang);
            applyLang();
        }

        document.addEventListener('DOMContentLoaded',async()=>{applyLang();const{data:{session}}=await supabaseClient.auth.getSession();if(!session){window.location.href='index.html';return}currentUser=session.user;await loadUserProfile();if(!userProfile?.is_admin){showToast(t('accessDenied'),'error');setTimeout(()=>window.location.href='index.html',1500);return}await loadAllData();render('usuarios')});
        async function loadUserProfile(){const{data}=await supabaseClient.from('perfis').select('*').eq('id',currentUser.id).single();if(data){userProfile=data;document.getElementById('userName').textContent=data.primeiro_nome||data.email.split('@')[0]}}
        async function loadAllData(){const[u,e]=await Promise.all([supabaseClient.from('perfis').select('*,estacao_usuario(estacao_id)'),supabaseClient.from('estacoes').select('*,estacao_usuario(usuario_id)').order('created_at',{ascending:false})]);usuarios=u.data||[];estacoes=e.data||[]}
        function showTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelector('#tab-'+tab).classList.add('active');const idx=['usuarios','estacoes','logs'].indexOf(tab);document.querySelectorAll('.tab')[idx]?.classList.add('active');render(tab)}
        function render(tab){if(tab==='usuarios')renderUsuarios();else if(tab==='estacoes')renderEstacoes();else if(tab==='logs')loadLogs()}
        function renderUsuarios(){document.getElementById('usuarios-tbody').innerHTML=usuarios.map(u=>'<tr><td><strong>'+(u.primeiro_nome||'')+' '+(u.ultimo_nome||'')+'</strong></td><td>'+u.email+'</td><td>'+(u.is_admin?'<span class="badge badge-success">Sim</span>':'<span class="badge badge-warning">N√£o</span>')+'</td><td>'+(u.estacao_usuario?.length||0)+'</td><td class="actions"><button class="btn btn-secondary btn-sm" onclick="editUsuario(\''+u.id+'\')"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="deleteUsuario(\''+u.id+'\')"><i class="fas fa-trash"></i></button></td></tr>').join('')}
        function renderEstacoes(){document.getElementById('estacoes-tbody').innerHTML=estacoes.map((e,i)=>'<tr><td>'+(i+1)+'</td><td><strong>'+e.identificador+'</strong><br><small>'+(e.nome||'')+'</small></td><td><span class="badge badge-info">'+e.provedor+'</span></td><td>'+(e.cidade||'')+' - '+(e.pais||'')+'</td><td>'+(e.ultima_sincronizacao?new Date(e.ultima_sincronizacao).toLocaleString('pt-BR'):'--')+'</td><td class="actions"><button class="btn btn-secondary btn-sm" onclick="editEstacao(\''+e.id+'\')"><i class="fas fa-edit"></i></button><button class="btn btn-danger btn-sm" onclick="deleteEstacao(\''+e.id+'\')"><i class="fas fa-trash"></i></button></td></tr>').join('')}
        async function loadLogs(){const{data}=await supabaseClient.from('station_server_logs').select('*').order('created_at',{ascending:false}).limit(50);const c=document.getElementById('logs-container');if(!data||!data.length){c.innerHTML='<div class="empty-state"><i class="fas fa-list"></i><p>Nenhum log.</p></div>';return}c.innerHTML=data.map(l=>'<div class="log-entry '+l.tipo+'"><div class="log-header"><span style="color:'+(l.tipo==='sucesso'?'var(--success)':'var(--danger)')+'"><i class="fas fa-'+(l.tipo==='sucesso'?'check-circle':'times-circle')+'"></i> '+l.tipo.toUpperCase()+'</span><span class="log-time">'+new Date(l.created_at).toLocaleString('pt-BR')+'</span></div><div><strong>ID:</strong> '+(l.identificador||'-')+' | '+(l.log||'')+'</div></div>').join('')}
        function openModal(type){document.getElementById('modal-'+type).classList.remove('hidden');if(type==='usuario'){document.getElementById('usuario-id').value='';document.getElementById('usuario-form').reset();document.getElementById('usuario-modal-title').textContent='Novo Usu√°rio';document.getElementById('senha-group').style.display='block';document.getElementById('usuario-senha').required=true;document.getElementById('usuario-email').disabled=false;document.getElementById('usuario-estacoes').innerHTML=estacoes.map(e=>'<div class="checkbox-item"><input type="checkbox" id="ue-'+e.id+'" value="'+e.id+'"><label for="ue-'+e.id+'">'+e.identificador+'</label></div>').join('')}if(type==='estacao'){document.getElementById('estacao-id').value='';document.getElementById('estacao-form').reset();document.getElementById('estacao-modal-title').textContent='Nova Esta√ß√£o';document.getElementById('estacao-usuarios').innerHTML=usuarios.map(u=>'<div class="checkbox-item"><input type="checkbox" id="eu-'+u.id+'" value="'+u.id+'"><label for="eu-'+u.id+'">'+(u.primeiro_nome||u.email)+'</label></div>').join('')}}
        function closeModal(type){document.getElementById('modal-'+type).classList.add('hidden')}
        async function editUsuario(id){const u=usuarios.find(x=>x.id===id);if(!u)return;openModal('usuario');document.getElementById('usuario-modal-title').textContent='Editar Usu√°rio';document.getElementById('usuario-id').value=u.id;document.getElementById('usuario-nome').value=u.primeiro_nome||'';document.getElementById('usuario-sobrenome').value=u.ultimo_nome||'';document.getElementById('usuario-email').value=u.email;document.getElementById('usuario-email').disabled=true;document.getElementById('usuario-telefone').value=u.telefone||'';document.getElementById('usuario-admin').checked=u.is_admin;document.getElementById('senha-group').style.display='none';document.getElementById('usuario-senha').required=false;(u.estacao_usuario||[]).forEach(eu=>{const cb=document.getElementById('ue-'+eu.estacao_id);if(cb)cb.checked=true})}
        async function saveUsuario(e){e.preventDefault();const id=document.getElementById('usuario-id').value;try{if(!id){const{error}=await supabaseClient.auth.signUp({email:document.getElementById('usuario-email').value,password:document.getElementById('usuario-senha').value,options:{data:{primeiro_nome:document.getElementById('usuario-nome').value}}});if(error)throw error;showToast('Usu√°rio criado!','success')}else{await supabaseClient.from('perfis').update({primeiro_nome:document.getElementById('usuario-nome').value,ultimo_nome:document.getElementById('usuario-sobrenome').value,telefone:document.getElementById('usuario-telefone').value,is_admin:document.getElementById('usuario-admin').checked}).eq('id',id);await supabaseClient.from('estacao_usuario').delete().eq('usuario_id',id);const checked=[...document.querySelectorAll('#usuario-estacoes input:checked')].map(c=>c.value);if(checked.length)await supabaseClient.from('estacao_usuario').insert(checked.map(estId=>({usuario_id:id,estacao_id:estId})));showToast('Usu√°rio atualizado!','success')}closeModal('usuario');await loadAllData();render('usuarios')}catch(err){showToast(err.message,'error')}}
        async function deleteUsuario(id){if(!confirm('Excluir este usu√°rio?'))return;await supabaseClient.from('perfis').delete().eq('id',id);showToast('Exclu√≠do!','success');await loadAllData();render('usuarios')}
        async function editEstacao(id){const e=estacoes.find(x=>x.id===id);if(!e)return;openModal('estacao');document.getElementById('estacao-modal-title').textContent='Editar Esta√ß√£o';document.getElementById('estacao-id').value=e.id;document.getElementById('estacao-provedor').value=e.provedor;document.getElementById('estacao-identificador').value=e.identificador;document.getElementById('estacao-nome').value=e.nome||'';document.getElementById('estacao-lat').value=e.latitude||'';document.getElementById('estacao-lng').value=e.longitude||'';document.getElementById('estacao-cidade').value=e.cidade||'';document.getElementById('estacao-pais').value=e.pais||'Paraguay';(e.estacao_usuario||[]).forEach(eu=>{const cb=document.getElementById('eu-'+eu.usuario_id);if(cb)cb.checked=true})}
        async function saveEstacao(e){e.preventDefault();const id=document.getElementById('estacao-id').value;const data={provedor:document.getElementById('estacao-provedor').value,identificador:document.getElementById('estacao-identificador').value,nome:document.getElementById('estacao-nome').value,latitude:parseFloat(document.getElementById('estacao-lat').value)||null,longitude:parseFloat(document.getElementById('estacao-lng').value)||null,cidade:document.getElementById('estacao-cidade').value,pais:document.getElementById('estacao-pais').value};try{let estacaoId=id;if(id)await supabaseClient.from('estacoes').update(data).eq('id',id);else{const{data:newData}=await supabaseClient.from('estacoes').insert(data).select().single();estacaoId=newData.id}await supabaseClient.from('estacao_usuario').delete().eq('estacao_id',estacaoId);const checked=[...document.querySelectorAll('#estacao-usuarios input:checked')].map(c=>c.value);if(checked.length)await supabaseClient.from('estacao_usuario').insert(checked.map(userId=>({estacao_id:estacaoId,usuario_id:userId})));showToast('Esta√ß√£o salva!','success');closeModal('estacao');await loadAllData();render('estacoes')}catch(err){showToast(err.message,'error')}}
        async function deleteEstacao(id){if(!confirm('Excluir esta esta√ß√£o?'))return;await supabaseClient.from('estacoes').delete().eq('id',id);showToast('Exclu√≠do!','success');await loadAllData();render('estacoes')}
        function logout(){supabaseClient.auth.signOut().then(()=>window.location.href='index.html')}
        function showToast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
    </script>
</body>
</html>

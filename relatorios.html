<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Relatórios</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root{--primary:#10b981;--bg-dark:#1e293b;--bg-darker:#0f172a;--bg-card:#334155;--text-primary:#f1f5f9;--text-secondary:#94a3b8;--border:#475569;--success:#22c55e;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',sans-serif;background:var(--bg-darker);color:var(--text-primary);min-height:100vh}
        .app-container{display:flex;min-height:100vh}
        .sidebar{width:260px;background:var(--bg-dark);border-right:1px solid var(--border);position:fixed;height:100vh;display:flex;flex-direction:column}
        .sidebar-header{padding:20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
        .sidebar-logo{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),var(--info));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:20px}
        .sidebar-brand{font-size:20px;font-weight:700;color:var(--primary)}
        .sidebar-user{padding:15px 20px;border-bottom:1px solid var(--border);font-size:13px;color:var(--text-secondary)}
        .sidebar-user span{color:var(--text-primary);font-weight:500}
        .sidebar-nav{flex:1;padding:15px 0}
        .nav-section{padding:0 15px;margin-bottom:20px}
        .nav-section-title{font-size:11px;font-weight:600;color:var(--text-secondary);text-transform:uppercase;padding:10px 10px 5px}
        .nav-item{display:flex;align-items:center;gap:12px;padding:12px 15px;color:var(--text-secondary);text-decoration:none;border-radius:8px;transition:all .2s;margin-bottom:2px}
        .nav-item:hover{background:var(--bg-card);color:var(--text-primary)}
        .nav-item.active{background:var(--primary);color:white}
        .nav-item i{width:20px;text-align:center}
        .main-content{flex:1;margin-left:260px;padding:20px}
        .page-header{margin-bottom:20px}
        .page-title{font-size:24px;font-weight:600}
        .tabs{display:flex;gap:8px;margin-bottom:25px;flex-wrap:wrap}
        .tab{padding:12px 24px;background:var(--bg-card);border:none;border-radius:8px;color:var(--text-secondary);cursor:pointer;font-size:14px;font-weight:500;display:flex;align-items:center;gap:8px;transition:all .2s}
        .tab:hover{color:var(--text-primary);background:var(--bg-dark)}
        .tab.active{background:var(--primary);color:white}
        .tab-content{display:none}
        .tab-content.active{display:block}
        .report-section{background:var(--bg-card);border-radius:12px;padding:25px;margin-bottom:20px}
        .report-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:15px}
        .report-title{font-size:18px;font-weight:600;color:var(--primary);display:flex;align-items:center;gap:10px}
        .report-filters{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
        .filter-group{display:flex;flex-direction:column;gap:5px}
        .filter-group label{font-size:11px;color:var(--text-secondary);text-transform:uppercase}
        .filter-input,.filter-select{padding:10px 15px;background:var(--bg-dark);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;min-width:150px}
        .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;display:inline-flex;align-items:center;gap:8px;transition:all .2s}
        .btn-primary{background:var(--primary);color:white}
        .btn-primary:hover{background:#059669}
        .btn-secondary{background:var(--bg-dark);color:var(--text-primary);border:1px solid var(--border)}
        .btn-success{background:var(--success);color:white}
        .data-table{width:100%;border-collapse:collapse;margin-top:20px;font-size:13px}
        .data-table th,.data-table td{padding:12px 15px;text-align:left;border-bottom:1px solid var(--border)}
        .data-table th{background:var(--bg-dark);font-weight:600;font-size:11px;color:var(--text-secondary);text-transform:uppercase;position:sticky;top:0}
        .data-table tbody tr:hover{background:rgba(255,255,255,.02)}
        .temp-min{color:var(--info)}
        .temp-max{color:var(--danger)}
        .temp-media{color:var(--warning)}
        .chart-container{height:400px;margin:20px 0}
        .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin-bottom:20px}
        .stat-box{background:var(--bg-dark);border-radius:10px;padding:20px;text-align:center}
        .stat-box-icon{font-size:24px;margin-bottom:10px}
        .stat-box-value{font-size:28px;font-weight:700}
        .stat-box-label{font-size:12px;color:var(--text-secondary);margin-top:5px}
        .stat-box.temp .stat-box-icon{color:var(--warning)}
        .stat-box.humidity .stat-box-icon{color:var(--info)}
        .stat-box.rain .stat-box-icon{color:var(--info)}
        .stat-box.wind .stat-box-icon{color:var(--success)}
        .stat-box.pressure .stat-box-icon{color:#8b5cf6}
        .stat-box.uv .stat-box-icon{color:var(--danger)}
        .toast{position:fixed;top:20px;right:20px;padding:15px 25px;background:var(--bg-card);border-radius:8px;border-left:4px solid var(--primary);z-index:2000}
        .toast.error{border-color:var(--danger)}
        .toast.success{border-color:var(--success)}
        .table-container{max-height:500px;overflow-y:auto;border-radius:8px;border:1px solid var(--border)}
        @media(max-width:768px){.sidebar{display:none}.main-content{margin-left:0}}
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header"><div class="sidebar-logo"><i class="fas fa-cloud-sun-rain"></i></div><span class="sidebar-brand">Aguaten</span></div>
            <div class="sidebar-user">Olá, <span id="userName">Usuário</span></div>
            <nav class="sidebar-nav">
                <div class="nav-section"><div class="nav-section-title">Principal</div><a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i> Dashboard</a><a href="relatorios.html" class="nav-item active"><i class="fas fa-file-alt"></i> Relatórios</a></div>
                <div class="nav-section" id="adminSection" style="display:none"><div class="nav-section-title">Administrativo</div><a href="admin.html" class="nav-item"><i class="fas fa-users-cog"></i> Administração</a></div>
                <div class="nav-section"><div class="nav-section-title">Outros</div><a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a></div>
            </nav>
        </aside>
        
        <main class="main-content">
            <div class="page-header"><h1 class="page-title"><i class="fas fa-file-alt" style="color:var(--primary)"></i> Relatórios</h1></div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('resumo')"><i class="fas fa-tachometer-alt"></i> Resumo</button>
                <button class="tab" onclick="showTab('temperatura')"><i class="fas fa-thermometer-half"></i> Temperatura</button>
                <button class="tab" onclick="showTab('precipitacao')"><i class="fas fa-cloud-rain"></i> Precipitação</button>
                <button class="tab" onclick="showTab('vento')"><i class="fas fa-wind"></i> Vento</button>
                <button class="tab" onclick="showTab('dados')"><i class="fas fa-database"></i> Dados Brutos</button>
            </div>
            
            <!-- RESUMO -->
            <div class="tab-content active" id="tab-resumo">
                <div class="report-section">
                    <div class="report-header">
                        <h3 class="report-title"><i class="fas fa-tachometer-alt"></i> Resumo do Período</h3>
                        <div class="report-filters">
                            <div class="filter-group"><label>Estação</label><select class="filter-select" id="resumo-estacao"></select></div>
                            <div class="filter-group"><label>De</label><input type="date" class="filter-input" id="resumo-inicio"></div>
                            <div class="filter-group"><label>Até</label><input type="date" class="filter-input" id="resumo-fim"></div>
                            <button class="btn btn-primary" onclick="loadResumo()"><i class="fas fa-search"></i> Gerar</button>
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="stat-box temp"><div class="stat-box-icon"><i class="fas fa-thermometer-half"></i></div><div class="stat-box-value" id="r-temp-media">--°C</div><div class="stat-box-label">Temp. Média</div></div>
                        <div class="stat-box temp"><div class="stat-box-icon"><i class="fas fa-temperature-low"></i></div><div class="stat-box-value" id="r-temp-min">--°C</div><div class="stat-box-label">Mínima</div></div>
                        <div class="stat-box temp"><div class="stat-box-icon"><i class="fas fa-temperature-high"></i></div><div class="stat-box-value" id="r-temp-max">--°C</div><div class="stat-box-label">Máxima</div></div>
                        <div class="stat-box humidity"><div class="stat-box-icon"><i class="fas fa-tint"></i></div><div class="stat-box-value" id="r-humidity">--%</div><div class="stat-box-label">Umidade</div></div>
                        <div class="stat-box rain"><div class="stat-box-icon"><i class="fas fa-cloud-rain"></i></div><div class="stat-box-value" id="r-rain">-- mm</div><div class="stat-box-label">Precipitação</div></div>
                        <div class="stat-box wind"><div class="stat-box-icon"><i class="fas fa-wind"></i></div><div class="stat-box-value" id="r-wind">-- km/h</div><div class="stat-box-label">Vento Médio</div></div>
                    </div>
                    <div class="chart-container"><canvas id="resumo-chart"></canvas></div>
                </div>
            </div>
            
            <!-- TEMPERATURA -->
            <div class="tab-content" id="tab-temperatura">
                <div class="report-section">
                    <div class="report-header">
                        <h3 class="report-title"><i class="fas fa-thermometer-half"></i> Análise de Temperatura</h3>
                        <div class="report-filters">
                            <div class="filter-group"><label>Estação</label><select class="filter-select" id="temp-estacao"></select></div>
                            <div class="filter-group"><label>De</label><input type="date" class="filter-input" id="temp-inicio"></div>
                            <div class="filter-group"><label>Até</label><input type="date" class="filter-input" id="temp-fim"></div>
                            <button class="btn btn-primary" onclick="loadTemperatura()"><i class="fas fa-search"></i> Gerar</button>
                            <button class="btn btn-success" onclick="exportCSV('temp')"><i class="fas fa-download"></i> CSV</button>
                        </div>
                    </div>
                    <div class="chart-container"><canvas id="temp-chart"></canvas></div>
                    <div class="table-container"><table class="data-table" id="temp-table"><thead><tr><th>Data</th><th>Mínima</th><th>Média</th><th>Máxima</th><th>Amplitude</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            
            <!-- PRECIPITAÇÃO -->
            <div class="tab-content" id="tab-precipitacao">
                <div class="report-section">
                    <div class="report-header">
                        <h3 class="report-title"><i class="fas fa-cloud-rain"></i> Análise de Precipitação</h3>
                        <div class="report-filters">
                            <div class="filter-group"><label>Estação</label><select class="filter-select" id="rain-estacao"></select></div>
                            <div class="filter-group"><label>De</label><input type="date" class="filter-input" id="rain-inicio"></div>
                            <div class="filter-group"><label>Até</label><input type="date" class="filter-input" id="rain-fim"></div>
                            <button class="btn btn-primary" onclick="loadPrecipitacao()"><i class="fas fa-search"></i> Gerar</button>
                            <button class="btn btn-success" onclick="exportCSV('rain')"><i class="fas fa-download"></i> CSV</button>
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="stat-box rain"><div class="stat-box-icon"><i class="fas fa-cloud-rain"></i></div><div class="stat-box-value" id="rain-total">-- mm</div><div class="stat-box-label">Total</div></div>
                        <div class="stat-box rain"><div class="stat-box-icon"><i class="fas fa-cloud-showers-heavy"></i></div><div class="stat-box-value" id="rain-max">-- mm</div><div class="stat-box-label">Máx/Dia</div></div>
                        <div class="stat-box"><div class="stat-box-icon" style="color:var(--info)"><i class="fas fa-calendar-day"></i></div><div class="stat-box-value" id="rain-days">--</div><div class="stat-box-label">Dias Chuva</div></div>
                    </div>
                    <div class="chart-container"><canvas id="rain-chart"></canvas></div>
                    <div class="table-container"><table class="data-table" id="rain-table"><thead><tr><th>Data</th><th>Precipitação</th><th>Acum. Semana</th><th>Acum. Mês</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
            
            <!-- VENTO -->
            <div class="tab-content" id="tab-vento">
                <div class="report-section">
                    <div class="report-header">
                        <h3 class="report-title"><i class="fas fa-wind"></i> Análise de Vento</h3>
                        <div class="report-filters">
                            <div class="filter-group"><label>Estação</label><select class="filter-select" id="wind-estacao"></select></div>
                            <div class="filter-group"><label>De</label><input type="date" class="filter-input" id="wind-inicio"></div>
                            <div class="filter-group"><label>Até</label><input type="date" class="filter-input" id="wind-fim"></div>
                            <button class="btn btn-primary" onclick="loadVento()"><i class="fas fa-search"></i> Gerar</button>
                        </div>
                    </div>
                    <div class="stats-row">
                        <div class="stat-box wind"><div class="stat-box-icon"><i class="fas fa-wind"></i></div><div class="stat-box-value" id="wind-avg">-- km/h</div><div class="stat-box-label">Vel. Média</div></div>
                        <div class="stat-box wind"><div class="stat-box-icon"><i class="fas fa-wind"></i></div><div class="stat-box-value" id="wind-max">-- km/h</div><div class="stat-box-label">Vel. Máxima</div></div>
                        <div class="stat-box"><div class="stat-box-icon" style="color:var(--danger)"><i class="fas fa-wind"></i></div><div class="stat-box-value" id="wind-gust">-- km/h</div><div class="stat-box-label">Rajada Máx</div></div>
                        <div class="stat-box"><div class="stat-box-icon" style="color:var(--info)"><i class="fas fa-compass"></i></div><div class="stat-box-value" id="wind-dir">--</div><div class="stat-box-label">Dir. Predom.</div></div>
                    </div>
                    <div class="chart-container"><canvas id="wind-chart"></canvas></div>
                </div>
            </div>
            
            <!-- DADOS BRUTOS -->
            <div class="tab-content" id="tab-dados">
                <div class="report-section">
                    <div class="report-header">
                        <h3 class="report-title"><i class="fas fa-database"></i> Dados Brutos</h3>
                        <div class="report-filters">
                            <div class="filter-group"><label>Estação</label><select class="filter-select" id="dados-estacao"></select></div>
                            <div class="filter-group"><label>De</label><input type="date" class="filter-input" id="dados-inicio"></div>
                            <div class="filter-group"><label>Até</label><input type="date" class="filter-input" id="dados-fim"></div>
                            <button class="btn btn-primary" onclick="loadDados()"><i class="fas fa-search"></i> Consultar</button>
                            <button class="btn btn-success" onclick="exportCSV('dados')"><i class="fas fa-download"></i> CSV</button>
                        </div>
                    </div>
                    <div class="table-container" style="max-height:600px"><table class="data-table" id="dados-table"><thead><tr><th>Data/Hora</th><th>Temp</th><th>Umid</th><th>Vento</th><th>Rajada</th><th>Chuva</th><th>Pressão</th><th>UV</th></tr></thead><tbody></tbody></table></div>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        const SUPABASE_URL='https://ltwtqjrojbobfngcryjw.supabase.co';
        const SUPABASE_ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx0d3RxanJvamJvYmZuZ2NyeWp3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY2NjAyODcsImV4cCI6MjA4MjIzNjI4N30.le4b9sZ7jMfpPjPn9FiWK9tpDxnTn0VaCl2vlQv14SA';
        const supabaseClient=supabase.createClient(SUPABASE_URL,SUPABASE_ANON_KEY);
        let currentUser=null,userProfile=null,estacoes=[],charts={};

        document.addEventListener('DOMContentLoaded',async()=>{
            const{data:{session}}=await supabaseClient.auth.getSession();
            if(!session){window.location.href='index.html';return}
            currentUser=session.user;
            await loadUserProfile();
            await loadEstacoes();
            initDates();
        });

        async function loadUserProfile(){
            const{data}=await supabaseClient.from('perfis').select('*').eq('id',currentUser.id).single();
            if(data){userProfile=data;document.getElementById('userName').textContent=data.primeiro_nome||data.email.split('@')[0];if(data.is_admin)document.getElementById('adminSection').style.display='block'}
        }

        async function loadEstacoes(){
            const{data}=await supabaseClient.from('estacoes').select('*').eq('ativo',true);
            estacoes=data||[];
            document.querySelectorAll('.filter-select[id$="-estacao"]').forEach(s=>{
                s.innerHTML=estacoes.map(e=>'<option value="'+e.id+'">'+e.identificador+' - '+(e.nome||e.cidade)+'</option>').join('');
            });
        }

        function initDates(){
            const today=new Date().toISOString().split('T')[0];
            const weekAgo=new Date(Date.now()-7*24*60*60*1000).toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i=>{
                if(i.id.includes('inicio'))i.value=weekAgo;
                else if(i.id.includes('fim'))i.value=today;
            });
        }

        function showTab(tab){
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
            document.querySelector('#tab-'+tab).classList.add('active');
            event.target.classList.add('active');
        }

        function safeNumber(val){if(val===null||val===undefined)return null;const num=parseFloat(val);return isNaN(num)?null:num}
        function formatNumber(val,dec=1){const num=safeNumber(val);return num!==null?num.toFixed(dec):'--'}

        async function loadResumo(){
            const estId=document.getElementById('resumo-estacao').value;
            const ini=document.getElementById('resumo-inicio').value;
            const fim=document.getElementById('resumo-fim').value;
            const{data}=await supabaseClient.from('estacao_dados').select('*').eq('estacao_id',estId).gte('coletado_em',ini+'T00:00:00').lte('coletado_em',fim+'T23:59:59').order('coletado_em',{ascending:true});
            if(!data||!data.length)return;
            
            const temps=data.map(d=>safeNumber(d.temperatura)).filter(v=>v!==null);
            const hums=data.map(d=>safeNumber(d.umidade)).filter(v=>v!==null);
            const winds=data.map(d=>safeNumber(d.velocidade_vento)).filter(v=>v!==null);
            
            const daily={};
            data.forEach(d=>{const day=d.coletado_em.split('T')[0];if(!daily[day])daily[day]={rain:0};const rain=safeNumber(d.precipitacao_diaria);if(rain!==null)daily[day].rain=Math.max(daily[day].rain,rain)});
            const totalRain=Object.values(daily).reduce((a,b)=>a+b.rain,0);
            
            document.getElementById('r-temp-media').textContent=formatNumber(temps.reduce((a,b)=>a+b,0)/temps.length)+'°C';
            document.getElementById('r-temp-min').textContent=formatNumber(Math.min(...temps))+'°C';
            document.getElementById('r-temp-max').textContent=formatNumber(Math.max(...temps))+'°C';
            document.getElementById('r-humidity').textContent=formatNumber(hums.reduce((a,b)=>a+b,0)/hums.length,0)+'%';
            document.getElementById('r-rain').textContent=formatNumber(totalRain)+' mm';
            document.getElementById('r-wind').textContent=formatNumber(winds.reduce((a,b)=>a+b,0)/winds.length)+' km/h';
            
            if(charts.resumo)charts.resumo.destroy();
            const labels=Object.keys(daily).map(d=>new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'}));
            const dailyTemps=Object.keys(daily).map(day=>{const dayData=data.filter(d=>d.coletado_em.startsWith(day));const t=dayData.map(d=>safeNumber(d.temperatura)).filter(v=>v!==null);return t.length?t.reduce((a,b)=>a+b,0)/t.length:null});
            charts.resumo=new Chart(document.getElementById('resumo-chart'),{type:'line',data:{labels,datasets:[{label:'Temperatura (°C)',data:dailyTemps,borderColor:'#f59e0b',backgroundColor:'rgba(245,158,11,0.1)',fill:true,yAxisID:'y',tension:0.4},{label:'Chuva (mm)',data:Object.values(daily).map(d=>d.rain),borderColor:'#3b82f6',backgroundColor:'rgba(59,130,246,0.5)',type:'bar',yAxisID:'y1'}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{position:'left',ticks:{color:'#94a3b8'}},y1:{position:'right',ticks:{color:'#94a3b8'},grid:{drawOnChartArea:false}}}}});
        }

        async function loadTemperatura(){
            const estId=document.getElementById('temp-estacao').value;
            const ini=document.getElementById('temp-inicio').value;
            const fim=document.getElementById('temp-fim').value;
            const{data}=await supabaseClient.from('estacao_dados').select('coletado_em,temperatura').eq('estacao_id',estId).gte('coletado_em',ini+'T00:00:00').lte('coletado_em',fim+'T23:59:59').order('coletado_em',{ascending:true});
            if(!data)return;
            
            const daily={};
            data.forEach(d=>{const day=d.coletado_em.split('T')[0];if(!daily[day])daily[day]=[];const t=safeNumber(d.temperatura);if(t!==null)daily[day].push(t)});
            
            document.querySelector('#temp-table tbody').innerHTML=Object.entries(daily).map(([day,temps])=>{
                const min=Math.min(...temps),max=Math.max(...temps),avg=temps.reduce((a,b)=>a+b,0)/temps.length;
                return '<tr><td>'+new Date(day).toLocaleDateString('pt-BR')+'</td><td class="temp-min">'+formatNumber(min)+'°C</td><td class="temp-media">'+formatNumber(avg)+'°C</td><td class="temp-max">'+formatNumber(max)+'°C</td><td>'+formatNumber(max-min)+'°C</td></tr>';
            }).join('');
            
            if(charts.temp)charts.temp.destroy();
            charts.temp=new Chart(document.getElementById('temp-chart'),{type:'line',data:{labels:Object.keys(daily).map(d=>new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})),datasets:[{label:'Mínima',data:Object.values(daily).map(d=>Math.min(...d)),borderColor:'#3b82f6',tension:0.4},{label:'Média',data:Object.values(daily).map(d=>d.reduce((a,b)=>a+b,0)/d.length),borderColor:'#f59e0b',tension:0.4},{label:'Máxima',data:Object.values(daily).map(d=>Math.max(...d)),borderColor:'#ef4444',tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}});
        }

        async function loadPrecipitacao(){
            const estId=document.getElementById('rain-estacao').value;
            const ini=document.getElementById('rain-inicio').value;
            const fim=document.getElementById('rain-fim').value;
            const{data}=await supabaseClient.from('estacao_dados').select('coletado_em,precipitacao_diaria,precipitacao_semanal,precipitacao_mensal').eq('estacao_id',estId).gte('coletado_em',ini+'T00:00:00').lte('coletado_em',fim+'T23:59:59').order('coletado_em',{ascending:true});
            if(!data)return;
            
            const daily={};
            data.forEach(d=>{const day=d.coletado_em.split('T')[0];if(!daily[day])daily[day]={rain:0,week:0,month:0};const r=safeNumber(d.precipitacao_diaria),w=safeNumber(d.precipitacao_semanal),m=safeNumber(d.precipitacao_mensal);if(r!==null)daily[day].rain=Math.max(daily[day].rain,r);if(w!==null)daily[day].week=Math.max(daily[day].week,w);if(m!==null)daily[day].month=Math.max(daily[day].month,m)});
            
            const total=Object.values(daily).reduce((a,b)=>a+b.rain,0);
            const rainyDays=Object.values(daily).filter(d=>d.rain>0).length;
            const maxDay=Math.max(...Object.values(daily).map(d=>d.rain));
            
            document.getElementById('rain-total').textContent=formatNumber(total)+' mm';
            document.getElementById('rain-max').textContent=formatNumber(maxDay)+' mm';
            document.getElementById('rain-days').textContent=rainyDays;
            
            document.querySelector('#rain-table tbody').innerHTML=Object.entries(daily).map(([day,d])=>'<tr><td>'+new Date(day).toLocaleDateString('pt-BR')+'</td><td>'+formatNumber(d.rain)+' mm</td><td>'+formatNumber(d.week)+' mm</td><td>'+formatNumber(d.month)+' mm</td></tr>').join('');
            
            if(charts.rain)charts.rain.destroy();
            charts.rain=new Chart(document.getElementById('rain-chart'),{type:'bar',data:{labels:Object.keys(daily).map(d=>new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})),datasets:[{label:'Precipitação (mm)',data:Object.values(daily).map(d=>d.rain),backgroundColor:'rgba(59,130,246,0.7)',borderColor:'#3b82f6',borderWidth:1}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}});
        }

        async function loadVento(){
            const estId=document.getElementById('wind-estacao').value;
            const ini=document.getElementById('wind-inicio').value;
            const fim=document.getElementById('wind-fim').value;
            const{data}=await supabaseClient.from('estacao_dados').select('coletado_em,velocidade_vento,rajada_vento,direcao_vento').eq('estacao_id',estId).gte('coletado_em',ini+'T00:00:00').lte('coletado_em',fim+'T23:59:59').order('coletado_em',{ascending:true});
            if(!data)return;
            
            const winds=data.map(d=>safeNumber(d.velocidade_vento)).filter(v=>v!==null);
            const gusts=data.map(d=>safeNumber(d.rajada_vento)).filter(v=>v!==null);
            const dirs=data.map(d=>safeNumber(d.direcao_vento)).filter(v=>v!==null);
            
            document.getElementById('wind-avg').textContent=winds.length?formatNumber(winds.reduce((a,b)=>a+b,0)/winds.length)+' km/h':'--';
            document.getElementById('wind-max').textContent=winds.length?formatNumber(Math.max(...winds))+' km/h':'--';
            document.getElementById('wind-gust').textContent=gusts.length?formatNumber(Math.max(...gusts))+' km/h':'--';
            
            const dirNames=['N','NE','E','SE','S','SO','O','NO'];
            const dirCounts=Array(8).fill(0);
            dirs.forEach(d=>{dirCounts[Math.round(d/45)%8]++});
            document.getElementById('wind-dir').textContent=dirNames[dirCounts.indexOf(Math.max(...dirCounts))];
            
            const daily={};
            data.forEach(d=>{const day=d.coletado_em.split('T')[0];if(!daily[day])daily[day]={winds:[],gusts:[]};const w=safeNumber(d.velocidade_vento),g=safeNumber(d.rajada_vento);if(w!==null)daily[day].winds.push(w);if(g!==null)daily[day].gusts.push(g)});
            
            if(charts.wind)charts.wind.destroy();
            charts.wind=new Chart(document.getElementById('wind-chart'),{type:'line',data:{labels:Object.keys(daily).map(d=>new Date(d).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'})),datasets:[{label:'Vel. Média',data:Object.values(daily).map(d=>d.winds.length?d.winds.reduce((a,b)=>a+b,0)/d.winds.length:null),borderColor:'#10b981',tension:0.4},{label:'Rajada Máx',data:Object.values(daily).map(d=>d.gusts.length?Math.max(...d.gusts):null),borderColor:'#ef4444',tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8'}}},scales:{x:{ticks:{color:'#94a3b8'}},y:{ticks:{color:'#94a3b8'}}}}});
        }

        async function loadDados(){
            const estId=document.getElementById('dados-estacao').value;
            const ini=document.getElementById('dados-inicio').value;
            const fim=document.getElementById('dados-fim').value;
            const{data}=await supabaseClient.from('estacao_dados').select('*').eq('estacao_id',estId).gte('coletado_em',ini+'T00:00:00').lte('coletado_em',fim+'T23:59:59').order('coletado_em',{ascending:false}).limit(1000);
            if(!data)return;
            document.querySelector('#dados-table tbody').innerHTML=data.map(d=>'<tr><td>'+new Date(d.coletado_em).toLocaleString('pt-BR')+'</td><td>'+formatNumber(d.temperatura)+'°C</td><td>'+formatNumber(d.umidade,0)+'%</td><td>'+formatNumber(d.velocidade_vento)+'</td><td>'+formatNumber(d.rajada_vento)+'</td><td>'+formatNumber(d.precipitacao_diaria)+'</td><td>'+formatNumber(d.pressao_relativa)+'</td><td>'+formatNumber(d.indice_uv)+'</td></tr>').join('');
        }

        function exportCSV(type){
            const table=document.getElementById(type+'-table');
            if(!table)return;
            let csv=[];
            table.querySelectorAll('tr').forEach(row=>{
                const cols=row.querySelectorAll('th,td');
                const rowData=[];
                cols.forEach(col=>rowData.push('"'+col.textContent.replace(/"/g,'""')+'"'));
                csv.push(rowData.join(','));
            });
            const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
            const link=document.createElement('a');
            link.href=URL.createObjectURL(blob);
            link.download='aguaten_'+type+'_'+new Date().toISOString().split('T')[0]+'.csv';
            link.click();
        }

        function logout(){supabaseClient.auth.signOut().then(()=>window.location.href='index.html')}
        function showToast(msg,type='info'){const t=document.createElement('div');t.className='toast '+type;t.textContent=msg;document.body.appendChild(t);setTimeout(()=>t.remove(),3000)}
    </script>
</body>
</html>

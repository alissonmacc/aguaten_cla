<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aguaten - Relatórios</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981; --primary-dark: #059669; --secondary: #3b82f6;
            --bg-dark: #1e293b; --bg-darker: #0f172a; --bg-card: #334155;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --border: #475569;
            --success: #22c55e; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-darker); color: var(--text-primary); min-height: 100vh; }
        .app-container { display: flex; min-height: 100vh; }
        
        .sidebar { width: 260px; background: var(--bg-dark); border-right: 1px solid var(--border); position: fixed; height: 100vh; z-index: 100; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
        .sidebar-logo { width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        .sidebar-brand { font-size: 20px; font-weight: 700; color: var(--primary); }
        .sidebar-user { padding: 15px 20px; border-bottom: 1px solid var(--border); font-size: 13px; color: var(--text-secondary); }
        .sidebar-user span { color: var(--text-primary); font-weight: 500; }
        .sidebar-nav { flex: 1; padding: 15px 0; overflow-y: auto; }
        .nav-section { padding: 0 15px; margin-bottom: 20px; }
        .nav-section-title { font-size: 11px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 1px; padding: 10px 10px 5px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; color: var(--text-secondary); text-decoration: none; border-radius: 8px; transition: all 0.2s; margin-bottom: 2px; }
        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item i { width: 20px; text-align: center; }
        
        .main-content { flex: 1; margin-left: 260px; padding: 20px; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .page-title { font-size: 24px; font-weight: 600; }
        
        .reports-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .report-card { background: var(--bg-card); border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .report-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .report-card.active { border-color: var(--primary); background: linear-gradient(135deg, var(--bg-card), rgba(16, 185, 129, 0.1)); }
        .report-card-icon { width: 50px; height: 50px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 22px; margin-bottom: 15px; }
        .report-card-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
        .report-card-desc { font-size: 13px; color: var(--text-secondary); line-height: 1.5; }
        
        .report-section { background: var(--bg-card); border-radius: 12px; padding: 25px; margin-bottom: 20px; display: none; }
        .report-section.active { display: block; }
        .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px; }
        .report-title { font-size: 18px; font-weight: 600; color: var(--primary); }
        .report-filters { display: flex; gap: 15px; align-items: flex-end; flex-wrap: wrap; }
        .filter-group { display: flex; flex-direction: column; gap: 5px; }
        .filter-group label { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; }
        .filter-input, .filter-select { padding: 10px 15px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-size: 14px; min-width: 150px; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--bg-dark); color: var(--text-primary); border: 1px solid var(--border); }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .data-table th, .data-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: var(--bg-dark); font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; }
        .data-table tr:hover { background: rgba(255, 255, 255, 0.02); }
        .temp-min { color: var(--info); }
        .temp-max { color: var(--danger); }
        .temp-media { color: var(--warning); }
        
        .chart-container { height: 350px; margin: 20px 0; }
        .stats-row { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .stat-box { background: var(--bg-dark); border-radius: 8px; padding: 15px 20px; flex: 1; min-width: 120px; }
        .stat-box-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; }
        .stat-box-value { font-size: 24px; font-weight: 600; }
        
        .loading { display: flex; align-items: center; justify-content: center; padding: 60px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid var(--primary); z-index: 2000; }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        
        .export-btn { margin-left: auto; }
        
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo"><i class="fas fa-cloud-sun-rain"></i></div>
                <span class="sidebar-brand">Aguaten</span>
            </div>
            <div class="sidebar-user">Olá, <span id="userName">Usuário</span></div>
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="index.html" class="nav-item"><i class="fas fa-chart-line"></i> Dashboard</a>
                    <a href="estacoes.html" class="nav-item"><i class="fas fa-broadcast-tower"></i> Minhas Estações</a>
                    <a href="relatorios.html" class="nav-item active"><i class="fas fa-file-alt"></i> Relatórios</a>
                </div>
                <div class="nav-section" id="modulosSection" style="display: none;">
                    <div class="nav-section-title">Módulos</div>
                    <a href="agrometeorologia.html" class="nav-item"><i class="fas fa-seedling"></i> Agrometeorologia</a>
                </div>
                <div class="nav-section" id="adminSection" style="display: none;">
                    <div class="nav-section-title">Administrativo</div>
                    <a href="admin.html" class="nav-item"><i class="fas fa-users-cog"></i> Usuários</a>
                    <a href="admin.html#estacoes" class="nav-item"><i class="fas fa-satellite-dish"></i> Estações</a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Outros</div>
                    <a href="#" class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Sair</a>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <h1 class="page-title">Relatórios</h1>
            </div>
            
            <!-- Report Type Cards -->
            <div class="reports-grid">
                <div class="report-card" onclick="showReport('temperatura')" id="card-temperatura">
                    <div class="report-card-icon"><i class="fas fa-thermometer-half"></i></div>
                    <div class="report-card-title">Tempo na Temperatura</div>
                    <div class="report-card-desc">Quantidade de horas que a estação ficou abaixo de uma temperatura específica.</div>
                </div>
                <div class="report-card" onclick="showReport('medias')" id="card-medias">
                    <div class="report-card-icon"><i class="fas fa-table"></i></div>
                    <div class="report-card-title">Médias Diárias</div>
                    <div class="report-card-desc">Resumo dos dados recebidos por dia: temperatura, umidade, vento, etc.</div>
                </div>
                <div class="report-card" onclick="showReport('evolucao')" id="card-evolucao">
                    <div class="report-card-icon"><i class="fas fa-chart-area"></i></div>
                    <div class="report-card-title">Evolução Diária</div>
                    <div class="report-card-desc">Relatório com todos os dados recebidos em um dia específico.</div>
                </div>
                <div class="report-card" onclick="showReport('precipitacao')" id="card-precipitacao">
                    <div class="report-card-icon"><i class="fas fa-cloud-rain"></i></div>
                    <div class="report-card-title">Precipitação</div>
                    <div class="report-card-desc">Estatísticas de níveis de precipitação agrupados por mês e ano.</div>
                </div>
                <div class="report-card" onclick="showReport('vento')" id="card-vento">
                    <div class="report-card-icon"><i class="fas fa-wind"></i></div>
                    <div class="report-card-title">Vento</div>
                    <div class="report-card-desc">Estatísticas de velocidade do vento e rajadas, por dia ou médias agrupadas.</div>
                </div>
                <div class="report-card" onclick="showReport('solar')" id="card-solar">
                    <div class="report-card-icon"><i class="fas fa-sun"></i></div>
                    <div class="report-card-title">Incidência Solar</div>
                    <div class="report-card-desc">Estatísticas de radiação solar e índices UV por dia ou médias agrupadas.</div>
                </div>
                <div class="report-card" onclick="showReport('previsao')" id="card-previsao">
                    <div class="report-card-icon"><i class="fas fa-cloud-sun"></i></div>
                    <div class="report-card-title">Previsão do Tempo</div>
                    <div class="report-card-desc">Previsão do tempo para os próximos dias na localização da estação.</div>
                </div>
                <div class="report-card" onclick="showReport('dados')" id="card-dados">
                    <div class="report-card-icon"><i class="fas fa-database"></i></div>
                    <div class="report-card-title">Evolução de Dados</div>
                    <div class="report-card-desc">Lista com todos os dados recebidos pelo sistema em um dia específico.</div>
                </div>
            </div>
            
            <!-- Report: Médias Diárias -->
            <div class="report-section" id="report-medias">
                <div class="report-header">
                    <h3 class="report-title">Médias Diárias</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="medias-estacao"></select>
                        </div>
                        <div class="filter-group">
                            <label>A partir de</label>
                            <input type="date" class="filter-input" id="medias-inicio">
                        </div>
                        <div class="filter-group">
                            <label>Até</label>
                            <input type="date" class="filter-input" id="medias-fim">
                        </div>
                        <button class="btn btn-primary" onclick="loadMediasDiarias()"><i class="fas fa-search"></i> Consultar</button>
                        <button class="btn btn-secondary export-btn" onclick="exportCSV('medias')"><i class="fas fa-download"></i> Exportar CSV</button>
                    </div>
                </div>
                <div id="medias-content">
                    <table class="data-table" id="medias-table">
                        <thead>
                            <tr>
                                <th>Dia</th>
                                <th>Mínima</th>
                                <th>Máxima</th>
                                <th>Média</th>
                                <th>Umidade</th>
                                <th>Vel. Vento</th>
                                <th>Precipitação</th>
                                <th>Pressão</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Report: Evolução Diária -->
            <div class="report-section" id="report-evolucao">
                <div class="report-header">
                    <h3 class="report-title">Evolução Diária</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="evolucao-estacao"></select>
                        </div>
                        <div class="filter-group">
                            <label>Dia</label>
                            <input type="date" class="filter-input" id="evolucao-dia">
                        </div>
                        <button class="btn btn-primary" onclick="loadEvolucaoDiaria()"><i class="fas fa-search"></i> Consultar</button>
                    </div>
                </div>
                <div id="evolucao-content">
                    <div class="stats-row" id="evolucao-stats"></div>
                    <div class="chart-container"><canvas id="evolucao-chart"></canvas></div>
                </div>
            </div>
            
            <!-- Report: Precipitação -->
            <div class="report-section" id="report-precipitacao">
                <div class="report-header">
                    <h3 class="report-title">Precipitação</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="precipitacao-estacao"></select>
                        </div>
                        <button class="btn btn-primary" onclick="loadPrecipitacao()"><i class="fas fa-search"></i> Consultar</button>
                    </div>
                </div>
                <div id="precipitacao-content">
                    <div class="chart-container"><canvas id="precipitacao-chart"></canvas></div>
                    <table class="data-table" id="precipitacao-table">
                        <thead><tr><th>Mês</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Report: Vento -->
            <div class="report-section" id="report-vento">
                <div class="report-header">
                    <h3 class="report-title">Vento</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="vento-estacao"></select>
                        </div>
                        <div class="filter-group">
                            <label>Dia</label>
                            <input type="date" class="filter-input" id="vento-dia">
                        </div>
                        <button class="btn btn-primary" onclick="loadVento()"><i class="fas fa-search"></i> Consultar</button>
                    </div>
                </div>
                <div id="vento-content">
                    <div class="chart-container"><canvas id="vento-chart"></canvas></div>
                </div>
            </div>
            
            <!-- Report: Solar -->
            <div class="report-section" id="report-solar">
                <div class="report-header">
                    <h3 class="report-title">Incidência Solar</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="solar-estacao"></select>
                        </div>
                        <div class="filter-group">
                            <label>Dia</label>
                            <input type="date" class="filter-input" id="solar-dia">
                        </div>
                        <button class="btn btn-primary" onclick="loadSolar()"><i class="fas fa-search"></i> Consultar</button>
                    </div>
                </div>
                <div id="solar-content">
                    <div class="chart-container"><canvas id="solar-chart"></canvas></div>
                </div>
            </div>
            
            <!-- Report: Dados Brutos -->
            <div class="report-section" id="report-dados">
                <div class="report-header">
                    <h3 class="report-title">Evolução de Dados</h3>
                    <div class="report-filters">
                        <div class="filter-group">
                            <label>Estação</label>
                            <select class="filter-select" id="dados-estacao"></select>
                        </div>
                        <div class="filter-group">
                            <label>De</label>
                            <input type="date" class="filter-input" id="dados-inicio">
                        </div>
                        <div class="filter-group">
                            <label>Até</label>
                            <input type="date" class="filter-input" id="dados-fim">
                        </div>
                        <button class="btn btn-primary" onclick="loadDados()"><i class="fas fa-search"></i> Consultar</button>
                        <button class="btn btn-secondary" onclick="exportCSV('dados')"><i class="fas fa-download"></i> Exportar CSV</button>
                    </div>
                </div>
                <div id="dados-content">
                    <table class="data-table" id="dados-table">
                        <thead>
                            <tr>
                                <th>Coletado em</th>
                                <th>Temperatura</th>
                                <th>Umidade</th>
                                <th>Vento</th>
                                <th>Precipitação</th>
                                <th>Índices Solares</th>
                                <th>Pressão</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <script>
        // Config
        const SUPABASE_URL = 'https://SEU_PROJETO.supabase.co';
        const SUPABASE_ANON_KEY = 'SUA_ANON_KEY';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let currentUser = null, userProfile = null, estacoes = [];
        let charts = {};
        
        // Init
        document.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = 'index.html'; return; }
            
            currentUser = session.user;
            await loadUserProfile();
            await loadEstacoes();
            initDates();
        });
        
        async function loadUserProfile() {
            const { data } = await supabaseClient.from('perfis').select('*').eq('id', currentUser.id).single();
            if (data) {
                userProfile = data;
                document.getElementById('userName').textContent = data.primeiro_nome || data.email.split('@')[0];
                if (data.is_admin) document.getElementById('adminSection').style.display = 'block';
            }
        }
        
        async function loadEstacoes() {
            const { data } = await supabaseClient.from('estacoes').select('*').eq('ativo', true);
            estacoes = data || [];
            
            // Populate all selects
            document.querySelectorAll('.filter-select[id$="-estacao"]').forEach(select => {
                select.innerHTML = estacoes.map(e => `<option value="${e.id}">${e.identificador} - ${e.nome || e.cidade}</option>`).join('');
            });
        }
        
        function initDates() {
            const today = new Date().toISOString().split('T')[0];
            const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (input.id.includes('inicio') || input.id.includes('dia')) input.value = weekAgo;
                if (input.id.includes('fim')) input.value = today;
                if (input.id.includes('dia') && !input.id.includes('inicio')) input.value = today;
            });
        }
        
        function showReport(type) {
            document.querySelectorAll('.report-card').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.report-section').forEach(s => s.classList.remove('active'));
            
            document.getElementById(`card-${type}`)?.classList.add('active');
            document.getElementById(`report-${type}`)?.classList.add('active');
        }
        
        // Médias Diárias
        async function loadMediasDiarias() {
            const estacaoId = document.getElementById('medias-estacao').value;
            const inicio = document.getElementById('medias-inicio').value;
            const fim = document.getElementById('medias-fim').value;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('*').eq('estacao_id', estacaoId)
                .gte('coletado_em', `${inicio}T00:00:00`)
                .lte('coletado_em', `${fim}T23:59:59`)
                .order('coletado_em', { ascending: true });
            
            if (!data) return;
            
            // Group by day
            const daily = {};
            data.forEach(d => {
                const day = d.coletado_em.split('T')[0];
                if (!daily[day]) daily[day] = { temps: [], humidity: [], wind: [], precip: 0, pressure: [] };
                if (d.temperatura) daily[day].temps.push(d.temperatura);
                if (d.umidade) daily[day].humidity.push(d.umidade);
                if (d.velocidade_vento) daily[day].wind.push(d.velocidade_vento);
                if (d.total_precipitacao) daily[day].precip = Math.max(daily[day].precip, d.total_precipitacao);
                if (d.pressao_barometrica) daily[day].pressure.push(d.pressao_barometrica);
            });
            
            const tbody = document.querySelector('#medias-table tbody');
            tbody.innerHTML = Object.entries(daily).map(([day, d]) => {
                const avg = arr => arr.length ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(1) : '--';
                return `<tr>
                    <td>${new Date(day).toLocaleDateString('pt-BR')}</td>
                    <td class="temp-min">${d.temps.length ? Math.min(...d.temps).toFixed(1) : '--'} °C</td>
                    <td class="temp-max">${d.temps.length ? Math.max(...d.temps).toFixed(1) : '--'} °C</td>
                    <td class="temp-media">${avg(d.temps)} °C</td>
                    <td>${avg(d.humidity)}%</td>
                    <td>${avg(d.wind)} Km/h</td>
                    <td>${d.precip.toFixed(1)} mm</td>
                    <td>${avg(d.pressure)} mb</td>
                </tr>`;
            }).join('');
        }
        
        // Evolução Diária
        async function loadEvolucaoDiaria() {
            const estacaoId = document.getElementById('evolucao-estacao').value;
            const dia = document.getElementById('evolucao-dia').value;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('*').eq('estacao_id', estacaoId)
                .gte('coletado_em', `${dia}T00:00:00`)
                .lte('coletado_em', `${dia}T23:59:59`)
                .order('coletado_em', { ascending: true });
            
            if (!data || !data.length) return;
            
            // Stats
            const temps = data.filter(d => d.temperatura).map(d => d.temperatura);
            const statsHtml = `
                <div class="stat-box"><div class="stat-box-label">Mínima</div><div class="stat-box-value" style="color: var(--info)">${Math.min(...temps).toFixed(1)}°C</div></div>
                <div class="stat-box"><div class="stat-box-label">Média</div><div class="stat-box-value" style="color: var(--warning)">${(temps.reduce((a,b)=>a+b,0)/temps.length).toFixed(1)}°C</div></div>
                <div class="stat-box"><div class="stat-box-label">Máxima</div><div class="stat-box-value" style="color: var(--danger)">${Math.max(...temps).toFixed(1)}°C</div></div>
                <div class="stat-box"><div class="stat-box-label">Umidade Média</div><div class="stat-box-value">${(data.filter(d=>d.umidade).reduce((a,b)=>a+b.umidade,0)/data.filter(d=>d.umidade).length).toFixed(0)}%</div></div>
            `;
            document.getElementById('evolucao-stats').innerHTML = statsHtml;
            
            // Chart
            if (charts.evolucao) charts.evolucao.destroy();
            const ctx = document.getElementById('evolucao-chart').getContext('2d');
            charts.evolucao = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.coletado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})),
                    datasets: [
                        { label: 'Temperatura', data: data.map(d => d.temperatura), borderColor: '#f59e0b', tension: 0.4, yAxisID: 'y' },
                        { label: 'Umidade', data: data.map(d => d.umidade), borderColor: '#3b82f6', tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { position: 'left', title: { display: true, text: 'Temp (°C)', color: '#94a3b8' }, ticks: { color: '#94a3b8' } },
                        y1: { position: 'right', title: { display: true, text: 'Umidade (%)', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
        
        // Vento
        async function loadVento() {
            const estacaoId = document.getElementById('vento-estacao').value;
            const dia = document.getElementById('vento-dia').value;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('coletado_em, velocidade_vento, rajada_vento').eq('estacao_id', estacaoId)
                .gte('coletado_em', `${dia}T00:00:00`).lte('coletado_em', `${dia}T23:59:59`)
                .order('coletado_em', { ascending: true });
            
            if (!data) return;
            
            if (charts.vento) charts.vento.destroy();
            const ctx = document.getElementById('vento-chart').getContext('2d');
            charts.vento = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.coletado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})),
                    datasets: [
                        { label: 'Velocidade Média', data: data.map(d => d.velocidade_vento), borderColor: '#3b82f6', tension: 0.4 },
                        { label: 'Rajada Máxima', data: data.map(d => d.rajada_vento), borderColor: '#ef4444', tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' } },
                        y: { title: { display: true, text: 'Km/h', color: '#94a3b8' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }
        
        // Solar
        async function loadSolar() {
            const estacaoId = document.getElementById('solar-estacao').value;
            const dia = document.getElementById('solar-dia').value;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('coletado_em, radiacao_solar, indice_uv').eq('estacao_id', estacaoId)
                .gte('coletado_em', `${dia}T00:00:00`).lte('coletado_em', `${dia}T23:59:59`)
                .order('coletado_em', { ascending: true });
            
            if (!data) return;
            
            if (charts.solar) charts.solar.destroy();
            const ctx = document.getElementById('solar-chart').getContext('2d');
            charts.solar = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => new Date(d.coletado_em).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})),
                    datasets: [
                        { label: 'Radiação Solar', data: data.map(d => d.radiacao_solar), borderColor: '#f59e0b', tension: 0.4, yAxisID: 'y' },
                        { label: 'Índice UV', data: data.map(d => d.indice_uv), borderColor: '#8b5cf6', tension: 0.4, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#94a3b8' } } },
                    scales: {
                        x: { ticks: { color: '#94a3b8' } },
                        y: { position: 'left', title: { display: true, text: 'W/m²', color: '#94a3b8' }, ticks: { color: '#94a3b8' } },
                        y1: { position: 'right', title: { display: true, text: 'UV', color: '#94a3b8' }, ticks: { color: '#94a3b8' }, grid: { drawOnChartArea: false } }
                    }
                }
            });
        }
        
        // Dados brutos
        async function loadDados() {
            const estacaoId = document.getElementById('dados-estacao').value;
            const inicio = document.getElementById('dados-inicio').value;
            const fim = document.getElementById('dados-fim').value;
            
            const { data } = await supabaseClient.from('estacao_dados')
                .select('*').eq('estacao_id', estacaoId)
                .gte('coletado_em', `${inicio}T00:00:00`).lte('coletado_em', `${fim}T23:59:59`)
                .order('coletado_em', { ascending: false }).limit(500);
            
            if (!data) return;
            
            const tbody = document.querySelector('#dados-table tbody');
            tbody.innerHTML = data.map(d => `<tr>
                <td>${new Date(d.coletado_em).toLocaleString('pt-BR')}</td>
                <td>${d.temperatura?.toFixed(1) || '--'} °C</td>
                <td>${d.umidade?.toFixed(0) || '--'}%</td>
                <td>Dir: ${d.direcao_vento || '--'}° | Vel: ${d.velocidade_vento?.toFixed(1) || '--'} Km/h | Raj: ${d.rajada_vento?.toFixed(1) || '--'} Km/h</td>
                <td>Acum: ${d.total_precipitacao?.toFixed(1) || '0'} mm | Taxa: ${d.taxa_precipitacao?.toFixed(1) || '0'} mm/h</td>
                <td>Rad: ${d.radiacao_solar?.toFixed(0) || '--'} | UV: ${d.indice_uv?.toFixed(1) || '--'}</td>
                <td>${d.pressao_barometrica?.toFixed(1) || '--'} mb</td>
            </tr>`).join('');
        }
        
        // Export CSV
        function exportCSV(type) {
            let table;
            if (type === 'medias') table = document.getElementById('medias-table');
            else if (type === 'dados') table = document.getElementById('dados-table');
            if (!table) return;
            
            let csv = [];
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cols = row.querySelectorAll('th, td');
                const rowData = [];
                cols.forEach(col => rowData.push('"' + col.textContent.replace(/"/g, '""') + '"'));
                csv.push(rowData.join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `aguaten_${type}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        function logout() { supabaseClient.auth.signOut().then(() => window.location.href = 'index.html'); }
        function showToast(msg, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = msg;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
